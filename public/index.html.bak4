<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,viewport-fit=cover"/>
<meta name="theme-color" content="#0a0a0c"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<title>Diskold</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#0a0a0c;--bg2:#111114;--bg3:#18181d;--bg4:#202027;
  --line:#2a2a35;--ice:#a8d8ff;--icedim:#3a6080;--cold:#4fc3f7;
  --red:#ff4466;--green:#39ffc0;--gold:#ffd166;--purple:#c084fc;
  --blue:#60a5fa;--text:#e8eaf0;--muted:#6b6b80;--r:8px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;width:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;-webkit-font-smoothing:antialiased;}
::-webkit-scrollbar{width:4px;} ::-webkit-scrollbar-thumb{background:var(--line);border-radius:4px;}

/* â•â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#auth-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);z-index:300;padding:20px;}
.auth-card{width:100%;max-width:360px;background:var(--bg2);border:1px solid var(--line);border-radius:16px;padding:28px 24px;display:flex;flex-direction:column;gap:12px;}
.auth-logo{text-align:center;font-family:'Bebas Neue',sans-serif;font-size:2.6rem;letter-spacing:6px;color:var(--ice);}
.auth-sub{text-align:center;font-size:.68rem;color:var(--muted);letter-spacing:2px;font-family:'Space Mono',monospace;}
.auth-tabs{display:flex;background:var(--bg3);border-radius:var(--r);padding:3px;gap:2px;}
.auth-tab{flex:1;padding:7px;border-radius:6px;border:none;background:none;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;cursor:pointer;transition:all .2s;}
.auth-tab.active{background:var(--bg4);color:var(--text);}
.auth-field{display:flex;flex-direction:column;gap:4px;}
.auth-label{font-size:.65rem;color:var(--muted);font-family:'Space Mono',monospace;letter-spacing:1px;text-transform:uppercase;}
.auth-input{background:var(--bg3);border:1px solid var(--line);border-radius:var(--r);padding:10px 13px;font-family:'DM Sans',sans-serif;font-size:.9rem;color:var(--text);outline:none;width:100%;}
.auth-input:focus{border-color:var(--icedim);}
.auth-input::placeholder{color:var(--muted);}
.btn-auth{background:var(--ice);border:none;border-radius:var(--r);padding:12px;font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:3px;color:#0a0a0c;cursor:pointer;}
.btn-auth:hover{opacity:.85;}
.auth-err{font-size:.75rem;color:var(--red);display:none;font-family:'Space Mono',monospace;padding:6px 10px;background:rgba(255,68,102,.07);border-radius:6px;border:1px solid rgba(255,68,102,.15);}
.auth-err.show{display:block;}

/* â•â•â• APP LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app{display:none;height:100dvh;width:100%;position:fixed;inset:0;flex-direction:row;}

/* â•â•â• SERVER SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.srv-bar{width:56px;background:#070709;display:flex;flex-direction:column;align-items:center;padding:6px 0;gap:2px;flex-shrink:0;overflow-y:auto;overflow-x:hidden;}
.srv-btn{width:40px;height:40px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;flex-shrink:0;overflow:hidden;border:none;color:var(--muted);font-size:.95rem;position:relative;}
.srv-btn:hover,.srv-btn.active{border-radius:14px;background:var(--ice);color:#0a0a0c;}
.srv-btn.active::before{content:'';position:absolute;left:-4px;top:50%;transform:translateY(-50%);width:4px;height:20px;background:var(--ice);border-radius:0 4px 4px 0;}
.srv-btn img{width:100%;height:100%;object-fit:cover;}
.srv-btn.dm{background:var(--bg3);color:var(--green);}
.srv-btn.dm:hover,.srv-btn.dm.active{background:var(--green);color:#0a0a0c;border-radius:14px;}
.srv-btn.add{color:var(--green);}
.srv-btn.add:hover{background:var(--green);color:#0a0a0c;border-radius:14px;}
.srv-div{width:32px;height:1px;background:var(--line);margin:3px 0;flex-shrink:0;}
.srv-badge{position:absolute;top:-3px;right:-3px;background:var(--red);color:#fff;border-radius:10px;font-size:.55rem;padding:1px 4px;font-weight:700;border:2px solid #070709;min-width:16px;text-align:center;}

/* â•â•â• CHANNEL SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ch-bar{width:220px;background:var(--bg2);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;}
.ch-bar-head{padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;min-height:46px;}
.ch-bar-name{font-weight:700;font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
.ch-bar-body{flex:1;overflow-y:auto;padding:6px 0;}
.ch-sec{padding:12px 10px 3px;font-size:.65rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;font-family:'Space Mono',monospace;display:flex;align-items:center;justify-content:space-between;}
.ch-sec button{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.95rem;line-height:1;}
.ch-sec button:hover{color:var(--text);}
.ch-item{padding:4px 6px 4px 10px;border-radius:6px;margin:0 5px;cursor:pointer;display:flex;align-items:center;gap:6px;color:var(--muted);font-size:.85rem;transition:all .15s;min-height:30px;}
.ch-item:hover{background:var(--bg3);color:var(--text);}
.ch-item.active{background:var(--bg4);color:var(--text);}
.ch-item .sym{font-size:.75rem;opacity:.7;flex-shrink:0;}
.ch-item .nm{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.ch-item .unread{background:var(--red);color:#fff;border-radius:10px;font-size:.6rem;padding:1px 4px;font-weight:700;margin-left:auto;}
.v-item{padding:4px 6px 4px 10px;margin:0 5px;border-radius:6px;cursor:pointer;color:var(--muted);font-size:.85rem;transition:all .15s;}
.v-item:hover{background:var(--bg3);color:var(--text);}
.v-item.active{color:var(--green);}
.v-head{display:flex;align-items:center;gap:6px;}
.v-users{padding:2px 0 2px 18px;display:flex;flex-direction:column;gap:1px;}
.v-user{display:flex;align-items:center;gap:5px;font-size:.75rem;color:var(--muted);padding:1px 0;}
.ch-bar-foot{padding:7px;background:#0c0c10;border-top:1px solid var(--line);display:flex;align-items:center;gap:7px;}
.foot-av{width:30px;height:30px;border-radius:50%;flex-shrink:0;cursor:pointer;overflow:hidden;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;position:relative;}
.foot-av img{width:100%;height:100%;object-fit:cover;}
.sdot{position:absolute;bottom:0;right:0;width:9px;height:9px;border-radius:50%;border:2px solid #0c0c10;}
.s-online{background:var(--green);} .s-away{background:var(--gold);} .s-dnd{background:var(--red);} .s-offline{background:var(--muted);}
.foot-info{flex:1;overflow:hidden;}
.foot-name{font-size:.8rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.foot-cs{font-size:.65rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.foot-btn{background:none;border:none;color:var(--muted);cursor:pointer;padding:3px;border-radius:4px;font-size:.85rem;}
.foot-btn:hover{color:var(--text);}
.call-bar{background:#0a1e0d;border-top:1px solid rgba(57,255,192,.2);padding:7px 10px;display:none;align-items:center;gap:7px;flex-shrink:0;}
.call-bar.on{display:flex;}
.call-info{flex:1;}
.call-ch{color:var(--green);font-weight:600;font-size:.78rem;}
.call-st{color:var(--muted);font-size:.65rem;}
.call-btns{display:flex;gap:4px;}
.call-btn{background:rgba(255,255,255,.05);border:none;border-radius:5px;color:var(--text);cursor:pointer;padding:4px 7px;font-size:.78rem;transition:all .2s;}
.call-btn:hover{background:rgba(255,255,255,.1);}
.call-btn.muted,.call-btn.danger{background:rgba(255,68,102,.15);color:var(--red);}

/* â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}
.topbar{height:46px;border-bottom:1px solid var(--line);display:flex;align-items:center;padding:0 12px;gap:8px;flex-shrink:0;}
.topbar-ch{font-weight:700;font-size:.88rem;display:flex;align-items:center;gap:5px;}
.topbar-ch .sym{color:var(--muted);font-size:.8rem;}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:4px;}
.tb-btn{background:none;border:none;color:var(--muted);cursor:pointer;padding:4px 6px;border-radius:6px;font-size:.82rem;transition:all .2s;display:flex;align-items:center;gap:3px;white-space:nowrap;}
.tb-btn:hover{background:var(--bg3);color:var(--text);}
.tb-btn.live{background:rgba(192,132,252,.1);border:1px solid var(--purple);color:var(--purple);}

/* â•â•â• MESSAGES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.msgs{flex:1;overflow-y:auto;padding:10px 0;}
.msg-grp{padding:2px 12px;display:flex;gap:10px;position:relative;}
.msg-grp:hover{background:rgba(255,255,255,.015);}
.msg-grp:hover .msg-acts{opacity:1;}
.av{width:34px;height:34px;border-radius:50%;flex-shrink:0;margin-top:2px;overflow:hidden;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:.78rem;font-weight:700;}
.av img,.av-sm img{width:100%;height:100%;object-fit:cover;}
.av.bot-av{background:#2a2000;color:var(--gold);}
.msg-body{flex:1;min-width:0;}
.msg-head{display:flex;align-items:baseline;gap:6px;margin-bottom:1px;}
.msg-name{font-weight:600;font-size:.85rem;cursor:pointer;}
.msg-name:hover{text-decoration:underline;}
.msg-name.bot{color:var(--gold);}
.msg-time{font-size:.65rem;color:var(--muted);font-family:'Space Mono',monospace;}
.msg-ed{font-size:.62rem;color:var(--muted);font-style:italic;}
.msg-txt{font-size:.88rem;line-height:1.5;word-break:break-word;white-space:pre-wrap;}
.msg-txt.del{color:var(--muted);font-style:italic;}
.msg-reply{background:var(--bg3);border-left:3px solid var(--muted);border-radius:0 5px 5px 0;padding:3px 7px;margin-bottom:3px;font-size:.75rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.reactions{display:flex;flex-wrap:wrap;gap:3px;margin-top:3px;}
.rxn{display:flex;align-items:center;gap:2px;background:var(--bg3);border:1px solid var(--line);border-radius:10px;padding:1px 6px;cursor:pointer;font-size:.78rem;transition:all .2s;}
.rxn:hover,.rxn.mine{background:rgba(96,165,250,.1);border-color:var(--blue);}
.rxn span{font-size:.68rem;color:var(--muted);font-family:'Space Mono',monospace;}
/* Attachments */
.attach-img{max-width:300px;max-height:220px;border-radius:8px;margin-top:5px;cursor:pointer;display:block;}
.attach-file{display:inline-flex;align-items:center;gap:7px;background:var(--bg3);border:1px solid var(--line);border-radius:8px;padding:7px 10px;margin-top:5px;text-decoration:none;color:var(--text);font-size:.8rem;}
.attach-file:hover{border-color:var(--icedim);}
.attach-file .ficon{font-size:1.2rem;}
.attach-file .finfo{display:flex;flex-direction:column;}
.attach-file .fname{font-weight:600;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.attach-file .fsize{font-size:.65rem;color:var(--muted);}
.msg-acts{position:absolute;right:12px;top:-12px;background:var(--bg3);border:1px solid var(--line);border-radius:7px;display:flex;gap:1px;padding:2px;opacity:0;transition:opacity .15s;z-index:10;}
.act-btn{background:none;border:none;color:var(--muted);cursor:pointer;padding:3px 5px;border-radius:4px;font-size:.78rem;transition:all .15s;}
.act-btn:hover{background:var(--bg4);color:var(--text);}
.act-btn.danger:hover{color:var(--red);}
.msg-sys{padding:3px 12px;text-align:center;font-size:.72rem;color:var(--muted);}

/* â•â•â• TYPING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.typing{height:18px;padding:0 12px;font-size:.72rem;color:var(--muted);font-style:italic;display:flex;align-items:center;gap:5px;flex-shrink:0;}
.tdots{display:flex;gap:2px;}
.tdots span{width:3px;height:3px;border-radius:50%;background:var(--muted);animation:td 1.2s infinite;}
.tdots span:nth-child(2){animation-delay:.2s;} .tdots span:nth-child(3){animation-delay:.4s;}
@keyframes td{0%,80%,100%{opacity:.3;transform:scale(.8);}40%{opacity:1;transform:scale(1);}}

/* â•â•â• INPUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.inp-area{padding:0 12px 10px;flex-shrink:0;}
.reply-bar{background:var(--bg3);border-radius:7px 7px 0 0;padding:5px 10px;display:none;align-items:center;gap:7px;border-bottom:1px solid var(--line);}
.reply-bar.on{display:flex;}
.reply-txt{flex:1;font-size:.75rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.reply-x{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.9rem;}
.inp-wrap{background:var(--bg3);border-radius:7px;display:flex;align-items:flex-end;gap:6px;padding:5px 10px;border:1px solid var(--line);transition:border-color .2s;}
.inp-wrap:focus-within{border-color:var(--icedim);}
.inp-btn{background:none;border:none;color:var(--muted);cursor:pointer;padding:3px;border-radius:4px;font-size:.9rem;flex-shrink:0;line-height:1;}
.inp-btn:hover{color:var(--text);}
.msg-inp{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:'DM Sans',sans-serif;font-size:.88rem;resize:none;min-height:22px;max-height:110px;overflow-y:auto;line-height:1.4;align-self:center;}
.msg-inp::placeholder{color:var(--muted);}
.send-btn{background:var(--ice);border:none;border-radius:5px;color:#0a0a0c;cursor:pointer;padding:3px 8px;font-size:.8rem;font-weight:700;flex-shrink:0;line-height:22px;}
.send-btn:hover{opacity:.85;}
.cmd-hint{font-size:.62rem;color:var(--muted);padding:2px 0 0 2px;}

/* â•â•â• EMOJI PICKER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.emoji-pk{position:absolute;bottom:68px;left:12px;background:var(--bg3);border:1px solid var(--line);border-radius:10px;padding:8px;display:none;flex-wrap:wrap;gap:3px;width:220px;z-index:50;box-shadow:0 8px 24px rgba(0,0,0,.5);}
.emoji-pk.open{display:flex;}
.epk-btn{background:none;border:none;cursor:pointer;font-size:1.25rem;padding:3px;border-radius:4px;}
.epk-btn:hover{background:var(--bg4);}

/* â•â•â• MUSIC BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.music-bar{background:var(--bg2);border-top:1px solid var(--line);padding:7px 12px;display:none;align-items:center;gap:8px;flex-shrink:0;}
.music-bar.on{display:flex;}
.m-thumb{width:34px;height:34px;border-radius:5px;object-fit:cover;flex-shrink:0;}
.m-info{flex:1;min-width:0;}
.m-title{font-size:.8rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.m-req{font-size:.65rem;color:var(--muted);}
.m-btns{display:flex;gap:4px;align-items:center;}
.m-btn{background:none;border:none;color:var(--muted);cursor:pointer;padding:3px;border-radius:4px;font-size:.85rem;}
.m-btn:hover{color:var(--text);}
.vol-sl{width:55px;accent-color:var(--ice);}

/* â•â•â• WATCH PARTY â€” TWITCH LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#watch-view{display:none;flex:1;flex-direction:column;overflow:hidden;}
#watch-view.on{display:flex;}
/* Video arriba (40% altura en mÃ³vil, 60% en desktop) */
.wp-video{background:#000;flex-shrink:0;position:relative;overflow:hidden;}
.wp-video iframe,.wp-video>div{position:absolute;inset:0;width:100%;height:100%;border:none;}
.wp-toolbar{display:flex;align-items:center;gap:6px;padding:6px 10px;background:var(--bg2);border-bottom:1px solid var(--line);flex-shrink:0;}
.wp-title{flex:1;font-size:.8rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.wp-btn{background:var(--bg3);border:1px solid var(--line);border-radius:5px;color:var(--text);cursor:pointer;padding:4px 10px;font-size:.75rem;font-family:'Space Mono',monospace;transition:all .2s;}
.wp-btn:hover{border-color:var(--purple);color:var(--purple);}
.wp-btn.red:hover{border-color:var(--red);color:var(--red);}
/* Chat debajo del video en WP */
.wp-chat{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0;}

/* â•â•â• MEMBER PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.member-panel{width:220px;background:var(--bg2);border-left:1px solid var(--line);display:none;flex-direction:column;overflow:hidden;flex-shrink:0;}
.member-panel.open{display:flex;}
.mp-head{padding:12px;border-bottom:1px solid var(--line);font-size:.75rem;font-family:'Space Mono',monospace;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}
.mp-body{flex:1;overflow-y:auto;padding:8px 0;}
.mp-sec{padding:8px 12px 3px;font-size:.63rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;font-family:'Space Mono',monospace;}
.mp-user{display:flex;align-items:center;gap:8px;padding:5px 10px;border-radius:6px;margin:0 4px;cursor:pointer;transition:background .15s;}
.mp-user:hover{background:var(--bg3);}
.mp-av{width:30px;height:30px;border-radius:50%;background:var(--bg3);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:700;overflow:hidden;position:relative;}
.mp-av img{width:100%;height:100%;object-fit:cover;}
.mp-info{flex:1;min-width:0;}
.mp-name{font-size:.82rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.mp-role{font-size:.62rem;color:var(--muted);}
.mp-sdot{position:absolute;bottom:0;right:0;width:9px;height:9px;border-radius:50%;border:2px solid var(--bg2);}

/* â•â•â• DM / FRIENDS PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dm-panel{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.dm-panel-head{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px;flex-shrink:0;font-weight:700;font-size:.88rem;}
.dm-panel-search{background:var(--bg3);border:1px solid var(--line);border-radius:var(--r);padding:7px 10px;font-family:'DM Sans',sans-serif;font-size:.82rem;color:var(--text);outline:none;width:100%;}
.dm-panel-search::placeholder{color:var(--muted);}
.dm-panel-search:focus{border-color:var(--icedim);}
.dm-list-item{display:flex;align-items:center;gap:8px;padding:6px 10px;cursor:pointer;border-radius:6px;margin:1px 5px;transition:background .15s;}
.dm-list-item:hover{background:var(--bg3);}
.dm-list-item .av-sm{width:30px;height:30px;border-radius:50%;background:var(--bg3);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:700;overflow:hidden;}
.dm-list-item .dm-name{font-size:.82rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.dm-list-item .dm-preview{font-size:.7rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.dm-tabs{display:flex;border-bottom:1px solid var(--line);flex-shrink:0;}
.dm-tab{flex:1;padding:9px 0;background:none;border:none;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;position:relative;}
.dm-tab.active{color:var(--text);border-bottom-color:var(--ice);}
.dm-tab .badge{position:absolute;top:5px;right:16px;background:var(--red);color:#fff;border-radius:10px;font-size:.6rem;padding:0 4px;font-weight:700;}
.friend-item{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:6px;margin:1px 5px;}
.friend-item .av-sm{width:30px;height:30px;border-radius:50%;background:var(--bg3);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:700;overflow:hidden;}
.friend-item .fi-info{flex:1;min-width:0;}
.friend-item .fi-name{font-size:.82rem;font-weight:600;}
.friend-item .fi-status{font-size:.68rem;color:var(--muted);}
.friend-item .fi-btns{display:flex;gap:4px;}
.fi-btn{background:var(--bg3);border:1px solid var(--line);border-radius:5px;color:var(--muted);cursor:pointer;padding:3px 7px;font-size:.72rem;transition:all .2s;}
.fi-btn:hover{color:var(--text);border-color:var(--icedim);}
.fi-btn.ok:hover{border-color:var(--green);color:var(--green);}
.fi-btn.no:hover{border-color:var(--red);color:var(--red);}
.add-friend-wrap{padding:10px 10px 5px;}

/* â•â•â• DM CONVERSATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#dm-view{display:none;flex:1;flex-direction:column;overflow:hidden;}
#dm-view.on{display:flex;}
.dm-head{height:46px;border-bottom:1px solid var(--line);display:flex;align-items:center;padding:0 12px;gap:8px;flex-shrink:0;}
.dm-av{width:26px;height:26px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:.68rem;font-weight:700;overflow:hidden;flex-shrink:0;}

/* â•â•â• WELCOME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.welcome{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;color:var(--muted);text-align:center;padding:40px;}
.welcome h2{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:4px;color:var(--ice);}
.welcome p{font-size:.82rem;max-width:280px;line-height:1.6;}

/* â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:200;padding:16px;backdrop-filter:blur(4px);}
.overlay.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--line);border-radius:14px;padding:24px 20px;width:100%;max-width:400px;display:flex;flex-direction:column;gap:12px;box-shadow:0 20px 60px rgba(0,0,0,.6);}
.modal-title{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:3px;}
.modal-sub{font-size:.75rem;color:var(--muted);line-height:1.5;}
.modal-inp{background:var(--bg3);border:1px solid var(--line);border-radius:var(--r);padding:10px 13px;font-family:'DM Sans',sans-serif;font-size:.88rem;color:var(--text);outline:none;width:100%;}
.modal-inp:focus{border-color:var(--icedim);}
.modal-err{font-size:.72rem;color:var(--red);display:none;font-family:'Space Mono',monospace;}
.modal-err.show{display:block;}
.modal-btns{display:flex;gap:7px;justify-content:flex-end;}
.btn-cancel{background:none;border:1px solid var(--line);border-radius:var(--r);padding:7px 14px;color:var(--muted);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.85rem;}
.btn-cancel:hover{color:var(--text);}
.btn-ok{background:var(--ice);border:none;border-radius:var(--r);padding:7px 16px;color:#0a0a0c;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:700;}
.btn-ok:hover{opacity:.85;}
.btn-danger{background:var(--red);border:none;border-radius:var(--r);padding:7px 14px;color:#fff;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:700;}

/* â•â•â• INVITE SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#invite-screen{position:fixed;inset:0;background:var(--bg);display:none;align-items:center;justify-content:center;z-index:250;padding:20px;}
.inv-card{background:var(--bg2);border:1px solid var(--line);border-radius:16px;padding:28px 24px;max-width:360px;width:100%;text-align:center;display:flex;flex-direction:column;align-items:center;gap:12px;}
.inv-icon{width:64px;height:64px;border-radius:18px;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:1.8rem;overflow:hidden;}

/* â•â•â• MOBILE TOPBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mob-top{display:none;height:46px;background:var(--bg2);border-bottom:1px solid var(--line);align-items:center;padding:0 10px;gap:8px;flex-shrink:0;}
.mob-menu{background:none;border:none;color:var(--text);cursor:pointer;font-size:1rem;padding:3px;}
.mob-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:90;}
.mob-overlay.open{display:block;}

/* â•â•â• IMAGE LIGHTBOX â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.lightbox{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:400;cursor:pointer;}
.lightbox.open{display:flex;}
.lightbox img{max-width:95vw;max-height:95vh;border-radius:8px;object-fit:contain;}

@media(max-width:768px){
  .srv-bar{position:fixed;left:0;top:0;bottom:0;z-index:101;width:56px;transform:translateX(-100%);transition:transform .25s;}
  .srv-bar.open{transform:translateX(0);}
  .ch-bar{position:fixed;left:56px;top:0;bottom:0;z-index:100;width:220px;transform:translateX(calc(-100% - 56px));transition:transform .25s;}
  .ch-bar.open{transform:translateX(0);}
  .mob-top{display:flex;}
  .topbar{display:none;}
  .member-panel{display:none!important;}
  #app{height:100dvh;}
  .wp-video{height:38vh!important;}
  /* En watch party, el chat del canal va debajo del video */
  #watch-view .wp-chat .msgs{flex:1;}
}

/* â•â•â• VIBE METER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.vibe-bar{height:3px;background:var(--line);flex-shrink:0;overflow:hidden;}
.vibe-fill{height:100%;background:linear-gradient(90deg,var(--ice),var(--purple));transition:width .8s ease;width:0%;}

/* â•â•â• PINS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pins-bar{background:rgba(168,216,255,.05);border-bottom:1px solid var(--line);padding:5px 12px;display:none;align-items:center;gap:8px;flex-shrink:0;cursor:pointer;}
.pins-bar.on{display:flex;}
.pins-bar:hover{background:rgba(168,216,255,.08);}
.pins-bar-txt{font-size:.72rem;color:var(--ice);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.pins-panel{position:absolute;top:46px;right:0;width:300px;max-height:350px;overflow-y:auto;background:var(--bg2);border:1px solid var(--line);border-radius:10px;z-index:50;box-shadow:0 8px 24px rgba(0,0,0,.5);padding:6px;}
.pin-item{padding:7px 8px;border-radius:6px;cursor:pointer;transition:background .15s;}
.pin-item:hover{background:var(--bg3);}
.pin-item-name{font-size:.7rem;font-weight:700;color:var(--ice);}
.pin-item-txt{font-size:.78rem;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

/* â•â•â• FOCUS BANNER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.focus-banner{background:linear-gradient(135deg,rgba(96,165,250,.1),rgba(192,132,252,.1));border-bottom:1px solid rgba(192,132,252,.3);padding:6px 12px;display:none;align-items:center;gap:8px;flex-shrink:0;}
.focus-banner.on{display:flex;}
.focus-label{font-size:.8rem;font-weight:700;color:var(--purple);}
.focus-timer{font-family:'Space Mono',monospace;font-size:.78rem;color:var(--text);margin-left:auto;}
.focus-stop{background:none;border:1px solid rgba(192,132,252,.3);border-radius:4px;color:var(--purple);cursor:pointer;padding:2px 7px;font-size:.7rem;}

/* â•â•â• CANVAS / DRAW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.canvas-wrap{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:200;display:none;flex-direction:column;align-items:center;justify-content:center;gap:10px;}
.canvas-wrap.open{display:flex;}
.canvas-toolbar{display:flex;align-items:center;gap:8px;background:var(--bg2);border:1px solid var(--line);border-radius:10px;padding:8px 12px;}
.cv-btn{background:var(--bg3);border:1px solid var(--line);border-radius:5px;color:var(--text);cursor:pointer;padding:4px 10px;font-size:.78rem;}
.cv-btn:hover{border-color:var(--ice);}
.cv-btn.active{border-color:var(--purple);color:var(--purple);}
.cv-color{width:24px;height:24px;border-radius:50%;cursor:pointer;border:2px solid transparent;flex-shrink:0;}
.cv-color.active{border-color:var(--text);}
canvas#draw-canvas{background:#fff;border-radius:8px;cursor:crosshair;touch-action:none;max-width:95vw;max-height:60vh;}

/* â•â•â• POLL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.poll-card{background:var(--bg3);border:1px solid var(--line);border-radius:10px;padding:12px;margin-top:5px;}
.poll-q{font-weight:700;font-size:.88rem;margin-bottom:8px;}
.poll-opt{display:flex;align-items:center;gap:8px;margin-bottom:5px;cursor:pointer;border-radius:6px;padding:5px 7px;transition:background .15s;}
.poll-opt:hover{background:var(--bg4);}
.poll-opt.voted{background:rgba(96,165,250,.1);}
.poll-bar-wrap{flex:1;background:var(--bg4);border-radius:10px;height:6px;overflow:hidden;}
.poll-bar{height:100%;background:var(--blue);border-radius:10px;transition:width .4s ease;}
.poll-pct{font-size:.68rem;color:var(--muted);font-family:'Space Mono',monospace;width:34px;text-align:right;}
.poll-opt-txt{font-size:.82rem;min-width:60px;}

/* â•â•â• ALARM RING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.alarm-toast{position:fixed;top:16px;left:50%;transform:translateX(-50%);background:var(--bg2);border:2px solid var(--gold);border-radius:12px;padding:12px 20px;z-index:500;display:none;flex-direction:column;align-items:center;gap:4px;box-shadow:0 8px 32px rgba(0,0,0,.6);animation:alarm-shake .5s ease;}
.alarm-toast.on{display:flex;}
@keyframes alarm-shake{0%,100%{transform:translateX(-50%) rotate(0deg);}20%{transform:translateX(-50%) rotate(-3deg);}40%{transform:translateX(-50%) rotate(3deg);}60%{transform:translateX(-50%) rotate(-2deg);}80%{transform:translateX(-50%) rotate(2deg);}}
.alarm-title{font-family:'Bebas Neue',sans-serif;letter-spacing:3px;color:var(--gold);font-size:1.3rem;}

/* â•â•â• DICE ROLL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dice-anim{display:inline-block;animation:dice-spin .6s ease-out;}
@keyframes dice-spin{0%{transform:rotate(0deg) scale(.5);}60%{transform:rotate(380deg) scale(1.2);}100%{transform:rotate(360deg) scale(1);}}

/* â•â•â• CONTEXT MENU â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#ctx-menu{position:fixed;background:var(--bg2);border:1px solid var(--line);border-radius:8px;padding:4px;z-index:300;display:none;min-width:150px;box-shadow:0 8px 24px rgba(0,0,0,.5);}
.ctx-item{padding:6px 10px;border-radius:5px;cursor:pointer;font-size:.82rem;display:flex;align-items:center;gap:7px;}
.ctx-item:hover{background:var(--bg3);}
.ctx-item.danger:hover{color:var(--red);}
</style>
</head>
<body>

<!-- â•â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">DISKOLD</div>
    <div class="auth-sub">by Kold</div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="showTab('login')">Iniciar sesiÃ³n</button>
      <button class="auth-tab"        onclick="showTab('register')">Registrarse</button>
    </div>
    <div id="tab-login" style="display:flex;flex-direction:column;gap:10px;">
      <div class="auth-field"><label class="auth-label">Usuario</label>
        <input class="auth-input" id="l-u" placeholder="tu_usuario" autocomplete="username" autocorrect="off" autocapitalize="off"/></div>
      <div class="auth-field"><label class="auth-label">ContraseÃ±a</label>
        <input class="auth-input" id="l-p" type="password" placeholder="â€¢â€¢â€¢â€¢" autocomplete="current-password"/></div>
      <div class="auth-err" id="l-err"></div>
      <button class="btn-auth" onclick="doLogin()">ENTRAR</button>
    </div>
    <div id="tab-register" style="display:none;flex-direction:column;gap:10px;">
      <div class="auth-field"><label class="auth-label">Usuario</label>
        <input class="auth-input" id="r-u" placeholder="tu_usuario" autocomplete="username" autocorrect="off" autocapitalize="off"/></div>
      <div class="auth-field"><label class="auth-label">ContraseÃ±a</label>
        <input class="auth-input" id="r-p" type="password" placeholder="mÃ­nimo 4 caracteres" autocomplete="new-password"/></div>
      <div class="auth-err" id="r-err"></div>
      <button class="btn-auth" onclick="doRegister()">CREAR CUENTA</button>
    </div>
  </div>
</div>

<!-- â•â•â• INVITE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="invite-screen">
  <div class="inv-card">
    <div class="inv-icon" id="inv-icon">ğŸ”—</div>
    <div style="font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:3px;" id="inv-name">...</div>
    <div style="font-size:.78rem;color:var(--muted);" id="inv-members"></div>
    <div class="auth-err" id="inv-err"></div>
    <button class="btn-auth" onclick="acceptInvite()">UNIRME</button>
    <button class="btn-cancel" onclick="document.getElementById('invite-screen').style.display='none';document.getElementById('auth-screen').style.display='flex'">Tengo cuenta â†’ Login</button>
  </div>
</div>

<!-- â•â•â• APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">

  <!-- Server bar -->
  <div class="srv-bar" id="srv-bar">
    <div class="srv-btn dm" id="dm-btn" onclick="openDMPanel()" title="DMs & Amigos">ğŸ’¬
      <div class="srv-badge" id="friend-req-badge" style="display:none;">0</div>
    </div>
    <div class="srv-div"></div>
    <div id="srv-list"></div>
    <div class="srv-div"></div>
    <div class="srv-btn add" onclick="openModal('create-server')" title="Crear servidor">ï¼‹</div>
  </div>

  <!-- Channel bar -->
  <div class="ch-bar" id="ch-bar">
    <div class="ch-bar-head">
      <span class="ch-bar-name" id="srv-name-label">Diskold</span>
      <button class="foot-btn" onclick="openServerSettings()" title="Ajustes">âš™ï¸</button>
    </div>
    <div class="ch-bar-body" id="ch-body">
      <div style="padding:16px 10px;font-size:.78rem;color:var(--muted);">Elige un servidor</div>
    </div>
    <div class="call-bar" id="call-bar">
      <div class="call-info">
        <div class="call-ch" id="call-ch-name">Voz</div>
        <div class="call-st">ğŸŸ¢ Conectado</div>
      </div>
      <div class="call-btns">
        <button class="call-btn" id="mic-btn" onclick="toggleMic()">ğŸ¤</button>
        <button class="call-btn danger" onclick="leaveVoice()">ğŸ“µ</button>
      </div>
    </div>
    <div class="ch-bar-foot">
      <div class="foot-av" id="my-av" onclick="openSettings()">
        <span id="my-av-ini">?</span>
        <div class="sdot s-online" id="my-sdot"></div>
      </div>
      <div class="foot-info">
        <div class="foot-name" id="my-name-label">â€”</div>
        <div class="foot-cs"  id="my-cs-label">online</div>
      </div>
      <button class="foot-btn" onclick="openSettings()">âš™ï¸</button>
    </div>
  </div>

  <!-- Main area -->
  <div class="main" id="main">

    <!-- Mobile topbar -->
    <div class="mob-top">
      <button class="mob-menu" onclick="toggleDrawer()">â˜°</button>
      <span style="font-weight:700;font-size:.85rem;" id="mob-title">Diskold</span>
      <div style="margin-left:auto;display:flex;gap:4px;">
        <button class="tb-btn" onclick="openWatchModal()" id="mob-wp-btn">ğŸ¬</button>
        <button class="tb-btn" onclick="toggleMemberPanel()">ğŸ‘¥</button>
      </div>
    </div>
    <div class="mob-overlay" id="mob-overlay" onclick="closeDrawer()"></div>

    <!-- Views -->
    <div class="welcome" id="v-welcome">
      <h2>DISKOLD</h2>
      <p>Crea un servidor o Ãºnete a uno con un enlace de invitaciÃ³n.</p>
      <button class="btn-ok" style="margin-top:8px;" onclick="openModal('create-server')">Crear servidor</button>
    </div>

    <!-- DM Panel (friends & conversations) -->
    <div id="v-dm-panel" style="display:none;flex:1;flex-direction:column;overflow:hidden;">
      <div class="dm-panel-head">ğŸ’¬ Mensajes & Amigos</div>
      <div class="dm-tabs">
        <button class="dm-tab active" id="dmt-chats" onclick="showDMTab('chats')">Conversaciones</button>
        <button class="dm-tab" id="dmt-friends" onclick="showDMTab('friends')">Amigos</button>
        <button class="dm-tab" id="dmt-requests" onclick="showDMTab('requests')">
          Solicitudes<span class="badge" id="req-badge" style="display:none;">0</span>
        </button>
      </div>
      <div style="flex:1;overflow-y:auto;" id="dm-panel-body"></div>
    </div>

    <!-- Chat view -->
    <div id="v-chat" style="display:none;flex:1;flex-direction:column;overflow:hidden;">
      <div class="topbar">
        <span class="topbar-ch"><span class="sym" id="ch-sym">#</span><span id="ch-name-top">general</span></span>
        <div class="topbar-right">
          <button class="tb-btn" id="pins-btn" onclick="togglePinsPanel()" title="Mensajes fijados">ğŸ“Œ <span id="pins-count"></span></button>
          <button class="tb-btn" id="wp-open-btn" onclick="openWatchModal()">ğŸ¬ Watch Party</button>
          <button class="tb-btn" onclick="toggleMemberPanel()">ğŸ‘¥</button>
          <button class="tb-btn" onclick="downloadSnapshot()" title="Exportar chat">ğŸ’¾</button>
        </div>
      </div>
      <div id="pins-panel-wrap" style="position:relative;">
        <div id="pins-panel-dropdown" style="display:none;" class="pins-panel"></div>
      </div>
      <div class="focus-banner" id="focus-banner">
        <span>ğŸ¯</span>
        <span class="focus-label" id="focus-label">Focus</span>
        <span class="focus-timer" id="focus-timer">--:--</span>
        <button class="focus-stop" onclick="stopFocus()">âœ• Parar</button>
      </div>
      <div class="vibe-bar"><div class="vibe-fill" id="vibe-fill"></div></div>
      <div class="msgs" id="messages"></div>
      <div class="typing" id="typing-bar" style="display:none;">
        <div class="tdots"><span></span><span></span><span></span></div>
        <span id="typing-txt"></span>
      </div>
      <div class="music-bar" id="music-bar">
        <img class="m-thumb" id="m-thumb" src="" alt=""/>
        <div class="m-info">
          <div class="m-title" id="m-title">â€”</div>
          <div class="m-req" id="m-req"></div>
        </div>
        <div class="m-btns">
          <button class="m-btn" id="m-pause-btn" onclick="togglePause()">â¸</button>
          <button class="m-btn" onclick="skipSong()">â­</button>
          <button class="m-btn" onclick="stopMusic()">â¹</button>
          <input type="range" class="vol-sl" id="vol-sl" min="0" max="100" value="80" oninput="setVolume(this.value)"/>
        </div>
      </div>
      <div style="position:relative;">
        <div class="emoji-pk" id="emoji-pk"></div>
      </div>
      <div class="inp-area">
        <div class="reply-bar" id="reply-bar">
          <span style="font-size:.72rem;color:var(--muted);">â†© Respondiendo a</span>
          <span class="reply-txt" id="reply-txt"></span>
          <button class="reply-x" onclick="cancelReply()">âœ•</button>
        </div>
        <div class="inp-wrap">
          <button class="inp-btn" onclick="toggleEmoji()">ğŸ˜Š</button>
          <button class="inp-btn" onclick="document.getElementById('file-input').click()" title="Adjuntar">ğŸ“</button>
          <input type="file" id="file-input" style="display:none;" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip"/>
          <textarea class="msg-inp" id="msg-inp" placeholder="Escribe un mensaje..." rows="1" maxlength="2000"
            autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="text"></textarea>
          <button class="send-btn" onclick="sendMsg()">â–¶</button>
        </div>
        <div class="cmd-hint">/play /watch /partydo /roll /poll /alarm /focus /translate /draw /snapshot /help</div>
      </div>
    </div>

    <!-- Watch Party view (Twitch layout: video top, chat bottom) -->
    <div id="watch-view">
      <div class="wp-video" id="wp-video" style="height:55vh;"></div>
      <div class="wp-toolbar">
        <button class="wp-btn" id="wp-play-btn" onclick="wpTogglePlay()">â–¶ Play</button>
        <button class="wp-btn" onclick="requestSync()">âŸ³ Sync</button>
        <span class="wp-title" id="wp-title-bar">â€”</span>
        <button class="wp-btn" onclick="wpFullscreen()">â›¶ FS</button>
        <button class="wp-btn red" onclick="leaveWatchParty()">âœ• Salir</button>
      </div>
      <!-- Chat debajo del video -->
      <div class="wp-chat" id="wp-chat">
        <div class="msgs" id="wp-messages"></div>
        <div class="typing" id="wp-typing-bar" style="display:none;">
          <div class="tdots"><span></span><span></span><span></span></div>
          <span id="wp-typing-txt"></span>
        </div>
        <div style="position:relative;">
          <div class="emoji-pk" id="wp-emoji-pk"></div>
        </div>
        <div class="inp-area">
          <div class="inp-wrap">
            <button class="inp-btn" onclick="toggleWpEmoji()">ğŸ˜Š</button>
            <button class="inp-btn" onclick="document.getElementById('wp-file-input').click()">ğŸ“</button>
            <input type="file" id="wp-file-input" style="display:none;" multiple accept="image/*,.pdf,.doc,.txt"/>
            <textarea class="msg-inp" id="wp-msg-inp" placeholder="Chat del Watch Party..." rows="1" maxlength="2000"
              autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="text"></textarea>
            <button class="send-btn" onclick="sendWpMsg()">â–¶</button>
          </div>
        </div>
      </div>
    </div>

    <!-- DM Conversation -->
    <div id="dm-view">
      <div class="dm-head">
        <div class="dm-av" id="dm-with-av"></div>
        <span style="font-weight:700;font-size:.88rem;" id="dm-with-name">â€”</span>
        <div style="margin-left:auto;">
          <button class="tb-btn" onclick="closeDMConv()">â† Volver</button>
        </div>
      </div>
      <div class="msgs" id="dm-messages"></div>
      <div style="position:relative;"><div class="emoji-pk" id="dm-emoji-pk"></div></div>
      <div class="inp-area">
        <div class="inp-wrap">
          <button class="inp-btn" onclick="toggleDmEmoji()">ğŸ˜Š</button>
          <button class="inp-btn" onclick="document.getElementById('dm-file-input').click()">ğŸ“</button>
          <input type="file" id="dm-file-input" style="display:none;" multiple accept="image/*,.pdf,.doc,.txt"/>
          <textarea class="msg-inp" id="dm-inp" placeholder="EnvÃ­a un mensaje..." rows="1" maxlength="2000"
            autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="text"></textarea>
          <button class="send-btn" onclick="sendDM()">â–¶</button>
        </div>
      </div>
    </div>

  </div><!-- /main -->

  <!-- Member panel (derecha) -->
  <div class="member-panel" id="member-panel">
    <div class="mp-head" id="mp-head-title">Miembros</div>
    <div class="mp-body" id="mp-body"></div>
  </div>

</div><!-- /app -->

<!-- â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Create Server -->
<div class="overlay" id="create-server" onclick="if(event.target===this)closeModal('create-server')">
  <div class="modal">
    <div class="modal-title" style="color:var(--ice);">CREAR SERVIDOR</div>
    <div class="modal-sub">Se crearÃ¡n canales de texto y voz automÃ¡ticamente.</div>
    <input class="modal-inp" id="new-srv-name" placeholder="Nombre del servidor" maxlength="50" autocomplete="off" autocorrect="off"/>
    <input class="modal-inp" id="new-srv-desc" placeholder="DescripciÃ³n (opcional)" maxlength="200" autocomplete="off"/>
    <div class="modal-err" id="csrv-err"></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('create-server')">Cancelar</button>
      <button class="btn-ok" onclick="createServer()">CREAR</button>
    </div>
  </div>
</div>

<!-- Watch Party -->
<div class="overlay" id="watch-modal" onclick="if(event.target===this)closeModal('watch-modal')">
  <div class="modal">
    <div class="modal-title" style="color:var(--purple);">ğŸ¬ WATCH PARTY</div>
    <div class="modal-sub">Pega un link de YouTube â€” todos en el canal verÃ¡n el video sincronizado.</div>
    <input class="modal-inp" id="wp-url-input" placeholder="https://www.youtube.com/watch?v=..." autocomplete="off" spellcheck="false" inputmode="url"/>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('watch-modal')">Cancelar</button>
      <button class="btn-ok" onclick="startWP()">INICIAR</button>
    </div>
  </div>
</div>

<!-- Settings -->
<div class="overlay" id="settings-modal" onclick="if(event.target===this)closeModal('settings-modal')">
  <div class="modal">
    <div class="modal-title" style="color:var(--ice);">MI PERFIL</div>
    <div style="display:flex;align-items:center;gap:12px;">
      <div style="width:56px;height:56px;border-radius:50%;background:var(--bg3);overflow:hidden;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.3rem;font-weight:700;flex-shrink:0;" id="settings-av" onclick="document.getElementById('av-file').click()"></div>
      <div>
        <div style="font-weight:700;" id="settings-uname"></div>
        <div style="font-size:.72rem;color:var(--muted);">Clic para cambiar avatar</div>
      </div>
    </div>
    <input type="file" id="av-file" accept="image/*" style="display:none;"/>
    <div class="auth-field">
      <label class="auth-label">Estado personalizado</label>
      <input class="modal-inp" id="cs-inp" placeholder="Jugando a algo..." maxlength="60" autocomplete="off"/>
    </div>
    <div class="auth-field">
      <label class="auth-label">Estado</label>
      <select class="modal-inp" id="status-sel">
        <option value="online">ğŸŸ¢ Online</option>
        <option value="away">ğŸŸ¡ Ausente</option>
        <option value="dnd">ğŸ”´ No molestar</option>
        <option value="offline">âš« Invisible</option>
      </select>
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('settings-modal')">Cerrar</button>
      <button class="btn-ok" onclick="saveSettings()">GUARDAR</button>
    </div>
  </div>
</div>

<!-- Server Settings -->
<div class="overlay" id="srv-settings" onclick="if(event.target===this)closeModal('srv-settings')">
  <div class="modal">
    <div class="modal-title" style="color:var(--gold);">âš™ï¸ SERVIDOR</div>
    <div id="srv-settings-body"></div>
  </div>
</div>

<!-- Image lightbox -->
<div class="lightbox" id="lightbox" onclick="document.getElementById('lightbox').classList.remove('open')">
  <img id="lightbox-img" src="" alt=""/>
</div>

<div id="yt-hidden" style="display:none;position:absolute;width:1px;height:1px;"></div>
<script src="/socket.io/socket.io.js"></script>
<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DISKOLD v4.2 Frontend
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const socket = io();

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let myToken=null, myUser=null;
let currentServer=null, currentChannel=null;
let dmWithId=null, dmWithUser=null;
let inVoice=false, voiceChId=null, micMuted=false;
let localStream=null; const peers={};
let memberPanelOpen=false;
// Watch Party
let wpActive=false, wpType='youtube', wpVid=null, wpPlaying=false;
let wpIframe=null, wpPlayer=null, wpReady=false;
let wpPendingPlay=false, wpPendingTime=0, wpIgnore=false;
// Reply
let replyToId=null;
// Typing
let typingUsers={}, typingTO=null;
// Music
let ytPlayer=null, ytReady=false, bgAudio=null, currentSongId=null;
let unread={};
// Friends
let friendsList=[], friendRequests=[];

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $  = id => document.getElementById(id);
const esc = s => s?s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'):'';
const ini = n => n?n.slice(0,2).toUpperCase():'??';
const AV_COLORS = ['#3a6080','#2d4a22','#4a1f2d','#1f3a4a','#3a2d1f','#2d1f4a'];
const avColor = n => AV_COLORS[n?n.charCodeAt(0)%AV_COLORS.length:0];
const fmtTime = d => new Date(d).toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'});
const fmtSize = b => b>1e6?`${(b/1e6).toFixed(1)} MB`:`${Math.round(b/1024)} KB`;
const bold    = t => t.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');
const _chId   = () => currentChannel?._id||currentChannel?.id||null;
const chIdStr = () => String(_chId()||'');

function makeAvEl(name, avatar, cls='av'){
  if(avatar) return `<div class="${cls}"><img src="${esc(avatar)}" alt=""/></div>`;
  return `<div class="${cls}" style="background:${avColor(name)}">${ini(name)}</div>`;
}
function apiFetch(url, method='GET', body=null){
  const tok = myToken||localStorage.getItem('dk_token')||'';
  const opts = {method, headers:{'Content-Type':'application/json','Authorization':'Bearer '+tok}};
  if(body) opts.body=JSON.stringify(body);
  return fetch(url,opts).then(r=>r.json()).catch(()=>({ok:false,error:'Error de red'}));
}

// â”€â”€ Audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _actx=null;
function getACtx(){if(!_actx)_actx=new(window.AudioContext||window.webkitAudioContext)();if(_actx.state==='suspended')_actx.resume();return _actx;}
function beep(f=440,d=.12,v=.13,t='sine'){try{const c=getACtx(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type=t;o.frequency.value=f;g.gain.setValueAtTime(v,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+d);o.start();o.stop(c.currentTime+d);}catch{}}
const sndJoin   = ()=>{beep(880,.08,.1);setTimeout(()=>beep(1100,.1,.1),90);};
const sndLeave  = ()=>{beep(660,.08,.1);setTimeout(()=>beep(440,.1,.1),90);};
const sndMute   = ()=>beep(300,.15,.09,'square');
const sndUnmute = ()=>{beep(600,.08,.09);setTimeout(()=>beep(800,.08,.09),80);};
const sndMsg    = ()=>beep(1200,.05,.04);
const sndMention= ()=>{beep(900,.1,.18);setTimeout(()=>beep(1200,.15,.18),120);};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTab(t){
  $('tab-login').style.display   = t==='login'   ?'flex':'none';
  $('tab-register').style.display= t==='register'?'flex':'none';
  document.querySelectorAll('.auth-tab').forEach((b,i)=>b.classList.toggle('active',i===(t==='login'?0:1)));
}
async function doLogin(){
  const u=$('l-u').value.trim(), p=$('l-p').value;
  $('l-err').classList.remove('show');
  if(!u||!p){$('l-err').textContent='Completa los campos.';$('l-err').classList.add('show');return;}
  const r=await apiFetch('/api/login','POST',{username:u,password:p});
  if(!r.ok){$('l-err').textContent=r.error;$('l-err').classList.add('show');return;}
  enterApp(r.token,r.user);
}
async function doRegister(){
  const u=$('r-u').value.trim(), p=$('r-p').value;
  $('r-err').classList.remove('show');
  if(!u||!p){$('r-err').textContent='Completa los campos.';$('r-err').classList.add('show');return;}
  const r=await apiFetch('/api/register','POST',{username:u,password:p});
  if(!r.ok){$('r-err').textContent=r.error;$('r-err').classList.add('show');return;}
  enterApp(r.token,r.user);
}
function enterApp(token,user){
  myToken=token; myUser=user;
  localStorage.setItem('dk_token',token);
  $('auth-screen').style.display='none';
  $('app').style.display='flex';
  $('my-name-label').textContent=user.username;
  $('my-cs-label').textContent=user.customStatus||'online';
  renderMyAv();
  socket.emit('auth',token);
  loadServers();
  loadFriends();
  setupFileInputs();
  requestWakeLock();
  setupEmojiPickers();
}
function renderMyAv(){
  const el=$('my-av'), ini_el=$('my-av-ini');
  if(myUser?.avatar){el.innerHTML=`<img src="${myUser.avatar}" alt=""/><div class="sdot s-${myUser.status||'online'}" id="my-sdot"></div>`;}
  else{ini_el.textContent=ini(myUser?.username);el.style.background=avColor(myUser?.username);el.innerHTML+=`<div class="sdot s-${myUser.status||'online'}" id="my-sdot"></div>`;}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadServers(){
  const r=await apiFetch('/api/servers');
  if(!r.ok)return;
  renderSrvList(r.servers);
}
function renderSrvList(srvs){
  $('srv-list').innerHTML=srvs.map(s=>`
    <div class="srv-btn ${currentServer?._id===String(s._id)?'active':''}"
         id="sb-${s._id}" onclick="selectServer('${s._id}')" title="${esc(s.name)}" style="margin:2px 0;">
      ${s.icon?`<img src="${s.icon}" alt=""/>`:`<span style="font-size:.68rem;font-weight:700;font-family:'Space Mono',monospace;">${s.name.slice(0,2).toUpperCase()}</span>`}
    </div>`).join('');
}
async function selectServer(srvId){
  const r=await apiFetch(`/api/servers/${srvId}`);
  if(!r.ok){return;}
  currentServer=r.server;
  $('srv-name-label').textContent=currentServer.name;
  socket.emit('join-server',{serverId:srvId});
  renderChSidebar();
  document.querySelectorAll('.srv-btn').forEach(b=>b.classList.remove('active'));
  $(`sb-${srvId}`)?.classList.add('active');
  $('v-dm-panel').style.display='none';
  // Auto-entrar al primer canal de texto
  const firstText=currentServer.channels.find(c=>c.type==='text');
  if(firstText) selectChannel(String(firstText._id));
  else showView('welcome');
}
function renderChSidebar(){
  if(!currentServer)return;
  const textChs  = currentServer.channels.filter(c=>c.type==='text');
  const voiceChs = currentServer.channels.filter(c=>c.type==='voice');
  const isAdmin  = currentServer.members.find(m=>(m.user._id||m.user)===myUser?.id&&['owner','admin'].includes(m.role));
  $('ch-body').innerHTML=`
    <div class="ch-sec">Texto ${isAdmin?`<button onclick="addChannel('text')">ï¼‹</button>`:''}</div>
    ${textChs.map(c=>`<div class="ch-item ${String(currentChannel?._id)===String(c._id)?'active':''}" id="ci-${c._id}" onclick="selectChannel('${c._id}')">
      <span class="sym">#</span><span class="nm">${esc(c.name)}</span>
      ${unread[c._id]?`<span class="unread">${unread[c._id]}</span>`:''}
    </div>`).join('')}
    <div class="ch-sec" style="margin-top:6px;">Voz ${isAdmin?`<button onclick="addChannel('voice')">ï¼‹</button>`:''}</div>
    ${voiceChs.map(c=>`<div class="v-item ${voiceChId===String(c._id)?'active':''}" id="vi-${c._id}" onclick="joinVoiceCh('${c._id}')">
      <div class="v-head"><span>${voiceChId===String(c._id)?'ğŸ”Š':'ğŸ”ˆ'}</span><span>${esc(c.name)}</span></div>
      <div class="v-users" id="vu-${c._id}"></div>
    </div>`).join('')}`;
}
async function selectChannel(chId){
  const ch = currentServer.channels.find(c=>String(c._id)===String(chId)||String(c.id)===String(chId));
  if(!ch||ch.type!=='text')return;
  currentChannel=ch;
  if(!ch._id)ch._id=chId;
  unread[String(chId)]=0;
  document.querySelectorAll('.ch-item').forEach(e=>e.classList.remove('active'));
  $(`ci-${chId}`)?.classList.add('active');
  $('ch-name-top').textContent=ch.name;
  $('mob-title').textContent='# '+ch.name;
  $('ch-sym').textContent='#';
  $('msg-inp').placeholder=`Escribe en #${ch.name}...`;
  showView('chat');
  $('messages').innerHTML='';
  socket.emit('join-channel',{channelId:String(chId)});
  closeDrawer();
  renderMemberPanel();
}
function addChannel(type){
  const name=prompt(`Nombre del canal de ${type==='text'?'texto':'voz'}:`);
  if(!name?.trim())return;
  apiFetch(`/api/servers/${currentServer._id}/channels`,'POST',{name:name.trim(),type}).then(async ()=>{
    const r=await apiFetch(`/api/servers/${currentServer._id}`);
    if(r.ok){currentServer=r.server;renderChSidebar();}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
socket.on('channel-history',({channelId,messages})=>{
  if(String(channelId)!==chIdStr())return;
  const box=$('messages');
  box.innerHTML='';
  messages.forEach(m=>appendMsg(m,box));
  box.scrollTop=box.scrollHeight;
  // TambiÃ©n rellenar WP chat si estamos en WP
  if(wpActive){const wb=$('wp-messages');wb.innerHTML='';messages.forEach(m=>appendMsg(m,wb));wb.scrollTop=wb.scrollHeight;}
});

socket.on('new-message',msg=>{
  const msgChId=String(msg.channelId||'');
  const myCh=chIdStr();
  if(msgChId&&myCh&&msgChId===myCh){
    appendMsg(msg,$('messages'));
    $('messages').scrollTop=$('messages').scrollHeight;
    if(wpActive){appendMsg(msg,$('wp-messages'));$('wp-messages').scrollTop=$('wp-messages').scrollHeight;}
    if(msg.authorName!==myUser?.username){
      msg.content?.includes('@'+myUser?.username)?sndMention():sndMsg();
    }
  } else if(msgChId){
    unread[msgChId]=(unread[msgChId]||0)+1;
    if(currentServer)renderChSidebar();
  }
});

function appendMsg(msg, box){
  if(!box)return;
  if(msg.type==='system'||(!msg.author&&!msg.authorName)){
    const d=document.createElement('div');d.className='msg-sys';d.textContent=msg.content||'';
    box.appendChild(d);return;
  }
  const isBot=msg.type==='bot';
  const isMe=String(msg.author)===String(myUser?.id);
  const d=document.createElement('div');
  d.className='msg-grp';
  d.dataset.mid=msg._id||'';
  d.dataset.content=msg.content||'';

  const avHtml=isBot
    ?`<div class="av bot-av">ğŸ¤–</div>`
    :makeAvEl(msg.authorName||'?',msg.authorAvatar);

  const replyHtml=msg.replyPreview
    ?`<div class="msg-reply">â†© ${esc(msg.replyPreview)}</div>`:'';

  const rxnHtml=(msg.reactions||[]).filter(r=>r.users?.length>0).map(r=>`
    <div class="rxn ${r.users.map(String).includes(String(myUser?.id))?'mine':''}"
         onclick="reactMsg('${msg._id}','${r.emoji}','${chIdStr()}')">
      ${r.emoji}<span>${r.users.length}</span>
    </div>`).join('');

  // Attachments
  const attHtml=(msg.attachments||[]).map(a=>{
    const isImg=a.mimetype?.startsWith('image/');
    if(isImg) return `<img class="attach-img" src="/api/files/${a.fileId}" alt="${esc(a.filename)}" onclick="openLightbox(this.src)"/>`;
    return `<a class="attach-file" href="/api/files/${a.fileId}" download="${esc(a.filename)}" target="_blank">
      <span class="ficon">ğŸ“„</span>
      <span class="finfo"><span class="fname">${esc(a.filename)}</span><span class="fsize">${fmtSize(a.size||0)}</span></span>
    </a>`;
  }).join('');

  const actsHtml=`<div class="msg-acts">
    <button class="act-btn" onclick="startReply('${msg._id}','${esc((msg.content||'').slice(0,60))}')">â†©</button>
    <button class="act-btn" onclick="showRxnFor('${msg._id}','${chIdStr()}')">ğŸ˜Š</button>
    ${isMe?`<button class="act-btn" onclick="editMsg('${msg._id}')">âœï¸</button>`:''}
    ${isMe||isServerAdmin()?`<button class="act-btn danger" onclick="deleteMsg('${msg._id}')">ğŸ—‘</button>`:''}
  </div>`;

  d.innerHTML=`${actsHtml}${avHtml}<div class="msg-body">
    <div class="msg-head">
      <span class="msg-name${isBot?' bot':''}" onclick="showUserCtx(event,'${msg.authorName||''}','${msg.authorAvatar||''}','${msg.author||''}')">${esc(msg.authorName||'')}</span>
      <span class="msg-time">${fmtTime(msg.createdAt)}</span>
      ${msg.edited?`<span class="msg-ed">(editado)</span>`:''}
    </div>
    ${replyHtml}
    <div class="msg-txt${msg.deleted?' del':''}">${bold(esc(msg.content||''))}</div>
    ${attHtml}
    <div class="reactions">${rxnHtml}</div>
  </div>`;
  box.appendChild(d);
}

function isServerAdmin(){
  if(!currentServer||!myUser)return false;
  const m=currentServer.members.find(m=>(m.user._id||m.user)===myUser.id||(m.user._id||m.user)===String(myUser.id));
  return m&&['owner','admin'].includes(m.role);
}

// â”€â”€ Send Message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendMsg(){
  const el=$('msg-inp');
  const content=el.value.trim();
  const chId=_chId();
  if(!chId)return;
  if(!content&&!pendingFiles.length)return;
  // Upload files first
  const attachments=await uploadFiles(pendingFiles);
  pendingFiles=[];
  clearFilePreview();
  socket.emit('send-message',{channelId:String(chId),content,replyToId,attachments});
  el.value='';el.style.height='auto';
  cancelReply();
  socket.emit('typing-stop',{channelId:String(chId)});
}

function sendWpMsg(){
  const el=$('wp-msg-inp');
  const content=el.value.trim();
  const chId=_chId();
  if(!content||!chId)return;
  socket.emit('send-message',{channelId:String(chId),content,replyToId:null,attachments:[]});
  el.value='';
}

// â”€â”€ File Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pendingFiles=[];
function setupFileInputs(){
  ['file-input','wp-file-input','dm-file-input'].forEach(id=>{
    const el=$(id);if(!el)return;
    el.addEventListener('change',async e=>{
      const files=Array.from(e.target.files);
      if(id==='dm-file-input') await sendDMFiles(files);
      else { pendingFiles=[...pendingFiles,...files]; showFilePreview(); }
      el.value='';
    });
  });
  $('av-file')?.addEventListener('change',async e=>{
    const file=e.target.files[0]; if(!file)return;
    if(file.size>3*1024*1024){alert('MÃ¡x 3MB para avatares');return;}
    const b64=await toBase64(file);
    myUser.avatar=b64;
    await apiFetch('/api/update-profile','POST',{avatar:b64});
    renderMyAv();updateSettingsAv();
    e.target.value='';
  });
}
function toBase64(file){
  return new Promise(res=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.readAsDataURL(file);});
}
async function uploadFiles(files){
  const results=[];
  for(const file of files){
    if(file.size>10*1024*1024){alert(`${file.name}: mÃ¡x 10MB`);continue;}
    const data=await toBase64(file);
    const r=await apiFetch('/api/upload','POST',{filename:file.name,mimetype:file.type,data});
    if(r.ok) results.push({fileId:r.fileId,filename:r.filename,mimetype:r.mimetype,size:r.size});
  }
  return results;
}
async function sendDMFiles(files){
  const attachments=await uploadFiles(files);
  if(!attachments.length)return;
  socket.emit('send-dm',{toUserId:dmWithId,content:'',attachments});
}
function showFilePreview(){
  let bar=$('file-preview-bar');
  if(!bar){bar=document.createElement('div');bar.id='file-preview-bar';bar.style.cssText='padding:4px 12px;display:flex;gap:6px;flex-wrap:wrap;';$('inp-area').prepend?$('v-chat').querySelector('.inp-area').prepend(bar):null;}
  if(bar)bar.innerHTML=pendingFiles.map((f,i)=>`<span style="background:var(--bg3);border:1px solid var(--line);border-radius:5px;padding:3px 8px;font-size:.72rem;display:flex;gap:4px;align-items:center;">${esc(f.name)}<button onclick="pendingFiles.splice(${i},1);showFilePreview();" style="background:none;border:none;color:var(--muted);cursor:pointer;">âœ•</button></span>`).join('');
}
function clearFilePreview(){const b=$('file-preview-bar');if(b)b.innerHTML='';}

// â”€â”€ Typing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupInputEnter(inputId, sendFn){
  const el=$(inputId);if(!el)return;
  el.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendFn();return;}
    const chId=_chId();
    if(chId){
      socket.emit('typing-start',{channelId:String(chId)});
      clearTimeout(typingTO);
      typingTO=setTimeout(()=>socket.emit('typing-stop',{channelId:String(chId)}),3000);
    }
  });
  el.addEventListener('input',()=>{el.style.height='auto';el.style.height=Math.min(el.scrollHeight,110)+'px';});
}
socket.on('typing',({userId,username,channelId})=>{
  if(String(channelId)!==chIdStr()||userId===myUser?.id)return;
  if(!typingUsers[channelId])typingUsers[channelId]={};
  typingUsers[channelId][userId]={username};
  updateTyping(channelId);
});
socket.on('typing-stop',({userId,channelId})=>{
  if(typingUsers[channelId])delete typingUsers[channelId][userId];
  updateTyping(channelId);
});
function updateTyping(cid){
  const isCurrent=String(cid)===chIdStr();
  const barId=isCurrent?(wpActive?'wp-typing-bar':'typing-bar'):'typing-bar';
  const txtId=isCurrent?(wpActive?'wp-typing-txt':'typing-txt'):'typing-txt';
  const bar=$(barId),txt=$(txtId);
  const names=Object.values(typingUsers[cid]||{}).map(u=>u.username);
  if(!names.length||!bar){bar&&(bar.style.display='none');return;}
  bar.style.display='flex';
  txt.textContent=names.length===1?`${names[0]} estÃ¡ escribiendo...`:names.length<4?`${names.join(', ')} estÃ¡n escribiendo...`:'Varios estÃ¡n escribiendo...';
}

// â”€â”€ Reply â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startReply(id,preview){replyToId=id;$('reply-bar').classList.add('on');$('reply-txt').textContent=preview;$('msg-inp').focus();}
function cancelReply(){replyToId=null;$('reply-bar').classList.remove('on');}

// â”€â”€ Reactions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EMOJIS=['ğŸ‘','â¤ï¸','ğŸ˜‚','ğŸ˜®','ğŸ˜¢','ğŸ”¥','ğŸ‰','ğŸ’¯','ğŸ‘','âœ…','ğŸ’€','ğŸ¤™','ğŸ˜','ğŸ«¡','ğŸ’ª'];
function setupEmojiPickers(){
  ['emoji-pk','wp-emoji-pk','dm-emoji-pk'].forEach(id=>{
    const el=$(id);if(!el)return;
    el.innerHTML=EMOJIS.map(e=>`<button class="epk-btn" onclick="insertEmoji('${e}','${id}')">${e}</button>`).join('');
  });
}
function insertEmoji(e,pkId){
  const inp=pkId==='emoji-pk'?$('msg-inp'):pkId==='wp-emoji-pk'?$('wp-msg-inp'):$('dm-inp');
  if(inp){inp.value+=e;inp.focus();}
  $(pkId).classList.remove('open');
}
function toggleEmoji(){$('emoji-pk').classList.toggle('open');}
function toggleWpEmoji(){$('wp-emoji-pk').classList.toggle('open');}
function toggleDmEmoji(){$('dm-emoji-pk').classList.toggle('open');}
function showRxnFor(msgId,chId){
  // Mini picker para reaccionar a un mensaje
  let pk=$('rxn-picker');
  if(!pk){pk=document.createElement('div');pk.id='rxn-picker';pk.style.cssText='position:fixed;background:var(--bg3);border:1px solid var(--line);border-radius:10px;padding:7px;display:flex;flex-wrap:wrap;gap:3px;width:200px;z-index:60;box-shadow:0 8px 24px rgba(0,0,0,.5);';document.body.appendChild(pk);}
  pk.innerHTML=EMOJIS.map(e=>`<button class="epk-btn" onclick="reactMsg('${msgId}','${e}','${chId}');document.getElementById('rxn-picker').remove();">${e}</button>`).join('');
  const msg=document.querySelector(`[data-mid="${msgId}"]`);
  if(msg){const r=msg.getBoundingClientRect();pk.style.top=(r.top-130)+'px';pk.style.left=r.left+'px';}
  setTimeout(()=>document.addEventListener('click',()=>pk.remove(),{once:true}),100);
}
function reactMsg(messageId,emoji,channelId){socket.emit('react',{messageId,emoji,channelId});}
socket.on('reaction-update',({messageId,reactions})=>{
  document.querySelectorAll(`[data-mid="${messageId}"] .reactions`).forEach(el=>{
    el.innerHTML=reactions.filter(r=>r.users?.length>0).map(r=>`
      <div class="rxn ${r.users.map(String).includes(String(myUser?.id))?'mine':''}"
           onclick="reactMsg('${messageId}','${r.emoji}','${chIdStr()}')">
        ${r.emoji}<span>${r.users.length}</span>
      </div>`).join('');
  });
});

// â”€â”€ Edit / Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function editMsg(msgId){
  const el=document.querySelector(`[data-mid="${msgId}"] .msg-txt`);if(!el)return;
  const orig=document.querySelector(`[data-mid="${msgId}"]`).dataset.content;
  const ta=document.createElement('textarea');ta.value=orig;ta.className='msg-inp';ta.style.cssText='width:100%;resize:none;min-height:36px;background:var(--bg4);border:1px solid var(--icedim);border-radius:5px;padding:4px 8px;';
  el.replaceWith(ta);ta.focus();
  ta.addEventListener('keydown',async e=>{
    if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();await apiFetch(`/api/messages/${msgId}`,'PATCH',{content:ta.value.trim()});ta.replaceWith(el);el.textContent=ta.value.trim();}
    if(e.key==='Escape')ta.replaceWith(el);
  });
}
socket.on('message-edited',({messageId,content})=>{
  document.querySelectorAll(`[data-mid="${messageId}"] .msg-txt`).forEach(el=>el.textContent=content);
});
async function deleteMsg(msgId){
  if(!confirm('Â¿Eliminar?'))return;
  await apiFetch(`/api/messages/${msgId}`,'DELETE');
}
socket.on('message-deleted',({messageId})=>{
  document.querySelectorAll(`[data-mid="${messageId}"] .msg-txt`).forEach(el=>{el.textContent='Mensaje eliminado';el.classList.add('del');});
});

// â”€â”€ User context â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showUserCtx(e,username,avatar,userId){
  document.getElementById('user-popup')?.remove();
  if(!username||!userId||userId==='undefined')return;
  const isFriend=friendsList.some(f=>String(f._id||f)===String(userId));
  const isMe=String(userId)===String(myUser?.id);
  const popup=document.createElement('div');
  popup.id='user-popup';
  popup.style.cssText='position:fixed;background:var(--bg2);border:1px solid var(--line);border-radius:10px;width:200px;z-index:150;box-shadow:0 8px 24px rgba(0,0,0,.6);overflow:hidden;';
  popup.innerHTML=`<div style="height:40px;background:linear-gradient(135deg,var(--icedim),var(--purple));position:relative;">
    <div style="position:absolute;bottom:-16px;left:12px;width:40px;height:40px;border-radius:50%;border:3px solid var(--bg2);overflow:hidden;background:${avColor(username)};display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.9rem;">
      ${avatar?`<img src="${esc(avatar)}" style="width:100%;height:100%;object-fit:cover;"/>`:`<span>${ini(username)}</span>`}
    </div>
  </div>
  <div style="padding:22px 12px 10px;">
    <div style="font-weight:700;font-size:.9rem;">${esc(username)}</div>
    <div style="height:8px;"></div>
    ${!isMe?`<button onclick="openDMWith('${userId}','${esc(username)}','${esc(avatar)}');document.getElementById('user-popup')?.remove();" style="width:100%;text-align:left;padding:5px 6px;border-radius:5px;border:none;background:none;color:var(--text);cursor:pointer;font-size:.8rem;">ğŸ’¬ Mensaje directo</button>
    ${!isFriend?`<button onclick="sendFriendReq('${userId}');document.getElementById('user-popup')?.remove();" style="width:100%;text-align:left;padding:5px 6px;border-radius:5px;border:none;background:none;color:var(--text);cursor:pointer;font-size:.8rem;">â• Agregar amigo</button>`:''}`:``}
  </div>`;
  document.body.appendChild(popup);
  const rect=e.target.getBoundingClientRect();
  const top=Math.min(rect.bottom+4,window.innerHeight-180);
  const left=Math.min(rect.left,window.innerWidth-210);
  popup.style.top=top+'px';popup.style.left=left+'px';
  setTimeout(()=>document.addEventListener('click',()=>popup.remove(),{once:true}),100);
}
function openLightbox(src){$('lightbox-img').src=src;$('lightbox').classList.add('open');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DM & FRIENDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadFriends(){
  const r=await apiFetch('/api/friends');
  if(!r.ok)return;
  friendsList=r.friends||[];
  friendRequests=r.requests||[];
  updateFriendBadge();
}
function updateFriendBadge(){
  const n=friendRequests.length;
  const badge=$('friend-req-badge');
  if(badge){badge.textContent=n;badge.style.display=n>0?'block':'none';}
  const rb=$('req-badge');
  if(rb){rb.textContent=n;rb.style.display=n>0?'inline':'none';}
}
function openDMPanel(){
  currentChannel=null;
  $('v-welcome').style.display='none';
  $('v-chat').style.display='none';
  document.getElementById('watch-view').classList.remove('on');
  $('dm-view').classList.remove('on');
  $('v-dm-panel').style.display='flex';
  $('v-dm-panel').style.flexDirection='column';
  // deselect server
  document.querySelectorAll('.srv-btn').forEach(b=>b.classList.remove('active'));
  $('dm-btn').classList.add('active');
  showDMTab('chats');
  closeDrawer();
}
let dmTab='chats';
async function showDMTab(tab){
  dmTab=tab;
  document.querySelectorAll('.dm-tab').forEach(b=>b.classList.remove('active'));
  $(`dmt-${tab}`)?.classList.add('active');
  const body=$('dm-panel-body');body.innerHTML='';
  if(tab==='chats'){
    // Search bar + recent conversations
    body.innerHTML=`<div style="padding:8px 8px 4px;">
      <input class="dm-panel-search" id="user-search" placeholder="Buscar usuario..." autocomplete="off" autocorrect="off"/>
      <div id="search-results"></div>
    </div><div id="recent-dms"></div>`;
    $('user-search').addEventListener('input',debounce(doUserSearch,300));
    loadRecentDMs();
  } else if(tab==='friends'){
    body.innerHTML='<div id="friends-list" style="padding:6px 0;"></div>';
    renderFriendsList();
  } else if(tab==='requests'){
    body.innerHTML='<div id="req-list" style="padding:6px 0;"></div>';
    renderRequestsList();
  }
}
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}
async function doUserSearch(){
  const q=$('user-search')?.value.trim();
  const res=$('search-results');if(!res)return;
  if(!q||q.length<2){res.innerHTML='';return;}
  const r=await apiFetch(`/api/users/search?q=${encodeURIComponent(q)}`);
  if(!r.ok)return;
  res.innerHTML=r.users.map(u=>`<div class="dm-list-item" onclick="openDMWith('${u._id}','${esc(u.username)}','${esc(u.avatar||'')}')">
    ${makeAvEl(u.username,u.avatar,'av-sm')}
    <div><div class="dm-name">${esc(u.username)}</div>
    <div class="dm-preview">${u.status||'offline'}</div></div>
  </div>`).join('');
}
async function loadRecentDMs(){
  const r=await apiFetch('/api/dms');
  const box=$('recent-dms');if(!box)return;
  if(!r.ok||!r.dms.length){box.innerHTML='<div style="padding:10px 12px;font-size:.78rem;color:var(--muted);">Sin conversaciones recientes</div>';return;}
  // Los DMs solo tienen los IDs de participantes, necesitamos names â€” los guardamos al abrir DM
  box.innerHTML=`<div class="ch-sec">Recientes</div>`+r.dms.map(dm=>{
    const otherId=dm.participants.find(p=>String(p)!==String(myUser?.id));
    return `<div class="dm-list-item" onclick="openDMById('${otherId}')">
      <div class="av-sm" style="background:${avColor('')}">${ini('')}</div>
      <div><div class="dm-name">${otherId}</div><div class="dm-preview">DM</div></div>
    </div>`;
  }).join('');
}
function renderFriendsList(){
  const box=$('friends-list');if(!box)return;
  if(!friendsList.length){box.innerHTML='<div style="padding:10px 12px;font-size:.78rem;color:var(--muted);">Sin amigos aÃºn.</div>';return;}
  box.innerHTML=friendsList.map(f=>`<div class="friend-item">
    ${makeAvEl(f.username,f.avatar,'av-sm')}
    <div class="fi-info"><div class="fi-name">${esc(f.username)}</div><div class="fi-status ${f.status==='online'?'s-online':''}">${f.status||'offline'}</div></div>
    <div class="fi-btns">
      <button class="fi-btn" onclick="openDMWith('${f._id}','${esc(f.username)}','${esc(f.avatar||'')}')">ğŸ’¬</button>
    </div>
  </div>`).join('');
}
function renderRequestsList(){
  const box=$('req-list');if(!box)return;
  box.innerHTML=`<div style="padding:8px 10px;">
    <div class="ch-sec" style="padding:0 0 4px;">Enviar solicitud</div>
    <div style="display:flex;gap:6px;padding:0 0 10px;">
      <input class="dm-panel-search" id="req-search" placeholder="Usuario exacto..." autocomplete="off" autocorrect="off" style="flex:1;"/>
      <button class="btn-ok" onclick="sendFriendReqByName()" style="white-space:nowrap;padding:5px 10px;">Agregar</button>
    </div>
  </div>
  <div class="ch-sec">Solicitudes recibidas</div>
  ${friendRequests.length?friendRequests.map(req=>`<div class="friend-item">
    ${makeAvEl(req.username,req.avatar,'av-sm')}
    <div class="fi-info"><div class="fi-name">${esc(req.username)}</div><div class="fi-status">quiere ser tu amigo</div></div>
    <div class="fi-btns">
      <button class="fi-btn ok" onclick="acceptFriend('${req.from}')">âœ“</button>
      <button class="fi-btn no" onclick="declineFriend('${req.from}')">âœ•</button>
    </div>
  </div>`).join(''):'<div style="padding:6px 12px;font-size:.78rem;color:var(--muted);">Sin solicitudes.</div>'}`;
}
async function sendFriendReqByName(){
  const name=$('req-search')?.value.trim();
  if(!name)return;
  const r=await apiFetch(`/api/users/search?q=${encodeURIComponent(name)}`);
  const user=r.users?.find(u=>u.username.toLowerCase()===name.toLowerCase());
  if(!user){alert('Usuario no encontrado.');return;}
  sendFriendReq(user._id);
}
async function sendFriendReq(userId){
  const r=await apiFetch(`/api/friends/request/${userId}`,'POST');
  if(r.ok) alert(r.accepted?'Â¡Ya son amigos!':'Solicitud enviada.');
  else alert(r.error||'Error');
}
async function acceptFriend(fromId){
  await apiFetch(`/api/friends/accept/${fromId}`,'POST');
  await loadFriends();
  showDMTab('requests');
}
async function declineFriend(fromId){
  await apiFetch(`/api/friends/decline/${fromId}`,'POST');
  await loadFriends();
  showDMTab('requests');
}
async function openDMWith(userId, username, avatar){
  dmWithId=userId; dmWithUser={id:userId,username,avatar};
  $('dm-with-name').textContent=username;
  const avEl=$('dm-with-av');
  avEl.innerHTML=avatar?`<img src="${esc(avatar)}" alt=""/>`:ini(username);
  avEl.style.background=avColor(username);
  socket.emit('join-dm',{withUserId:userId});
  const r=await apiFetch(`/api/dm/${userId}/messages`);
  const box=$('dm-messages');box.innerHTML='';
  if(r.ok)r.messages.forEach(m=>appendMsg(m,box));
  box.scrollTop=box.scrollHeight;
  showView('dm');
}
async function openDMById(userId){
  const r=await apiFetch(`/api/users/search?q=${userId}`);
  // Fallback â€” abrir DM con solo ID
  await openDMWith(userId,userId,'');
}
function closeDMConv(){showView('dm-panel');}
function sendDM(){
  const el=$('dm-inp');
  const content=el.value.trim();
  if(!content&&!pendingFiles.length||!dmWithId)return;
  socket.emit('send-dm',{toUserId:dmWithId,content,attachments:[]});
  el.value='';
}
socket.on('dm-message',({message,participants})=>{
  if(!dmWithId)return;
  if(!participants.some(p=>String(p)===String(dmWithId)||String(p)===String(myUser?.id)))return;
  const box=$('dm-messages');appendMsg(message,box);box.scrollTop=box.scrollHeight;
  if(String(message.author)!==String(myUser?.id))sndMsg();
});
socket.on('friend-request',req=>{
  friendRequests.push(req);updateFriendBadge();sndMention();
});
socket.on('friend-added',({userId,username,avatar})=>{
  if(!friendsList.find(f=>String(f._id||f)===String(userId)))
    friendsList.push({_id:userId,username,avatar,status:'online'});
  updateFriendBadge();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MEMBER PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleMemberPanel(){
  memberPanelOpen=!memberPanelOpen;
  $('member-panel').classList.toggle('open',memberPanelOpen);
  if(memberPanelOpen)renderMemberPanel();
}
function renderMemberPanel(){
  if(!currentServer)return;
  const members=currentServer.members||[];
  const onlineIds=new Set(Object.values({}).map(c=>c.userId));
  // Usar datos del socket si estÃ¡n disponibles
  const online=members.filter(m=>{const u=m.user;return u&&(u.status==='online'||onlineIds.has(String(u._id||u)));});
  const offline=members.filter(m=>{const u=m.user;return u&&!online.includes(m);});
  const roleLabel={owner:'ğŸ‘‘ DueÃ±o',admin:'ğŸ›¡ Admin',member:'Miembro'};
  const renderUser=m=>{
    const u=m.user; if(!u||!u.username)return '';
    const st=u.status||'offline';
    return `<div class="mp-user" onclick="showUserCtx(event,'${esc(u.username)}','${esc(u.avatar||'')}','${u._id||''}')">
      <div class="mp-av" style="background:${avColor(u.username)}">
        ${u.avatar?`<img src="${esc(u.avatar)}" alt=""/>`:`<span>${ini(u.username)}</span>`}
        <div class="mp-sdot s-${st}" style="background:${st==='online'?'var(--green)':st==='away'?'var(--gold)':st==='dnd'?'var(--red)':'var(--muted)'}"></div>
      </div>
      <div class="mp-info">
        <div class="mp-name">${esc(u.username)}</div>
        <div class="mp-role">${roleLabel[m.role]||'Miembro'}</div>
      </div>
    </div>`;
  };
  $('mp-body').innerHTML=`
    <div class="mp-sec">Online â€” ${online.length}</div>
    ${online.map(renderUser).join('')}
    ${offline.length?`<div class="mp-sec" style="margin-top:8px;">Offline â€” ${offline.length}</div>${offline.map(renderUser).join('')}`:''}`;
  $('mp-head-title').textContent=`ğŸ‘¥ Miembros (${members.length})`;
}
socket.on('online-members',members=>{
  // Actualizar estados en member panel si estÃ¡ abierto
  if(memberPanelOpen&&currentServer){
    members.forEach(m=>{
      const srv_m=currentServer.members.find(sm=>(sm.user._id||sm.user)===m.userId);
      if(srv_m&&srv_m.user)srv_m.user.status='online';
    });
    // Los que no estÃ¡n en online â†’ offline
    currentServer.members.forEach(sm=>{
      if(sm.user&&!members.find(m=>m.userId===(sm.user._id||sm.user)))
        sm.user.status='offline';
    });
    renderMemberPanel();
  }
});
socket.on('user-status',({userId,status})=>{
  if(memberPanelOpen&&currentServer){
    const m=currentServer.members.find(sm=>(sm.user?._id||sm.user)===userId||(sm.user?._id||sm.user)===String(userId));
    if(m&&m.user)m.user.status=status;
    renderMemberPanel();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WATCH PARTY â€” Twitch layout
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openWatchModal(){if(!_chId())return;openModal('watch-modal');setTimeout(()=>$('wp-url-input')?.focus(),200);}
function startWP(){
  const url=$('wp-url-input').value.trim();
  if(!url)return;
  socket.emit('watch-start',{channelId:String(_chId()),url,type:'youtube'});
  closeModal('watch-modal');
  $('wp-url-input').value='';
}

socket.on('watch-state',({channelId,active,type,videoId,url,title,playing,currentTime,lastSync})=>{
  const myCh=chIdStr();
  if(channelId&&myCh&&String(channelId)!==myCh)return;
  if(!active){if(wpActive)leaveWPLocal();return;}
  const isNew=!wpActive||wpVid!==videoId||wpType!==type;
  wpActive=true;wpVid=videoId;wpType=type;wpPlaying=playing;
  const elapsed=playing?(Date.now()-lastSync)/1000:0;
  const syncTime=Math.max(0,(currentTime||0)+elapsed);
  $('wp-title-bar').textContent=title||'Watch Party';
  updateWpBtns();
  $('wp-open-btn').classList.add('live');$('wp-open-btn').textContent='ğŸ”´ LIVE';
  $('mob-wp-btn').textContent='ğŸ”´';
  if(isNew){
    if(type==='iframe')createIframeWP(url);
    else createYtWP(videoId,syncTime,playing);
  } else if(type!=='iframe'){
    applyWpCmd(playing?'sync-play':'sync-pause',syncTime);
  }
  showView('watch');
  // Sync chat history into WP chat
  const msgs=$('messages');
  const wpMsgs=$('wp-messages');
  if(wpMsgs&&msgs)wpMsgs.innerHTML=msgs.innerHTML;
});

socket.on('watch-cmd',({channelId,action,currentTime})=>{
  if(channelId&&chIdStr()&&String(channelId)!==chIdStr())return;
  if(wpType==='iframe')return;
  wpPlaying=(action==='play'||action==='sync-play');
  updateWpBtns();
  applyWpCmd(action,currentTime);
});

function createYtWP(videoId,startTime,shouldPlay){
  wpVid=videoId;wpReady=false;wpPendingPlay=shouldPlay;wpPendingTime=startTime||0;wpIgnore=true;
  if(wpPlayer){try{wpPlayer.destroy();}catch{}wpPlayer=null;}
  wpIframe=null;
  const wrap=$('wp-video');wrap.innerHTML='';
  const isMob=window.innerWidth<=768;
  if(isMob){
    const fr=document.createElement('iframe');
    fr.style.cssText='position:absolute;inset:0;width:100%;height:100%;border:none;';
    fr.setAttribute('allowfullscreen','');
    fr.setAttribute('allow','autoplay;fullscreen;encrypted-media;picture-in-picture');
    fr.src=`https://www.youtube.com/embed/${videoId}?autoplay=1&controls=1&playsinline=1&start=${Math.floor(startTime||0)}&rel=0&enablejsapi=1&origin=${encodeURIComponent(location.origin)}`;
    wrap.style.position='relative';
    wrap.appendChild(fr);
    wpIframe=fr;wpReady=true;wpIgnore=false;wpPlaying=shouldPlay;updateWpBtns();
    return;
  }
  const div=document.createElement('div');div.id='wpyt';
  div.style.cssText='position:absolute;inset:0;width:100%;height:100%;';
  wrap.style.position='relative';
  wrap.appendChild(div);
  if(!ytReady){setTimeout(()=>createYtWP(videoId,startTime,shouldPlay),500);return;}
  wpPlayer=new YT.Player('wpyt',{width:'100%',height:'100%',videoId,
    playerVars:{autoplay:1,controls:1,rel:0,playsinline:1,fs:1,start:Math.floor(startTime||0),origin:location.origin},
    events:{
      onReady(e){wpReady=true;wpIgnore=false;if(wpPendingTime>1)e.target.seekTo(wpPendingTime,true);if(wpPendingPlay)e.target.playVideo();wpPendingPlay=false;},
      onStateChange(e){
        if(wpIgnore)return;
        if(e.data===YT.PlayerState.PAUSED&&wpPlaying){wpPlaying=false;updateWpBtns();socket.emit('watch-pause',{channelId:chIdStr(),currentTime:wpTime()});}
        if(e.data===YT.PlayerState.PLAYING&&!wpPlaying){wpPlaying=true;updateWpBtns();socket.emit('watch-play',{channelId:chIdStr(),currentTime:wpTime()});}
      }
    }
  });
}
function createIframeWP(url){
  wpReady=true;wpIframe=null;if(wpPlayer){try{wpPlayer.destroy();}catch{}wpPlayer=null;}
  const wrap=$('wp-video');wrap.innerHTML='';wrap.style.position='relative';
  wrap.innerHTML=`<iframe src="${esc(url)}" style="position:absolute;inset:0;width:100%;height:100%;border:none;" allowfullscreen allow="fullscreen;autoplay;encrypted-media" sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-presentation"></iframe>`;
}
function iframeCmd(fn,args=[]){
  if(!wpIframe)return;
  try{wpIframe.contentWindow.postMessage(JSON.stringify({event:'command',func:fn,args}),'*');}catch{}
}
function applyWpCmd(action,currentTime){
  const isPlay=action==='play'||action==='sync-play';
  wpPlaying=isPlay;updateWpBtns();
  if(wpIframe){
    iframeCmd('seekTo',[(currentTime||0)+(isPlay?.4:0),true]);
    setTimeout(()=>iframeCmd(isPlay?'playVideo':'pauseVideo'),200);
    return;
  }
  if(!wpPlayer||!wpReady){wpPendingTime=currentTime||0;wpPendingPlay=isPlay;return;}
  wpIgnore=true;
  if(isPlay){try{wpPlayer.seekTo((currentTime||0)+.3,true);wpPlayer.playVideo();}catch{}}
  else{try{wpPlayer.pauseVideo();wpPlayer.seekTo(currentTime||0,true);}catch{}}
  setTimeout(()=>wpIgnore=false,600);
}
function wpTime(){try{return wpPlayer&&wpReady?wpPlayer.getCurrentTime():0;}catch{return 0;}}
function updateWpBtns(){const t=wpPlaying?'â¸ Pausar':'â–¶ Play';$('wp-play-btn').textContent=t;}
function wpTogglePlay(){
  if(wpType==='iframe')return;
  const t=wpTime();
  if(wpPlaying)socket.emit('watch-pause',{channelId:chIdStr(),currentTime:t});
  else         socket.emit('watch-play', {channelId:chIdStr(),currentTime:t});
}
function requestSync(){socket.emit('watch-sync-request',{channelId:chIdStr()});}
function leaveWatchParty(){socket.emit('watch-stop',{channelId:chIdStr()});leaveWPLocal();}
function leaveWPLocal(){
  wpActive=false;wpVid=null;wpPlaying=false;wpType='youtube';wpIframe=null;
  if(wpPlayer){try{wpPlayer.destroy();}catch{}wpPlayer=null;wpReady=false;}
  $('wp-video').innerHTML='';
  $('wp-open-btn').classList.remove('live');$('wp-open-btn').textContent='ğŸ¬ Watch Party';
  $('mob-wp-btn').textContent='ğŸ¬';
  currentChannel?showView('chat'):showView('welcome');
}
function wpFullscreen(){
  const el=$('wp-video');
  const rq=el.requestFullscreen||el.webkitRequestFullscreen||el.mozRequestFullScreen||el.msRequestFullscreen;
  if(rq)rq.call(el);
}
// BotÃ³n FS nativo tambiÃ©n en el toolbar
document.addEventListener('fullscreenchange',()=>{
  // Si salimos de fullscreen, nada que hacer especial
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MUSIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onYouTubeIframeAPIReady(){
  ytReady=true;
  ytPlayer=new YT.Player('yt-hidden',{height:'1',width:'1',playerVars:{playsinline:1},events:{onReady:()=>ytPlayer.setVolume(80),onStateChange:()=>{}}});
}
function getBgAudio(){if(!bgAudio){bgAudio=document.createElement('audio');bgAudio.setAttribute('playsinline','');bgAudio.loop=true;bgAudio.volume=.001;document.body.appendChild(bgAudio);}return bgAudio;}
function loadSong(song){
  currentSongId=song.videoId;
  if(ytReady&&ytPlayer){ytPlayer.loadVideoById(song.videoId);ytPlayer.playVideo();}
  if('mediaSession' in navigator){
    navigator.mediaSession.metadata=new MediaMetadata({title:song.title,artist:`Pedida por ${song.requestedBy}`,artwork:[{src:song.thumbnail,sizes:'480x360',type:'image/jpeg'}]});
    navigator.mediaSession.setActionHandler('nexttrack',()=>socket.emit('send-message',{channelId:chIdStr(),content:'/skip',attachments:[]}));
  }
  const a=getBgAudio();
  if(!a.src||a.paused){a.src='data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=';a.play().catch(()=>{});}
}
function stopSong(){if(bgAudio){bgAudio.pause();}currentSongId=null;}
socket.on('music-play',song=>{
  if(String(song.channelId)!==chIdStr())return;
  $('music-bar').classList.add('on');
  $('m-title').textContent=song.title;$('m-req').textContent=`pedida por ${song.requestedBy}`;$('m-thumb').src=song.thumbnail;
  $('m-pause-btn').textContent='â¸';
  loadSong(song);
});
socket.on('music-state',s=>{
  if(String(s.channelId)!==chIdStr())return;
  if(s.current){$('music-bar').classList.add('on');$('m-title').textContent=s.current.title;$('m-req').textContent=`pedida por ${s.current.requestedBy}`;$('m-thumb').src=s.current.thumbnail;if(currentSongId!==s.current.videoId)loadSong(s.current);}
  else $('music-bar').classList.remove('on');
  $('vol-sl').value=s.volume;if(ytPlayer?.setVolume)ytPlayer.setVolume(s.volume);
});
socket.on('music-stop',  d=>{if(String(d?.channelId)!==chIdStr())return;$('music-bar').classList.remove('on');stopSong();});
socket.on('music-ended', d=>{if(String(d?.channelId)!==chIdStr())return;$('music-bar').classList.remove('on');stopSong();});
socket.on('music-pause', d=>{if(String(d?.channelId)!==chIdStr())return;$('m-pause-btn').textContent='â–¶';if(ytPlayer?.pauseVideo)ytPlayer.pauseVideo();});
socket.on('music-resume',d=>{if(String(d?.channelId)!==chIdStr())return;$('m-pause-btn').textContent='â¸';if(ytPlayer?.playVideo)ytPlayer.playVideo();});
socket.on('music-volume',d=>{if(String(d?.channelId)!==chIdStr())return;const v=d.v??d;$('vol-sl').value=v;if(ytPlayer)ytPlayer.setVolume(v);});
function togglePause(){socket.emit('send-message',{channelId:chIdStr(),content:$('m-pause-btn').textContent==='â¸'?'/pause':'/resume',attachments:[]});}
function skipSong(){socket.emit('send-message',{channelId:chIdStr(),content:'/skip',attachments:[]});}
function stopMusic(){socket.emit('send-message',{channelId:chIdStr(),content:'/stop',attachments:[]});}
function setVolume(v){socket.emit('send-message',{channelId:chIdStr(),content:`/volume ${v}`,attachments:[]});}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOICE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ICE={iceServers:[{urls:'stun:stun.l.google.com:19302'}]};
let voiceChId=null;
async function joinVoiceCh(chId){
  if(inVoice&&voiceChId===chId){leaveVoice();return;}
  if(inVoice)leaveVoice();
  try{localStream=await navigator.mediaDevices.getUserMedia({audio:true,video:false});}
  catch{alert('Sin acceso al micrÃ³fono.');return;}
  inVoice=true;voiceChId=chId;
  socket.emit('join-voice',{channelId:chId});
}
socket.on('voice-joined',({channelId})=>{
  voiceChId=channelId;
  const ch=currentServer?.channels.find(c=>String(c._id)===String(channelId));
  $('call-bar').classList.add('on');
  $('call-ch-name').textContent=ch?.name||'Voz';
  document.querySelectorAll('.v-item').forEach(e=>e.classList.remove('active'));
  $(`vi-${channelId}`)?.classList.add('active');
  sndJoin();
});
function leaveVoice(){
  inVoice=false;
  if(localStream){localStream.getTracks().forEach(t=>t.stop());localStream=null;}
  Object.values(peers).forEach(pc=>pc.close());
  Object.keys(peers).forEach(k=>delete peers[k]);
  document.getElementById('remote-audios')?.remove();
  $('call-bar').classList.remove('on');
  document.querySelectorAll('.v-item').forEach(e=>e.classList.remove('active'));
  const old=voiceChId;voiceChId=null;
  socket.emit('leave-voice');sndLeave();
}
function toggleMic(){
  if(!localStream)return;
  micMuted=!micMuted;
  localStream.getAudioTracks().forEach(t=>t.enabled=!micMuted);
  const b=$('mic-btn');b.textContent=micMuted?'ğŸ”‡':'ğŸ¤';b.classList.toggle('muted',micMuted);
  socket.emit('voice-mute',{muted:micMuted});
  micMuted?sndMute():sndUnmute();
}
socket.on('voice-users',({channelId,users})=>{
  const el=$('vu-'+channelId);if(!el)return;
  el.innerHTML=users.map(u=>`<div class="v-user"><span>ğŸ‘¤</span><span>${esc(u.username)}</span></div>`).join('');
});
socket.on('existing-peers',async ids=>{for(const id of ids)await createPC(id,true);});
socket.on('peer-joined',async({peerId})=>{sndJoin();await createPC(peerId,false);});
socket.on('peer-left',id=>{sndLeave();if(peers[id]){peers[id].close();delete peers[id];}document.getElementById('raud-'+id)?.remove();});
socket.on('offer',   async({from,offer}) =>{if(!peers[from])await createPC(from,false);await peers[from].setRemoteDescription(new RTCSessionDescription(offer));const a=await peers[from].createAnswer();await peers[from].setLocalDescription(a);socket.emit('answer',{to:from,answer:a});});
socket.on('answer',  async({from,answer})=>{if(peers[from])await peers[from].setRemoteDescription(new RTCSessionDescription(answer));});
socket.on('ice-candidate',async({from,candidate})=>{if(peers[from]&&candidate)try{await peers[from].addIceCandidate(new RTCIceCandidate(candidate));}catch{}});
async function createPC(peerId,init){
  const pc=new RTCPeerConnection(ICE);peers[peerId]=pc;
  if(localStream)localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.onicecandidate=({candidate})=>candidate&&socket.emit('ice-candidate',{to:peerId,candidate});
  pc.ontrack=e=>{
    if(!document.getElementById('remote-audios')){const c=document.createElement('div');c.id='remote-audios';c.style.display='none';document.body.appendChild(c);}
    let a=document.getElementById('raud-'+peerId);
    if(!a){a=document.createElement('audio');a.id='raud-'+peerId;a.autoplay=true;document.getElementById('remote-audios').appendChild(a);}
    a.srcObject=e.streams[0];
  };
  if(init){const o=await pc.createOffer();await pc.setLocalDescription(o);socket.emit('offer',{to:peerId,offer:o});}
  return pc;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS & SERVER SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSettings(){
  openModal('settings-modal');
  $('settings-uname').textContent=myUser?.username;
  $('cs-inp').value=myUser?.customStatus||'';
  $('status-sel').value=myUser?.status||'online';
  updateSettingsAv();
}
function updateSettingsAv(){
  const el=$('settings-av');
  if(myUser?.avatar)el.innerHTML=`<img src="${myUser.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"/>`;
  else{el.textContent=ini(myUser?.username);el.style.background=avColor(myUser?.username);}
}
async function saveSettings(){
  const cs=$('cs-inp').value;const st=$('status-sel').value;
  await apiFetch('/api/update-profile','POST',{customStatus:cs});
  socket.emit('set-status',{status:st});
  myUser.customStatus=cs;myUser.status=st;
  $('my-cs-label').textContent=cs||st;
  closeModal('settings-modal');
}
async function openServerSettings(){
  if(!currentServer)return;
  const isOwner=currentServer.members.find(m=>(m.user._id||m.user)===myUser?.id&&m.role==='owner');
  $('srv-settings-body').innerHTML=`<div style="display:flex;flex-direction:column;gap:10px;">
    <div style="font-weight:700;">${esc(currentServer.name)}</div>
    <div style="font-size:.75rem;color:var(--muted);">${currentServer.members.length} miembros</div>
    <button class="btn-ok" onclick="genInvite()">ğŸ”— Generar invitaciÃ³n</button>
    <div id="inv-link" style="font-size:.75rem;color:var(--green);word-break:break-all;"></div>
    ${isOwner?`<hr style="border-color:var(--line);"/><button class="btn-danger" onclick="if(confirm('Â¿Seguro?'))leaveServer()">Abandonar servidor</button>`:''}
    <button class="btn-cancel" onclick="closeModal('srv-settings')">Cerrar</button>
  </div>`;
  openModal('srv-settings');
}
async function genInvite(){
  const r=await apiFetch(`/api/servers/${currentServer._id}/invite`,'POST',{});
  if(r.ok){$('inv-link').textContent=r.url;navigator.clipboard?.writeText(r.url).catch(()=>{});}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INVITE LANDING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function checkInvite(){
  const m=location.pathname.match(/\/invite\/([a-zA-Z0-9_-]+)/);
  if(!m)return false;
  const code=m[1];
  const r=await fetch(`/api/invite/${code}`).then(x=>x.json());
  $('auth-screen').style.display='none';
  $('invite-screen').style.display='flex';
  if(!r.ok){$('inv-name').textContent='InvitaciÃ³n invÃ¡lida';return true;}
  $('inv-name').textContent=r.server.name;
  $('inv-members').textContent=`${r.server.memberCount} miembros`;
  $('inv-icon').innerHTML=r.server.name.slice(0,2).toUpperCase();
  window._invCode=code;
  return true;
}
async function acceptInvite(){
  const tok=localStorage.getItem('dk_token');
  if(!tok){$('invite-screen').style.display='none';$('auth-screen').style.display='flex';return;}
  const r=await fetch(`/api/invite/${window._invCode}/join`,{method:'POST',headers:{'Authorization':'Bearer '+tok,'Content-Type':'application/json'}}).then(x=>x.json());
  if(!r.ok){$('inv-err').textContent=r.error;$('inv-err').style.display='block';return;}
  const vr=await fetch('/api/verify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:tok})}).then(x=>x.json());
  $('invite-screen').style.display='none';
  enterApp(tok,vr.user);
  setTimeout(()=>selectServer(r.server._id),800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEWS & MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showView(v){
  $('v-welcome').style.display='none';
  $('v-chat').style.display='none';
  $('v-dm-panel').style.display='none';
  document.getElementById('watch-view').classList.remove('on');
  $('dm-view').classList.remove('on');
  if(v==='welcome')$('v-welcome').style.display='flex';
  else if(v==='chat'){$('v-chat').style.display='flex';$('v-chat').style.flexDirection='column';}
  else if(v==='watch'){document.getElementById('watch-view').classList.add('on');}
  else if(v==='dm-panel'){$('v-dm-panel').style.display='flex';$('v-dm-panel').style.flexDirection='column';}
  else if(v==='dm'){$('dm-view').classList.add('on');}
}
function openModal(id){$(id).classList.add('open');}
function closeModal(id){$(id).classList.remove('open');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOBILE DRAWER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleDrawer(){
  const open=!$('ch-bar').classList.contains('open');
  $('ch-bar').classList.toggle('open',open);
  $('srv-bar').classList.toggle('open',open);
  $('mob-overlay').classList.toggle('open',open);
}
function closeDrawer(){
  $('ch-bar').classList.remove('open');
  $('srv-bar').classList.remove('open');
  $('mob-overlay').classList.remove('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WAKE LOCK + SW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function requestWakeLock(){try{if('wakeLock' in navigator)await navigator.wakeLock.request('screen');}catch{}}
document.addEventListener('visibilitychange',()=>{if(document.visibilityState==='visible'){requestWakeLock();if(currentSongId&&ytPlayer?.playVideo)try{ytPlayer.playVideo();}catch{};}});
if('serviceWorker' in navigator)navigator.serviceWorker.register('/sw.js').catch(()=>{});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CREATE SERVER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function createServer(){
  const name=$('new-srv-name').value.trim();
  const desc=$('new-srv-desc').value.trim();
  const err=$('csrv-err');err.classList.remove('show');
  if(!name){err.textContent='Ponle un nombre.';err.classList.add('show');return;}
  const r=await apiFetch('/api/servers/create','POST',{name,description:desc});
  if(!r.ok){err.textContent=r.error;err.classList.add('show');return;}
  closeModal('create-server');
  $('new-srv-name').value='';$('new-srv-desc').value='';
  await loadServers();
  await selectServer(r.server._id);
}
socket.on('channel-created',()=>{if(currentServer)apiFetch(`/api/servers/${currentServer._id}`).then(r=>{if(r.ok){currentServer=r.server;renderChSidebar();}});});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load',async()=>{
  const isInv=await checkInvite();if(isInv)return;
  const tok=localStorage.getItem('dk_token');if(!tok)return;
  const r=await apiFetch('/api/verify','POST',{token:tok});
  if(r.ok)enterApp(tok,r.user);
});

// Input enter listeners (after DOM ready)
document.addEventListener('DOMContentLoaded',()=>{
  setupInputEnter('msg-inp',sendMsg);
  setupInputEnter('wp-msg-inp',sendWpMsg);
  setupInputEnter('dm-inp',sendDM);
  ['l-u','l-p'].forEach(id=>$(id)?.addEventListener('keydown',e=>e.key==='Enter'&&doLogin()));
  ['r-u','r-p'].forEach(id=>$(id)?.addEventListener('keydown',e=>e.key==='Enter'&&doRegister()));
  $('wp-url-input')?.addEventListener('keydown',e=>e.key==='Enter'&&startWP());
  // Click outside â†’ close pickers
  document.addEventListener('click',e=>{
    if(!e.target.closest('.emoji-pk')&&!e.target.closest('.inp-btn')){
      document.querySelectorAll('.emoji-pk').forEach(p=>p.classList.remove('open'));
    }
  });
});
</script>
<script src="https://www.youtube.com/iframe_api"></script>


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 1: VIBE METER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
socket.on('vibe-update',({channelId,vibe})=>{
  if(String(channelId)!==chIdStr())return;
  const fill=$('vibe-fill'); if(fill) fill.style.width=vibe+'%';
  if(fill) fill.title=`Vibe: ${vibe}/100`;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 2: PINS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let channelPins=[];
socket.on('pins-update',({channelId,pins})=>{
  if(String(channelId)!==chIdStr())return;
  channelPins=pins||[];
  const cnt=$('pins-count');
  if(cnt) cnt.textContent=channelPins.length?`(${channelPins.length})`:'';
  if(document.getElementById('pins-panel-dropdown').style.display!=='none') renderPinsPanel();
});
function togglePinsPanel(){
  const pd=$('pins-panel-dropdown');
  if(pd.style.display==='none'){pd.style.display='block';renderPinsPanel();}
  else pd.style.display='none';
}
function renderPinsPanel(){
  const pd=$('pins-panel-dropdown');
  if(!channelPins.length){pd.innerHTML='<div style="padding:10px;font-size:.78rem;color:var(--muted);">Sin mensajes fijados.</div>';return;}
  pd.innerHTML=channelPins.map(p=>`
    <div class="pin-item">
      <div class="pin-item-name">ğŸ“Œ ${esc(p.authorName)} <span style="font-weight:400;color:var(--muted);">fijado por ${esc(p.pinnedBy)}</span></div>
      <div class="pin-item-txt">${esc(p.content)}</div>
    </div>`).join('');
}
function pinMessage(msgId){
  socket.emit('pin-message',{messageId:msgId,channelId:chIdStr()});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 3: FOCUS / POMODORO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let focusInterval=null;
socket.on('focus-state',({active,endAt,label,startedBy,channelId})=>{
  if(String(channelId)!==chIdStr())return;
  if(!active){stopFocusUI();return;}
  $('focus-banner').classList.add('on');
  $('focus-label').textContent=`${label} â€” por ${startedBy}`;
  clearInterval(focusInterval);
  focusInterval=setInterval(()=>{
    const rem=Math.max(0,endAt-Date.now());
    const m=Math.floor(rem/60000), s=Math.floor((rem%60000)/1000);
    $('focus-timer').textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    if(rem<=0){clearInterval(focusInterval);stopFocusUI();}
  },1000);
});
socket.on('focus-end',({channelId,label})=>{
  if(String(channelId)!==chIdStr())return;
  stopFocusUI();
  // Beep de fin de focus
  beep(880,.15,.2);setTimeout(()=>beep(1100,.2,.2),200);setTimeout(()=>beep(880,.4,.15),450);
  appendSys(`ğŸ¯ Â¡SesiÃ³n Focus${label?' "'+label+'"':''} terminada! Buen trabajo.`);
});
function stopFocusUI(){clearInterval(focusInterval);$('focus-banner').classList.remove('on');}
function stopFocus(){socket.emit('focus-stop',{channelId:chIdStr()});}
function appendSys(txt){
  const box=$('messages'); if(!box)return;
  const d=document.createElement('div');d.className='msg-sys';d.innerHTML=txt;
  box.appendChild(d); box.scrollTop=box.scrollHeight;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 4: POLLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Polls se renderizan en appendMsg detectando __POLL__ prefix
function renderPoll(msgEl, pollId, poll){
  if(!poll)return;
  const total=poll.options.reduce((a,o)=>a+(o.count||o.votes?.length||0),0);
  msgEl.innerHTML=`<div class="poll-card">
    <div class="poll-q">ğŸ“Š ${esc(poll.question)}</div>
    ${poll.options.map((o,i)=>{
      const cnt=o.count||o.votes?.length||0;
      const pct=total?Math.round(cnt/total*100):0;
      return `<div class="poll-opt ${o.voted?'voted':''}" onclick="votePoll('${pollId}',${i})">
        <span class="poll-opt-txt">${esc(o.text)}</span>
        <div class="poll-bar-wrap"><div class="poll-bar" style="width:${pct}%"></div></div>
        <span class="poll-pct">${pct}%</span>
        <span style="font-size:.68rem;color:var(--muted);min-width:20px;">${cnt}</span>
      </div>`;
    }).join('')}
    <div style="font-size:.68rem;color:var(--muted);margin-top:5px;">${total} votos</div>
  </div>`;
}
function votePoll(pollId, optIdx){
  socket.emit('poll-vote',{pollId,optionIdx:optIdx});
}
socket.on('poll-update',({pollId,options})=>{
  // Actualizar todas las poll-cards con ese pollId
  document.querySelectorAll(`[data-poll-id="${pollId}"]`).forEach(el=>{
    const poll={question:el.dataset.pollQ,options};
    renderPoll(el,pollId,poll);
    el.dataset.pollQ=el.dataset.pollQ; // keep
  });
});

// Patch appendMsg to handle polls
const _origAppendMsg = appendMsg;
function appendMsg(msg, box){
  if(msg.content?.startsWith('__POLL__')&&msg.pollId){
    const d=document.createElement('div');
    d.className='msg-grp';
    d.style.padding='4px 12px';
    d.dataset.pollId=msg.pollId;
    d.dataset.pollQ=msg.poll?.question||'';
    renderPoll(d,msg.pollId,msg.poll);
    if(box)box.appendChild(d);
    return;
  }
  _origAppendMsg(msg,box);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 5: DICE ROLL animation
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
socket.on('dice-roll',({user,faces,result,channelId})=>{
  if(String(channelId)!==chIdStr())return;
  // Sound
  beep(result===faces?1200:result===1?300:700,.2,.15,'triangle');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 6: ALARM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let alarmAudioLoop=null;
socket.on('alarm-ring',({label,createdBy,channelId})=>{
  // Mostrar toast
  $('alarm-title').textContent=label||'â° ALARMA';
  $('alarm-by').textContent='Programada por '+createdBy;
  $('alarm-toast').classList.add('on');
  // Beep loop
  let times=0;
  alarmAudioLoop=setInterval(()=>{
    beep(880,.15,.3);setTimeout(()=>beep(1100,.15,.3),200);
    if(++times>8)clearInterval(alarmAudioLoop);
  },600);
  // VibraciÃ³n en mÃ³vil
  if(navigator.vibrate) navigator.vibrate([200,100,200,100,400]);
});
function dismissAlarm(){
  $('alarm-toast').classList.remove('on');
  clearInterval(alarmAudioLoop);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 7: COLLABORATIVE CANVAS / DRAW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cvTool='draw', cvColor='#ff4466', cvDrawing=false, cvLastX=0, cvLastY=0;
let cvCtx=null, cvEl=null;

socket.on('open-canvas',({channelId})=>{
  if(String(channelId)!==chIdStr())return;
  openCanvas();
});
socket.on('canvas-state',({channelId,strokes})=>{
  if(String(channelId)!==chIdStr())return;
  if(!cvCtx)return;
  strokes.forEach(s=>drawStroke(s));
});
socket.on('canvas-stroke',({stroke,channelId})=>{
  if(String(channelId)!==chIdStr())return;
  drawStroke(stroke);
});
socket.on('canvas-cleared',({channelId})=>{
  if(String(channelId)!==chIdStr())return;
  if(cvCtx) cvCtx.clearRect(0,0,cvEl.width,cvEl.height);
});

function openCanvas(){
  $('canvas-wrap').classList.add('open');
  cvEl=$('draw-canvas');
  cvCtx=cvEl.getContext('2d');
  // Reescalar para retina
  const dpr=window.devicePixelRatio||1;
  // Draw events
  cvEl.onmousedown=startDraw; cvEl.onmousemove=draw; cvEl.onmouseup=endDraw; cvEl.onmouseleave=endDraw;
  cvEl.ontouchstart=e=>{e.preventDefault();const t=e.touches[0];startDraw({offsetX:t.clientX-cvEl.getBoundingClientRect().left,offsetY:t.clientY-cvEl.getBoundingClientRect().top});};
  cvEl.ontouchmove=e=>{e.preventDefault();const t=e.touches[0];draw({offsetX:t.clientX-cvEl.getBoundingClientRect().left,offsetY:t.clientY-cvEl.getBoundingClientRect().top});};
  cvEl.ontouchend=endDraw;
  // Load existing strokes
  socket.emit('join-channel',{channelId:chIdStr()}); // re-request canvas-state
}
function closeCanvas(){$('canvas-wrap').classList.remove('open');}
function setCvColor(el){document.querySelectorAll('.cv-color').forEach(e=>e.classList.remove('active'));el.classList.add('active');cvColor=el.dataset.color;}
function setCvTool(tool){cvTool=tool;$('cv-draw-btn').classList.toggle('active',tool==='draw');$('cv-erase-btn').classList.toggle('active',tool==='erase');}
function clearCanvas(){socket.emit('canvas-clear',{channelId:chIdStr()});if(cvCtx)cvCtx.clearRect(0,0,cvEl.width,cvEl.height);}
function startDraw(e){cvDrawing=true;cvLastX=e.offsetX;cvLastY=e.offsetY;}
function endDraw(){cvDrawing=false;}
function draw(e){
  if(!cvDrawing||!cvCtx)return;
  const size=parseInt($('cv-size').value)||3;
  const stroke={x1:cvLastX,y1:cvLastY,x2:e.offsetX,y2:e.offsetY,color:cvTool==='erase'?'#FFFFFF':cvColor,size:cvTool==='erase'?size*4:size};
  drawStroke(stroke);
  socket.emit('canvas-stroke',{channelId:chIdStr(),stroke});
  cvLastX=e.offsetX; cvLastY=e.offsetY;
}
function drawStroke(s){
  if(!cvCtx)return;
  cvCtx.beginPath();
  cvCtx.moveTo(s.x1,s.y1);
  cvCtx.lineTo(s.x2,s.y2);
  cvCtx.strokeStyle=s.color;
  cvCtx.lineWidth=s.size||3;
  cvCtx.lineCap='round';
  cvCtx.stroke();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 8: PARTYDO â€” host-controlled shared view
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let partydoSocketId=null; // mi socket id (recibido en auth-ok si lo emitimos)
// El partydo usa type:'partydo' en watch-state
// createYtWP ya maneja type='partydo' como iframe de /partydo-view

// En watch-state handler, detectar partydo host
const _origWatchState = socket.listeners ? null : null; // patch below

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 9: CONTEXT MENU (right-click on messages)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ctxMsgId=null, ctxMsgContent='', ctxMsgAuthor='';
document.addEventListener('contextmenu',e=>{
  const msgGrp=e.target.closest('.msg-grp');
  if(!msgGrp||!msgGrp.dataset.mid)return;
  e.preventDefault();
  ctxMsgId=msgGrp.dataset.mid;
  ctxMsgContent=msgGrp.dataset.content||'';
  ctxMsgAuthor=msgGrp.querySelector('.msg-name')?.textContent||'';
  const menu=$('ctx-menu');
  const isMe=ctxMsgAuthor===myUser?.username;
  const isAdmin=isServerAdmin();
  $('ctx-edit').style.display=isMe?'flex':'none';
  $('ctx-delete').style.display=(isMe||isAdmin)?'flex':'none';
  menu.style.display='block';
  // Position
  const x=Math.min(e.clientX,window.innerWidth-160);
  const y=Math.min(e.clientY,window.innerHeight-160);
  menu.style.left=x+'px'; menu.style.top=y+'px';
});
// Long press for mobile
let longPressTO=null;
document.addEventListener('touchstart',e=>{
  const msgGrp=e.target.closest('.msg-grp');
  if(!msgGrp||!msgGrp.dataset.mid)return;
  longPressTO=setTimeout(()=>{
    ctxMsgId=msgGrp.dataset.mid;
    ctxMsgContent=msgGrp.dataset.content||'';
    ctxMsgAuthor=msgGrp.querySelector('.msg-name')?.textContent||'';
    const isMe=ctxMsgAuthor===myUser?.username;
    const isAdmin=isServerAdmin();
    $('ctx-edit').style.display=isMe?'flex':'none';
    $('ctx-delete').style.display=(isMe||isAdmin)?'flex':'none';
    const menu=$('ctx-menu');
    const t=e.touches[0];
    menu.style.display='block';
    menu.style.left=Math.min(t.clientX,window.innerWidth-160)+'px';
    menu.style.top=Math.min(t.clientY,window.innerHeight-180)+'px';
  },500);
},{passive:true});
document.addEventListener('touchend',()=>{clearTimeout(longPressTO);},{passive:true});
document.addEventListener('click',()=>{$('ctx-menu').style.display='none';$('pins-panel-dropdown').style.display='none';});
function ctxAction(action){
  $('ctx-menu').style.display='none';
  if(!ctxMsgId)return;
  if(action==='reply') startReply(ctxMsgId,ctxMsgContent);
  else if(action==='react') showRxnFor(ctxMsgId,chIdStr());
  else if(action==='pin') pinMessage(ctxMsgId);
  else if(action==='edit') editMsg(ctxMsgId);
  else if(action==='delete') deleteMsg(ctxMsgId);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 10: SNAPSHOT DOWNLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function downloadSnapshot(){
  const chId=_chId(); if(!chId)return;
  window.open(`/api/channels/${chId}/snapshot`,'_blank');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARTYDO UI â€” handle type='partydo' in watch-state
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Patch the createYtWP to handle partydo
const _origCreateYtWP = createYtWP;
function createYtWP(videoId, startTime, shouldPlay){
  // If called with null videoId and wpType==='partydo', make partydo iframe
  if(wpType==='partydo'||(!videoId&&wpType==='partydo')){
    createPartydoView();
    return;
  }
  _origCreateYtWP(videoId, startTime, shouldPlay);
}
function createPartydoView(){
  wpReady=true; wpIframe=null;
  if(wpPlayer){try{wpPlayer.destroy();}catch{}wpPlayer=null;}
  const wrap=$('wp-video'); wrap.innerHTML=''; wrap.style.position='relative';
  wrap.innerHTML=`<iframe src="/partydo-view" style="position:absolute;inset:0;width:100%;height:100%;border:none;"
    allow="fullscreen;autoplay;encrypted-media"
    sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-presentation allow-top-navigation-by-user-activation">
  </iframe>`;
  // Solo el host puede parar â€” ocultar botÃ³n pause para los demÃ¡s
  // (el host es quien emitiÃ³ /partydo, sabemos por partydoHost en watch-state)
}

// Override watch-state socket handler to detect partydo
socket.on('watch-state',({channelId,active,type,videoId,url,title,playing,currentTime,lastSync,partydoHost})=>{
  const myCh=chIdStr();
  if(channelId&&myCh&&String(channelId)!==myCh)return;
  if(!active){if(wpActive)leaveWPLocal();return;}
  const isNew=!wpActive||wpVid!==videoId||wpType!==type;
  wpActive=true; wpVid=videoId; wpType=type; wpPlaying=playing;
  const elapsed=playing?(Date.now()-lastSync)/1000:0;
  const syncTime=Math.max(0,(currentTime||0)+elapsed);
  $('wp-title-bar').textContent=title||'Watch Party';
  updateWpBtns();
  $('wp-open-btn').classList.add('live'); $('wp-open-btn').textContent='ğŸ”´ LIVE';
  if($('mob-wp-btn')) $('mob-wp-btn').textContent='ğŸ”´';
  if(isNew){
    if(type==='partydo') createPartydoView();
    else if(type==='iframe') createIframeWP(url);
    else createYtWP(videoId,syncTime,playing);
  }
  // Ocultar play/pause si es partydo (no controlable por no-host)
  const playBtn=$('wp-play-btn');
  if(type==='partydo'&&playBtn) playBtn.style.display='none';
  else if(playBtn) playBtn.style.display='';
  showView('watch');
  const msgs=$('messages');
  const wpMsgs=$('wp-messages');
  if(wpMsgs&&msgs) wpMsgs.innerHTML=msgs.innerHTML;
});

<!-- Canvas draw overlay -->
<div class="canvas-wrap" id="canvas-wrap">
  <div class="canvas-toolbar">
    <span style="font-size:.78rem;color:var(--muted);font-family:'Space Mono',monospace;">ğŸ¨ PIZARRA</span>
    <div id="cv-colors" style="display:flex;gap:4px;">
      <div class="cv-color active" style="background:#ff4466;" data-color="#ff4466" onclick="setCvColor(this)"></div>
      <div class="cv-color" style="background:#39ffc0;" data-color="#39ffc0" onclick="setCvColor(this)"></div>
      <div class="cv-color" style="background:#a8d8ff;" data-color="#a8d8ff" onclick="setCvColor(this)"></div>
      <div class="cv-color" style="background:#ffd166;" data-color="#ffd166" onclick="setCvColor(this)"></div>
      <div class="cv-color" style="background:#c084fc;" data-color="#c084fc" onclick="setCvColor(this)"></div>
      <div class="cv-color" style="background:#ffffff;" data-color="#ffffff" onclick="setCvColor(this)"></div>
      <div class="cv-color" style="background:#000000;" data-color="#000000" onclick="setCvColor(this)"></div>
    </div>
    <input type="range" min="1" max="20" value="3" id="cv-size" style="width:60px;accent-color:var(--ice);"/>
    <button class="cv-btn active" id="cv-draw-btn" onclick="setCvTool('draw')">âœï¸ Dibujar</button>
    <button class="cv-btn" id="cv-erase-btn" onclick="setCvTool('erase')">â¬œ Borrar</button>
    <button class="cv-btn" onclick="clearCanvas()">ğŸ—‘ Limpiar</button>
    <button class="cv-btn" onclick="closeCanvas()">âœ• Cerrar</button>
  </div>
  <canvas id="draw-canvas" width="900" height="500"></canvas>
  <div style="font-size:.7rem;color:var(--muted);">Todos en el canal pueden dibujar en tiempo real</div>
</div>

<!-- Alarm toast -->
<div class="alarm-toast" id="alarm-toast">
  <div style="font-size:2rem;">â°</div>
  <div class="alarm-title" id="alarm-title">ALARMA</div>
  <div style="font-size:.75rem;color:var(--muted);" id="alarm-by"></div>
  <button class="btn-ok" style="margin-top:6px;padding:6px 20px;" onclick="dismissAlarm()">OK</button>
</div>

<!-- Context menu -->
<div id="ctx-menu">
  <div class="ctx-item" id="ctx-reply" onclick="ctxAction('reply')">â†© Responder</div>
  <div class="ctx-item" id="ctx-react" onclick="ctxAction('react')">ğŸ˜Š Reaccionar</div>
  <div class="ctx-item" id="ctx-pin" onclick="ctxAction('pin')">ğŸ“Œ Fijar mensaje</div>
  <div class="ctx-item" id="ctx-edit" onclick="ctxAction('edit')" style="display:none;">âœï¸ Editar</div>
  <div class="ctx-item danger" id="ctx-delete" onclick="ctxAction('delete')" style="display:none;">ğŸ—‘ Eliminar</div>
</div>

<script src="/socket.io/socket.io.js"></script>
</body>
</html>
