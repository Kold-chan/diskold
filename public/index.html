<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,viewport-fit=cover"/>
<meta name="theme-color" content="#0a0a0c"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<title>Diskold</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#0a0a0c;--bg2:#111114;--bg3:#18181d;--bg4:#202027;
  --line:#2a2a35;--ice:#a8d8ff;--icedim:#3a6080;--cold:#4fc3f7;
  --red:#ff4466;--green:#39ffc0;--gold:#ffd166;--purple:#c084fc;
  --blue:#60a5fa;--text:#e8eaf0;--muted:#6b6b80;--r:8px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;width:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;-webkit-font-smoothing:antialiased;}
::-webkit-scrollbar{width:4px;} ::-webkit-scrollbar-thumb{background:var(--line);border-radius:4px;}

/* â•â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#auth-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);z-index:300;padding:20px;}
.auth-card{width:100%;max-width:360px;background:var(--bg2);border:1px solid var(--line);border-radius:16px;padding:28px 24px;display:flex;flex-direction:column;gap:12px;}
.auth-logo{text-align:center;font-family:'Bebas Neue',sans-serif;font-size:2.6rem;letter-spacing:6px;color:var(--ice);}
.auth-sub{text-align:center;font-size:.68rem;color:var(--muted);letter-spacing:2px;font-family:'Space Mono',monospace;}
.auth-tabs{display:flex;background:var(--bg3);border-radius:var(--r);padding:3px;gap:2px;}
.auth-tab{flex:1;padding:7px;border-radius:6px;border:none;background:none;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;cursor:pointer;transition:all .2s;}
.auth-tab.active{background:var(--bg4);color:var(--text);}
.auth-field{display:flex;flex-direction:column;gap:4px;}
.auth-label{font-size:.65rem;color:var(--muted);font-family:'Space Mono',monospace;letter-spacing:1px;text-transform:uppercase;}
.auth-input{background:var(--bg3);border:1px solid var(--line);border-radius:var(--r);padding:10px 13px;font-family:'DM Sans',sans-serif;font-size:.9rem;color:var(--text);outline:none;width:100%;}
.auth-input:focus{border-color:var(--icedim);}
.auth-input::placeholder{color:var(--muted);}
.btn-auth{background:var(--ice);border:none;border-radius:var(--r);padding:12px;font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:3px;color:#0a0a0c;cursor:pointer;}
.btn-auth:hover{opacity:.85;}
.auth-err{font-size:.75rem;color:var(--red);display:none;font-family:'Space Mono',monospace;padding:6px 10px;background:rgba(255,68,102,.07);border-radius:6px;border:1px solid rgba(255,68,102,.15);}
.auth-err.show{display:block;}

/* â•â•â• APP LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app{display:none;height:100dvh;width:100%;position:fixed;inset:0;flex-direction:row;}

/* â•â•â• SERVER SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.srv-bar{width:56px;background:#070709;display:flex;flex-direction:column;align-items:center;padding:6px 0;gap:2px;flex-shrink:0;overflow-y:auto;overflow-x:hidden;}
.srv-btn{width:40px;height:40px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;flex-shrink:0;overflow:hidden;border:none;color:var(--muted);font-size:.95rem;position:relative;}
.srv-btn:hover,.srv-btn.active{border-radius:14px;background:var(--ice);color:#0a0a0c;}
.srv-btn.active::before{content:'';position:absolute;left:-4px;top:50%;transform:translateY(-50%);width:4px;height:20px;background:var(--ice);border-radius:0 4px 4px 0;}
.srv-btn img{width:100%;height:100%;object-fit:cover;}
.srv-btn.dm{background:var(--bg3);color:var(--green);}
.srv-btn.dm:hover,.srv-btn.dm.active{background:var(--green);color:#0a0a0c;border-radius:14px;}
.srv-btn.add{color:var(--green);}
.srv-btn.add:hover{background:var(--green);color:#0a0a0c;border-radius:14px;}
.srv-div{width:32px;height:1px;background:var(--line);margin:3px 0;flex-shrink:0;}
.srv-badge{position:absolute;top:-3px;right:-3px;background:var(--red);color:#fff;border-radius:10px;font-size:.55rem;padding:1px 4px;font-weight:700;border:2px solid #070709;min-width:16px;text-align:center;}

/* â•â•â• CHANNEL SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ch-bar{width:220px;background:var(--bg2);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;}
.ch-bar-head{padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;min-height:46px;}
.ch-bar-name{font-weight:700;font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
.ch-bar-body{flex:1;overflow-y:auto;padding:6px 0;}
.ch-sec{padding:12px 10px 3px;font-size:.65rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;font-family:'Space Mono',monospace;display:flex;align-items:center;justify-content:space-between;}
.ch-sec button{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.95rem;line-height:1;}
.ch-sec button:hover{color:var(--text);}
.ch-item{padding:4px 6px 4px 10px;border-radius:6px;margin:0 5px;cursor:pointer;display:flex;align-items:center;gap:6px;color:var(--muted);font-size:.85rem;transition:all .15s;min-height:30px;}
.ch-item:hover{background:var(--bg3);color:var(--text);}
.ch-item.active{background:var(--bg4);color:var(--text);}
.ch-item .sym{font-size:.75rem;opacity:.7;flex-shrink:0;}
.ch-item .nm{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.ch-item .unread{background:var(--red);color:#fff;border-radius:10px;font-size:.6rem;padding:1px 4px;font-weight:700;margin-left:auto;}
.v-item{padding:4px 6px 4px 10px;margin:0 5px;border-radius:6px;cursor:pointer;color:var(--muted);font-size:.85rem;transition:all .15s;}
.v-item:hover{background:var(--bg3);color:var(--text);}
.v-item.active{color:var(--green);}
.v-head{display:flex;align-items:center;gap:6px;}
.v-users{padding:2px 0 2px 18px;display:flex;flex-direction:column;gap:1px;}
.v-user{display:flex;align-items:center;gap:5px;font-size:.75rem;color:var(--muted);padding:1px 0;}
.ch-bar-foot{padding:7px;background:#0c0c10;border-top:1px solid var(--line);display:flex;align-items:center;gap:7px;}
.foot-av{width:30px;height:30px;border-radius:50%;flex-shrink:0;cursor:pointer;overflow:hidden;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;position:relative;}
.foot-av img{width:100%;height:100%;object-fit:cover;}
.sdot{position:absolute;bottom:0;right:0;width:9px;height:9px;border-radius:50%;border:2px solid #0c0c10;}
.s-online{background:var(--green);} .s-away{background:var(--gold);} .s-dnd{background:var(--red);} .s-offline{background:var(--muted);}
.foot-info{flex:1;overflow:hidden;}
.foot-name{font-size:.8rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.foot-cs{font-size:.65rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.foot-btn{background:none;border:none;color:var(--muted);cursor:pointer;padding:3px;border-radius:4px;font-size:.85rem;}
.foot-btn:hover{color:var(--text);}
.call-bar{background:#0a1e0d;border-top:1px solid rgba(57,255,192,.2);padding:7px 10px;display:none;align-items:center;gap:7px;flex-shrink:0;}
.call-bar.on{display:flex;}
.call-info{flex:1;}
.call-ch{color:var(--green);font-weight:600;font-size:.78rem;}
.call-st{color:var(--muted);font-size:.65rem;}
.call-btns{display:flex;gap:4px;}
.call-btn{background:rgba(255,255,255,.05);border:none;border-radius:5px;color:var(--text);cursor:pointer;padding:4px 7px;font-size:.78rem;transition:all .2s;}
.call-btn:hover{background:rgba(255,255,255,.1);}
.call-btn.muted,.call-btn.danger{background:rgba(255,68,102,.15);color:var(--red);}

/* â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}
.topbar{height:46px;border-bottom:1px solid var(--line);display:flex;align-items:center;padding:0 12px;gap:8px;flex-shrink:0;}
.topbar-ch{font-weight:700;font-size:.88rem;display:flex;align-items:center;gap:5px;}
.topbar-ch .sym{color:var(--muted);font-size:.8rem;}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:4px;}
.tb-btn{background:none;border:none;color:var(--muted);cursor:pointer;padding:4px 6px;border-radius:6px;font-size:.82rem;transition:all .2s;display:flex;align-items:center;gap:3px;white-space:nowrap;}
.tb-btn:hover{background:var(--bg3);color:var(--text);}
.tb-btn.live{background:rgba(192,132,252,.1);border:1px solid var(--purple);color:var(--purple);}

/* â•â•â• MESSAGES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.msgs{flex:1;overflow-y:auto;padding:10px 0;}
.msg-grp{padding:2px 12px;display:flex;gap:10px;position:relative;}
.msg-grp:hover{background:rgba(255,255,255,.015);}
.msg-grp:hover .msg-acts{opacity:1;}
.av{width:34px;height:34px;border-radius:50%;flex-shrink:0;margin-top:2px;overflow:hidden;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:.78rem;font-weight:700;}
.av img,.av-sm img{width:100%;height:100%;object-fit:cover;}
.av.bot-av{background:#2a2000;color:var(--gold);}
.msg-body{flex:1;min-width:0;}
.msg-head{display:flex;align-items:baseline;gap:6px;margin-bottom:1px;}
.msg-name{font-weight:600;font-size:.85rem;cursor:pointer;}
.msg-name:hover{text-decoration:underline;}
.msg-name.bot{color:var(--gold);}
.msg-time{font-size:.65rem;color:var(--muted);font-family:'Space Mono',monospace;}
.msg-ed{font-size:.62rem;color:var(--muted);font-style:italic;}
.msg-txt{font-size:.88rem;line-height:1.5;word-break:break-word;white-space:pre-wrap;}
.msg-txt.del{color:var(--muted);font-style:italic;}
.msg-reply{background:var(--bg3);border-left:3px solid var(--muted);border-radius:0 5px 5px 0;padding:3px 7px;margin-bottom:3px;font-size:.75rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.reactions{display:flex;flex-wrap:wrap;gap:3px;margin-top:3px;}
.rxn{display:flex;align-items:center;gap:2px;background:var(--bg3);border:1px solid var(--line);border-radius:10px;padding:1px 6px;cursor:pointer;font-size:.78rem;transition:all .2s;}
.rxn:hover,.rxn.mine{background:rgba(96,165,250,.1);border-color:var(--blue);}
.rxn span{font-size:.68rem;color:var(--muted);font-family:'Space Mono',monospace;}
/* Attachments */
.attach-img{max-width:300px;max-height:220px;border-radius:8px;margin-top:5px;cursor:pointer;display:block;}
.attach-file{display:inline-flex;align-items:center;gap:7px;background:var(--bg3);border:1px solid var(--line);border-radius:8px;padding:7px 10px;margin-top:5px;text-decoration:none;color:var(--text);font-size:.8rem;}
.attach-file:hover{border-color:var(--icedim);}
.attach-file .ficon{font-size:1.2rem;}
.attach-file .finfo{display:flex;flex-direction:column;}
.attach-file .fname{font-weight:600;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.attach-file .fsize{font-size:.65rem;color:var(--muted);}
.msg-acts{position:absolute;right:12px;top:-12px;background:var(--bg3);border:1px solid var(--line);border-radius:7px;display:flex;gap:1px;padding:2px;opacity:0;transition:opacity .15s;z-index:10;}
.act-btn{background:none;border:none;color:var(--muted);cursor:pointer;padding:3px 5px;border-radius:4px;font-size:.78rem;transition:all .15s;}
.act-btn:hover{background:var(--bg4);color:var(--text);}
.act-btn.danger:hover{color:var(--red);}
.msg-sys{padding:3px 12px;text-align:center;font-size:.72rem;color:var(--muted);}

/* â•â•â• TYPING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.typing{height:18px;padding:0 12px;font-size:.72rem;color:var(--muted);font-style:italic;display:flex;align-items:center;gap:5px;flex-shrink:0;}
.tdots{display:flex;gap:2px;}
.tdots span{width:3px;height:3px;border-radius:50%;background:var(--muted);animation:td 1.2s infinite;}
.tdots span:nth-child(2){animation-delay:.2s;} .tdots span:nth-child(3){animation-delay:.4s;}
@keyframes td{0%,80%,100%{opacity:.3;transform:scale(.8);}40%{opacity:1;transform:scale(1);}}

/* â•â•â• INPUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.inp-area{padding:0 12px 10px;flex-shrink:0;}
.reply-bar{background:var(--bg3);border-radius:7px 7px 0 0;padding:5px 10px;display:none;align-items:center;gap:7px;border-bottom:1px solid var(--line);}
.reply-bar.on{display:flex;}
.reply-txt{flex:1;font-size:.75rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.reply-x{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.9rem;}
.inp-wrap{background:var(--bg3);border-radius:7px;display:flex;align-items:flex-end;gap:6px;padding:5px 10px;border:1px solid var(--line);transition:border-color .2s;}
.inp-wrap:focus-within{border-color:var(--icedim);}
.inp-btn{background:none;border:none;color:var(--muted);cursor:pointer;padding:3px;border-radius:4px;font-size:.9rem;flex-shrink:0;line-height:1;}
.inp-btn:hover{color:var(--text);}
.msg-inp{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:'DM Sans',sans-serif;font-size:.88rem;resize:none;min-height:22px;max-height:110px;overflow-y:auto;line-height:1.4;align-self:center;}
.msg-inp::placeholder{color:var(--muted);}
.send-btn{background:var(--ice);border:none;border-radius:5px;color:#0a0a0c;cursor:pointer;padding:3px 8px;font-size:.8rem;font-weight:700;flex-shrink:0;line-height:22px;}
.send-btn:hover{opacity:.85;}
.cmd-hint{font-size:.62rem;color:var(--muted);padding:2px 0 0 2px;}

/* â•â•â• EMOJI PICKER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.emoji-pk{position:absolute;bottom:68px;left:12px;background:var(--bg3);border:1px solid var(--line);border-radius:10px;padding:8px;display:none;flex-wrap:wrap;gap:3px;width:220px;z-index:50;box-shadow:0 8px 24px rgba(0,0,0,.5);}
.emoji-pk.open{display:flex;}
.epk-btn{background:none;border:none;cursor:pointer;font-size:1.25rem;padding:3px;border-radius:4px;}
.epk-btn:hover{background:var(--bg4);}

/* â•â•â• MUSIC BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.music-bar{background:var(--bg2);border-top:1px solid var(--line);padding:7px 12px;display:none;align-items:center;gap:8px;flex-shrink:0;}
.music-bar.on{display:flex;}
.m-thumb{width:34px;height:34px;border-radius:5px;object-fit:cover;flex-shrink:0;}
.m-info{flex:1;min-width:0;}
.m-title{font-size:.8rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.m-req{font-size:.65rem;color:var(--muted);}
.m-btns{display:flex;gap:4px;align-items:center;}
.m-btn{background:none;border:none;color:var(--muted);cursor:pointer;padding:3px;border-radius:4px;font-size:.85rem;}
.m-btn:hover{color:var(--text);}
.vol-sl{width:55px;accent-color:var(--ice);}

/* â•â•â• WATCH PARTY â€” TWITCH LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#watch-view{display:none;flex:1;flex-direction:column;overflow:hidden;}
#watch-view.on{display:flex;}
/* Video arriba (40% altura en mÃ³vil, 60% en desktop) */
.wp-video{background:#000;flex-shrink:0;position:relative;overflow:hidden;}
.wp-video iframe,.wp-video>div{position:absolute;inset:0;width:100%;height:100%;border:none;}
.wp-toolbar{display:flex;align-items:center;gap:6px;padding:6px 10px;background:var(--bg2);border-bottom:1px solid var(--line);flex-shrink:0;}
.wp-title{flex:1;font-size:.8rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.wp-btn{background:var(--bg3);border:1px solid var(--line);border-radius:5px;color:var(--text);cursor:pointer;padding:4px 10px;font-size:.75rem;font-family:'Space Mono',monospace;transition:all .2s;}
.wp-btn:hover{border-color:var(--purple);color:var(--purple);}
.wp-btn.red:hover{border-color:var(--red);color:var(--red);}
/* Chat debajo del video en WP */
.wp-chat{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0;}

/* â•â•â• MEMBER PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.member-panel{width:220px;background:var(--bg2);border-left:1px solid var(--line);display:none;flex-direction:column;overflow:hidden;flex-shrink:0;}
.member-panel.open{display:flex;}
.mp-head{padding:12px;border-bottom:1px solid var(--line);font-size:.75rem;font-family:'Space Mono',monospace;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}
.mp-body{flex:1;overflow-y:auto;padding:8px 0;}
.mp-sec{padding:8px 12px 3px;font-size:.63rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;font-family:'Space Mono',monospace;}
.mp-user{display:flex;align-items:center;gap:8px;padding:5px 10px;border-radius:6px;margin:0 4px;cursor:pointer;transition:background .15s;}
.mp-user:hover{background:var(--bg3);}
.mp-av{width:30px;height:30px;border-radius:50%;background:var(--bg3);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:700;overflow:hidden;position:relative;}
.mp-av img{width:100%;height:100%;object-fit:cover;}
.mp-info{flex:1;min-width:0;}
.mp-name{font-size:.82rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.mp-role{font-size:.62rem;color:var(--muted);}
.mp-sdot{position:absolute;bottom:0;right:0;width:9px;height:9px;border-radius:50%;border:2px solid var(--bg2);}

/* â•â•â• DM / FRIENDS PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dm-panel{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.dm-panel-head{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px;flex-shrink:0;font-weight:700;font-size:.88rem;}
.dm-panel-search{background:var(--bg3);border:1px solid var(--line);border-radius:var(--r);padding:7px 10px;font-family:'DM Sans',sans-serif;font-size:.82rem;color:var(--text);outline:none;width:100%;}
.dm-panel-search::placeholder{color:var(--muted);}
.dm-panel-search:focus{border-color:var(--icedim);}
.dm-list-item{display:flex;align-items:center;gap:8px;padding:6px 10px;cursor:pointer;border-radius:6px;margin:1px 5px;transition:background .15s;}
.dm-list-item:hover{background:var(--bg3);}
.dm-list-item .av-sm{width:30px;height:30px;border-radius:50%;background:var(--bg3);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:700;overflow:hidden;}
.dm-list-item .dm-name{font-size:.82rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.dm-list-item .dm-preview{font-size:.7rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.dm-tabs{display:flex;border-bottom:1px solid var(--line);flex-shrink:0;}
.dm-tab{flex:1;padding:9px 0;background:none;border:none;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;position:relative;}
.dm-tab.active{color:var(--text);border-bottom-color:var(--ice);}
.dm-tab .badge{position:absolute;top:5px;right:16px;background:var(--red);color:#fff;border-radius:10px;font-size:.6rem;padding:0 4px;font-weight:700;}
.friend-item{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:6px;margin:1px 5px;}
.friend-item .av-sm{width:30px;height:30px;border-radius:50%;background:var(--bg3);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:700;overflow:hidden;}
.friend-item .fi-info{flex:1;min-width:0;}
.friend-item .fi-name{font-size:.82rem;font-weight:600;}
.friend-item .fi-status{font-size:.68rem;color:var(--muted);}
.friend-item .fi-btns{display:flex;gap:4px;}
.fi-btn{background:var(--bg3);border:1px solid var(--line);border-radius:5px;color:var(--muted);cursor:pointer;padding:3px 7px;font-size:.72rem;transition:all .2s;}
.fi-btn:hover{color:var(--text);border-color:var(--icedim);}
.fi-btn.ok:hover{border-color:var(--green);color:var(--green);}
.fi-btn.no:hover{border-color:var(--red);color:var(--red);}
.add-friend-wrap{padding:10px 10px 5px;}

/* â•â•â• DM CONVERSATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#dm-view{display:none;flex:1;flex-direction:column;overflow:hidden;}
#dm-view.on{display:flex;}
.dm-head{height:46px;border-bottom:1px solid var(--line);display:flex;align-items:center;padding:0 12px;gap:8px;flex-shrink:0;}
.dm-av{width:26px;height:26px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:.68rem;font-weight:700;overflow:hidden;flex-shrink:0;}

/* â•â•â• WELCOME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.welcome{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;color:var(--muted);text-align:center;padding:40px;}
.welcome h2{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:4px;color:var(--ice);}
.welcome p{font-size:.82rem;max-width:280px;line-height:1.6;}

/* â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:200;padding:16px;backdrop-filter:blur(4px);}
.overlay.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--line);border-radius:14px;padding:24px 20px;width:100%;max-width:400px;display:flex;flex-direction:column;gap:12px;box-shadow:0 20px 60px rgba(0,0,0,.6);}
.modal-title{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:3px;}
.modal-sub{font-size:.75rem;color:var(--muted);line-height:1.5;}
.modal-inp{background:var(--bg3);border:1px solid var(--line);border-radius:var(--r);padding:10px 13px;font-family:'DM Sans',sans-serif;font-size:.88rem;color:var(--text);outline:none;width:100%;}
.modal-inp:focus{border-color:var(--icedim);}
.modal-err{font-size:.72rem;color:var(--red);display:none;font-family:'Space Mono',monospace;}
.modal-err.show{display:block;}
.modal-btns{display:flex;gap:7px;justify-content:flex-end;}
.btn-cancel{background:none;border:1px solid var(--line);border-radius:var(--r);padding:7px 14px;color:var(--muted);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.85rem;}
.btn-cancel:hover{color:var(--text);}
.btn-ok{background:var(--ice);border:none;border-radius:var(--r);padding:7px 16px;color:#0a0a0c;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:700;}
.btn-ok:hover{opacity:.85;}
.btn-danger{background:var(--red);border:none;border-radius:var(--r);padding:7px 14px;color:#fff;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:700;}

/* â•â•â• INVITE SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#invite-screen{position:fixed;inset:0;background:var(--bg);display:none;align-items:center;justify-content:center;z-index:250;padding:20px;}
.inv-card{background:var(--bg2);border:1px solid var(--line);border-radius:16px;padding:28px 24px;max-width:360px;width:100%;text-align:center;display:flex;flex-direction:column;align-items:center;gap:12px;}
.inv-icon{width:64px;height:64px;border-radius:18px;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:1.8rem;overflow:hidden;}

/* â•â•â• MOBILE TOPBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mob-top{display:none;height:46px;background:var(--bg2);border-bottom:1px solid var(--line);align-items:center;padding:0 10px;gap:8px;flex-shrink:0;}
.mob-menu{background:none;border:none;color:var(--text);cursor:pointer;font-size:1rem;padding:3px;}
.mob-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:90;}
.mob-overlay.open{display:block;}

/* â•â•â• IMAGE LIGHTBOX â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.lightbox{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:400;cursor:pointer;}
.lightbox.open{display:flex;}
.lightbox img{max-width:95vw;max-height:95vh;border-radius:8px;object-fit:contain;}

@media(max-width:768px){
  .srv-bar{position:fixed;left:0;top:0;bottom:0;z-index:101;width:56px;transform:translateX(-100%);transition:transform .25s;}
  .srv-bar.open{transform:translateX(0);}
  .ch-bar{position:fixed;left:56px;top:0;bottom:0;z-index:100;width:220px;transform:translateX(calc(-100% - 56px));transition:transform .25s;}
  .ch-bar.open{transform:translateX(0);}
  .mob-top{display:flex;}
  .topbar{display:none;}
  .member-panel{display:none!important;}
  #app{height:100dvh;}
  .wp-video{height:38vh!important;}
  /* En watch party, el chat del canal va debajo del video */
  #watch-view .wp-chat .msgs{flex:1;}
}

/* â”€â”€ MINIJUEGOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.game-overlay{position:fixed;inset:0;background:rgba(0,0,0,.93);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:900;gap:10px;padding:16px;overflow-y:auto;}
.game-overlay.on{display:flex;}
.game-box{background:var(--bg2);border:1px solid var(--line);border-radius:14px;padding:16px;display:flex;flex-direction:column;align-items:center;gap:10px;width:100%;max-width:480px;}
.game-title{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:4px;color:var(--ice);}
.game-score-bar{font-family:'Space Mono',monospace;font-size:.75rem;color:var(--muted);display:flex;gap:14px;flex-wrap:wrap;justify-content:center;}
.game-btn{background:var(--bg3);border:1px solid var(--line);border-radius:8px;color:var(--text);cursor:pointer;padding:7px 14px;font-size:.82rem;transition:all .2s;}
.game-btn:hover{border-color:var(--ice);color:var(--ice);}
.game-btn.prim{background:var(--ice);color:#0a0a0c;border:none;font-weight:700;}
/* Snake */
#snake-canvas{border-radius:6px;display:block;image-rendering:pixelated;}
/* Trivia */
.trivia-q{font-size:.92rem;font-weight:600;text-align:center;line-height:1.5;margin-bottom:6px;}
.trivia-opts{display:grid;grid-template-columns:1fr 1fr;gap:7px;width:100%;}
.trivia-opt{background:var(--bg3);border:1px solid var(--line);border-radius:8px;padding:10px;cursor:pointer;font-size:.8rem;text-align:center;transition:all .2s;line-height:1.3;}
.trivia-opt:hover{border-color:var(--ice);}
.trivia-opt.correct{border-color:var(--green)!important;background:rgba(57,255,192,.1);color:var(--green);}
.trivia-opt.wrong{border-color:var(--red)!important;background:rgba(255,68,102,.1);color:var(--red);}
.trivia-opt.revealed{border-color:var(--green)!important;background:rgba(57,255,192,.08);}
/* Wordle */
.wordle-grid{display:flex;flex-direction:column;gap:4px;margin:6px 0;}
.wordle-row{display:flex;gap:4px;}
.wordle-cell{width:42px;height:42px;border:2px solid var(--line);border-radius:6px;display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:1.3rem;transition:all .3s;}
.wordle-cell.correct{background:#2d5a27;border-color:var(--green);}
.wordle-cell.present{background:#5a4a10;border-color:var(--gold);}
.wordle-cell.absent{background:var(--bg3);border-color:var(--muted);color:var(--muted);}
.wordle-cell.active{border-color:var(--ice);}
.wordle-kb{display:flex;flex-direction:column;gap:4px;align-items:center;}
.wordle-kb-row{display:flex;gap:3px;}
.wordle-key{background:var(--bg3);border:1px solid var(--line);border-radius:4px;color:var(--text);cursor:pointer;padding:7px 6px;font-size:.72rem;font-family:'Space Mono',monospace;min-width:26px;text-align:center;transition:background .3s;}
.wordle-key.correct{background:#2d5a27;border-color:var(--green);}
.wordle-key.present{background:#5a4a10;border-color:var(--gold);}
.wordle-key.absent{background:#111;color:var(--muted);}
/* Type Race */
.typerace-text{font-size:.88rem;line-height:1.8;font-family:'Space Mono',monospace;padding:10px 14px;background:var(--bg3);border-radius:8px;width:100%;word-break:break-word;letter-spacing:.5px;}
.typerace-char.correct{color:var(--green);}
.typerace-char.wrong{color:var(--red);text-decoration:underline;}
.typerace-char.cursor{border-left:2px solid var(--ice);}
</style>
</head>
<body>

<!-- â•â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">DISKOLD</div>
    <div class="auth-sub">by Kold</div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="showTab('login')">Iniciar sesiÃ³n</button>
      <button class="auth-tab"        onclick="showTab('register')">Registrarse</button>
    </div>
    <div id="tab-login" style="display:flex;flex-direction:column;gap:10px;">
      <div class="auth-field"><label class="auth-label">Usuario</label>
        <input class="auth-input" id="l-u" placeholder="tu_usuario" autocomplete="username" autocorrect="off" autocapitalize="off"/></div>
      <div class="auth-field"><label class="auth-label">ContraseÃ±a</label>
        <input class="auth-input" id="l-p" type="password" placeholder="â€¢â€¢â€¢â€¢" autocomplete="current-password"/></div>
      <div class="auth-err" id="l-err"></div>
      <button class="btn-auth" onclick="doLogin()">ENTRAR</button>
    </div>
    <div id="tab-register" style="display:none;flex-direction:column;gap:10px;">
      <div class="auth-field"><label class="auth-label">Usuario</label>
        <input class="auth-input" id="r-u" placeholder="tu_usuario" autocomplete="username" autocorrect="off" autocapitalize="off"/></div>
      <div class="auth-field"><label class="auth-label">ContraseÃ±a</label>
        <input class="auth-input" id="r-p" type="password" placeholder="mÃ­nimo 4 caracteres" autocomplete="new-password"/></div>
      <div class="auth-err" id="r-err"></div>
      <button class="btn-auth" onclick="doRegister()">CREAR CUENTA</button>
    </div>
  </div>
</div>

<!-- â•â•â• INVITE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="invite-screen">
  <div class="inv-card">
    <div class="inv-icon" id="inv-icon">ğŸ”—</div>
    <div style="font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:3px;" id="inv-name">...</div>
    <div style="font-size:.78rem;color:var(--muted);" id="inv-members"></div>
    <div class="auth-err" id="inv-err"></div>
    <button class="btn-auth" onclick="acceptInvite()">UNIRME</button>
    <button class="btn-cancel" onclick="document.getElementById('invite-screen').style.display='none';document.getElementById('auth-screen').style.display='flex'">Tengo cuenta â†’ Login</button>
  </div>
</div>

<!-- â•â•â• APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">

  <!-- Server bar -->
  <div class="srv-bar" id="srv-bar">
    <div class="srv-btn dm" id="dm-btn" onclick="openDMPanel()" title="DMs & Amigos">ğŸ’¬
      <div class="srv-badge" id="friend-req-badge" style="display:none;">0</div>
    </div>
    <div class="srv-div"></div>
    <div id="srv-list"></div>
    <div class="srv-div"></div>
    <div class="srv-btn add" onclick="openModal('create-server')" title="Crear servidor">ï¼‹</div>
  </div>

  <!-- Channel bar -->
  <div class="ch-bar" id="ch-bar">
    <div class="ch-bar-head">
      <span class="ch-bar-name" id="srv-name-label">Diskold</span>
      <button class="foot-btn" onclick="openServerSettings()" title="Ajustes">âš™ï¸</button>
    </div>
    <div class="ch-bar-body" id="ch-body">
      <div style="padding:16px 10px;font-size:.78rem;color:var(--muted);">Elige un servidor</div>
    </div>
    <div class="call-bar" id="call-bar">
      <div class="call-info">
        <div class="call-ch" id="call-ch-name">Voz</div>
        <div class="call-st">ğŸŸ¢ Conectado</div>
      </div>
      <div class="call-btns">
        <button class="call-btn" id="mic-btn" onclick="toggleMic()">ğŸ¤</button>
        <button class="call-btn danger" onclick="leaveVoice()">ğŸ“µ</button>
      </div>
    </div>
    <div class="ch-bar-foot">
      <div class="foot-av" id="my-av" onclick="openSettings()">
        <span id="my-av-ini">?</span>
        <div class="sdot s-online" id="my-sdot"></div>
      </div>
      <div class="foot-info">
        <div class="foot-name" id="my-name-label">â€”</div>
        <div class="foot-cs"  id="my-cs-label">online</div>
      </div>
      <button class="foot-btn" onclick="openSettings()">âš™ï¸</button>
    </div>
  </div>

  <!-- Main area -->
  <div class="main" id="main">

    <!-- Mobile topbar -->
    <div class="mob-top">
      <button class="mob-menu" onclick="toggleDrawer()">â˜°</button>
      <span style="font-weight:700;font-size:.85rem;" id="mob-title">Diskold</span>
      <div style="margin-left:auto;display:flex;gap:4px;">
        <button class="tb-btn" onclick="openWatchModal()" id="mob-wp-btn">ğŸ¬</button>
        <button class="tb-btn" onclick="openGamesMenu()">ğŸ®</button>
        <button class="tb-btn" onclick="toggleMemberPanel()">ğŸ‘¥</button>
      </div>
    </div>
    <div class="mob-overlay" id="mob-overlay" onclick="closeDrawer()"></div>

    <!-- Views -->
    <div class="welcome" id="v-welcome">
      <h2>DISKOLD</h2>
      <p>Crea un servidor o Ãºnete a uno con un enlace de invitaciÃ³n.</p>
      <button class="btn-ok" style="margin-top:8px;" onclick="openModal('create-server')">Crear servidor</button>
    </div>

    <!-- DM Panel (friends & conversations) -->
    <div id="v-dm-panel" style="display:none;flex:1;flex-direction:column;overflow:hidden;">
      <div class="dm-panel-head">ğŸ’¬ Mensajes & Amigos</div>
      <div class="dm-tabs">
        <button class="dm-tab active" id="dmt-chats" onclick="showDMTab('chats')">Conversaciones</button>
        <button class="dm-tab" id="dmt-friends" onclick="showDMTab('friends')">Amigos</button>
        <button class="dm-tab" id="dmt-requests" onclick="showDMTab('requests')">
          Solicitudes<span class="badge" id="req-badge" style="display:none;">0</span>
        </button>
      </div>
      <div style="flex:1;overflow-y:auto;" id="dm-panel-body"></div>
    </div>

    <!-- Chat view -->
    <div id="v-chat" style="display:none;flex:1;flex-direction:column;overflow:hidden;">
      <div class="topbar">
        <span class="topbar-ch"><span class="sym" id="ch-sym">#</span><span id="ch-name-top">general</span></span>
        <div class="topbar-right">
          <button class="tb-btn" id="wp-open-btn" onclick="openWatchModal()">ğŸ¬ Watch Party</button>
          <button class="tb-btn" onclick="openGamesMenu()" title="Minijuegos">ğŸ®</button>
          <button class="tb-btn" onclick="toggleMemberPanel()">ğŸ‘¥</button>
        </div>
      </div>
      <div class="msgs" id="messages"></div>
      <div class="typing" id="typing-bar" style="display:none;">
        <div class="tdots"><span></span><span></span><span></span></div>
        <span id="typing-txt"></span>
      </div>
      <div class="music-bar" id="music-bar">
        <img class="m-thumb" id="m-thumb" src="" alt=""/>
        <div class="m-info">
          <div class="m-title" id="m-title">â€”</div>
          <div class="m-req" id="m-req"></div>
        </div>
        <div class="m-btns">
          <button class="m-btn" id="m-pause-btn" onclick="togglePause()">â¸</button>
          <button class="m-btn" onclick="skipSong()">â­</button>
          <button class="m-btn" onclick="stopMusic()">â¹</button>
          <input type="range" class="vol-sl" id="vol-sl" min="0" max="100" value="80" oninput="setVolume(this.value)"/>
        </div>
      </div>
      <div style="position:relative;">
        <div class="emoji-pk" id="emoji-pk"></div>
      </div>
      <div class="inp-area">
        <div class="reply-bar" id="reply-bar">
          <span style="font-size:.72rem;color:var(--muted);">â†© Respondiendo a</span>
          <span class="reply-txt" id="reply-txt"></span>
          <button class="reply-x" onclick="cancelReply()">âœ•</button>
        </div>
        <div class="inp-wrap">
          <button class="inp-btn" onclick="toggleEmoji()">ğŸ˜Š</button>
          <button class="inp-btn" onclick="document.getElementById('file-input').click()" title="Adjuntar">ğŸ“</button>
          <input type="file" id="file-input" style="display:none;" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip"/>
          <textarea class="msg-inp" id="msg-inp" placeholder="Escribe un mensaje..." rows="1" maxlength="2000"
            autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="text"></textarea>
          <button class="send-btn" onclick="sendMsg()">â–¶</button>
        </div>
        <div class="cmd-hint">/play /watch /partydo /skip /stop /pause /help</div>
      </div>
    </div>

    <!-- Watch Party view (Twitch layout: video top, chat bottom) -->
    <div id="watch-view">
      <div class="wp-video" id="wp-video" style="height:55vh;"></div>
      <div class="wp-toolbar">
        <button class="wp-btn" id="wp-play-btn" onclick="wpTogglePlay()">â–¶ Play</button>
        <button class="wp-btn" onclick="requestSync()">âŸ³ Sync</button>
        <span class="wp-title" id="wp-title-bar">â€”</span>
        <button class="wp-btn" onclick="wpFullscreen()">â›¶ FS</button>
        <button class="wp-btn red" onclick="leaveWatchParty()">âœ• Salir</button>
      </div>
      <!-- Chat debajo del video -->
      <div class="wp-chat" id="wp-chat">
        <div class="msgs" id="wp-messages"></div>
        <div class="typing" id="wp-typing-bar" style="display:none;">
          <div class="tdots"><span></span><span></span><span></span></div>
          <span id="wp-typing-txt"></span>
        </div>
        <div style="position:relative;">
          <div class="emoji-pk" id="wp-emoji-pk"></div>
        </div>
        <div class="inp-area">
          <div class="inp-wrap">
            <button class="inp-btn" onclick="toggleWpEmoji()">ğŸ˜Š</button>
            <button class="inp-btn" onclick="document.getElementById('wp-file-input').click()">ğŸ“</button>
            <input type="file" id="wp-file-input" style="display:none;" multiple accept="image/*,.pdf,.doc,.txt"/>
            <textarea class="msg-inp" id="wp-msg-inp" placeholder="Chat del Watch Party..." rows="1" maxlength="2000"
              autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="text"></textarea>
            <button class="send-btn" onclick="sendWpMsg()">â–¶</button>
          </div>
        </div>
      </div>
    </div>

    <!-- DM Conversation -->
    <div id="dm-view">
      <div class="dm-head">
        <div class="dm-av" id="dm-with-av"></div>
        <span style="font-weight:700;font-size:.88rem;" id="dm-with-name">â€”</span>
        <div style="margin-left:auto;">
          <button class="tb-btn" onclick="closeDMConv()">â† Volver</button>
        </div>
      </div>
      <div class="msgs" id="dm-messages"></div>
      <div style="position:relative;"><div class="emoji-pk" id="dm-emoji-pk"></div></div>
      <div class="inp-area">
        <div class="inp-wrap">
          <button class="inp-btn" onclick="toggleDmEmoji()">ğŸ˜Š</button>
          <button class="inp-btn" onclick="document.getElementById('dm-file-input').click()">ğŸ“</button>
          <input type="file" id="dm-file-input" style="display:none;" multiple accept="image/*,.pdf,.doc,.txt"/>
          <textarea class="msg-inp" id="dm-inp" placeholder="EnvÃ­a un mensaje..." rows="1" maxlength="2000"
            autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="text"></textarea>
          <button class="send-btn" onclick="sendDM()">â–¶</button>
        </div>
      </div>
    </div>

  </div><!-- /main -->

  <!-- Member panel (derecha) -->
  <div class="member-panel" id="member-panel">
    <div class="mp-head" id="mp-head-title">Miembros</div>
    <div class="mp-body" id="mp-body"></div>
  </div>

</div><!-- /app -->

<!-- â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Create Server -->
<div class="overlay" id="create-server" onclick="if(event.target===this)closeModal('create-server')">
  <div class="modal">
    <div class="modal-title" style="color:var(--ice);">CREAR SERVIDOR</div>
    <div class="modal-sub">Se crearÃ¡n canales de texto y voz automÃ¡ticamente.</div>
    <input class="modal-inp" id="new-srv-name" placeholder="Nombre del servidor" maxlength="50" autocomplete="off" autocorrect="off"/>
    <input class="modal-inp" id="new-srv-desc" placeholder="DescripciÃ³n (opcional)" maxlength="200" autocomplete="off"/>
    <div class="modal-err" id="csrv-err"></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('create-server')">Cancelar</button>
      <button class="btn-ok" onclick="createServer()">CREAR</button>
    </div>
  </div>
</div>

<!-- Watch Party -->
<div class="overlay" id="watch-modal" onclick="if(event.target===this)closeModal('watch-modal')">
  <div class="modal">
    <div class="modal-title" style="color:var(--purple);">ğŸ¬ WATCH PARTY</div>
    <div class="modal-sub">Pega un link de YouTube â€” todos en el canal verÃ¡n el video sincronizado.</div>
    <input class="modal-inp" id="wp-url-input" placeholder="https://www.youtube.com/watch?v=..." autocomplete="off" spellcheck="false" inputmode="url"/>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('watch-modal')">Cancelar</button>
      <button class="btn-ok" onclick="startWP()">INICIAR</button>
    </div>
  </div>
</div>

<!-- Settings -->
<div class="overlay" id="settings-modal" onclick="if(event.target===this)closeModal('settings-modal')">
  <div class="modal">
    <div class="modal-title" style="color:var(--ice);">MI PERFIL</div>
    <div style="display:flex;align-items:center;gap:12px;">
      <div style="width:56px;height:56px;border-radius:50%;background:var(--bg3);overflow:hidden;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.3rem;font-weight:700;flex-shrink:0;" id="settings-av" onclick="document.getElementById('av-file').click()"></div>
      <div>
        <div style="font-weight:700;" id="settings-uname"></div>
        <div style="font-size:.72rem;color:var(--muted);">Clic para cambiar avatar</div>
      </div>
    </div>
    <input type="file" id="av-file" accept="image/*" style="display:none;"/>
    <div class="auth-field">
      <label class="auth-label">Estado personalizado</label>
      <input class="modal-inp" id="cs-inp" placeholder="Jugando a algo..." maxlength="60" autocomplete="off"/>
    </div>
    <div class="auth-field">
      <label class="auth-label">Estado</label>
      <select class="modal-inp" id="status-sel">
        <option value="online">ğŸŸ¢ Online</option>
        <option value="away">ğŸŸ¡ Ausente</option>
        <option value="dnd">ğŸ”´ No molestar</option>
        <option value="offline">âš« Invisible</option>
      </select>
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('settings-modal')">Cerrar</button>
      <button class="btn-ok" onclick="saveSettings()">GUARDAR</button>
    </div>
  </div>
</div>

<!-- Server Settings -->
<div class="overlay" id="srv-settings" onclick="if(event.target===this)closeModal('srv-settings')">
  <div class="modal">
    <div class="modal-title" style="color:var(--gold);">âš™ï¸ SERVIDOR</div>
    <div id="srv-settings-body"></div>
  </div>
</div>

<!-- Image lightbox -->
<div class="lightbox" id="lightbox" onclick="document.getElementById('lightbox').classList.remove('open')">
  <img id="lightbox-img" src="" alt=""/>
</div>

<div id="yt-hidden" style="display:none;position:absolute;width:1px;height:1px;"></div>
<script src="/socket.io/socket.io.js"></script>
<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DISKOLD v4.2 Frontend
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const socket = io();

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let myToken=null, myUser=null;
let currentServer=null, currentChannel=null;
let dmWithId=null, dmWithUser=null;
let inVoice=false, micMuted=false;
let localStream=null; const peers={};
let memberPanelOpen=false;
// Watch Party
let wpActive=false, wpType='youtube', wpVid=null, wpPlaying=false;
let wpIframe=null, wpPlayer=null, wpReady=false;
let wpPendingPlay=false, wpPendingTime=0, wpIgnore=false;
// Reply
let replyToId=null;
// Typing
let typingUsers={}, typingTO=null;
// Music
let ytPlayer=null, ytReady=false, bgAudio=null, currentSongId=null;
let unread={};
// Friends
let friendsList=[], friendRequests=[];

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $  = id => document.getElementById(id);
const esc = s => s?s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'):'';
const ini = n => n?n.slice(0,2).toUpperCase():'??';
const AV_COLORS = ['#3a6080','#2d4a22','#4a1f2d','#1f3a4a','#3a2d1f','#2d1f4a'];
const avColor = n => AV_COLORS[n?n.charCodeAt(0)%AV_COLORS.length:0];
const fmtTime = d => new Date(d).toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'});
const fmtSize = b => b>1e6?`${(b/1e6).toFixed(1)} MB`:`${Math.round(b/1024)} KB`;
const bold    = t => t.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');
const _chId   = () => currentChannel?._id||currentChannel?.id||null;
const chIdStr = () => String(_chId()||'');

function makeAvEl(name, avatar, cls='av'){
  if(avatar) return `<div class="${cls}"><img src="${esc(avatar)}" alt=""/></div>`;
  return `<div class="${cls}" style="background:${avColor(name)}">${ini(name)}</div>`;
}
function apiFetch(url, method='GET', body=null){
  const tok = myToken||localStorage.getItem('dk_token')||'';
  const opts = {method, headers:{'Content-Type':'application/json','Authorization':'Bearer '+tok}};
  if(body) opts.body=JSON.stringify(body);
  return fetch(url,opts).then(r=>r.json()).catch(()=>({ok:false,error:'Error de red'}));
}

// â”€â”€ Audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _actx=null;
function getACtx(){if(!_actx)_actx=new(window.AudioContext||window.webkitAudioContext)();if(_actx.state==='suspended')_actx.resume();return _actx;}
function beep(f=440,d=.12,v=.13,t='sine'){try{const c=getACtx(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type=t;o.frequency.value=f;g.gain.setValueAtTime(v,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+d);o.start();o.stop(c.currentTime+d);}catch{}}
const sndJoin   = ()=>{beep(880,.08,.1);setTimeout(()=>beep(1100,.1,.1),90);};
const sndLeave  = ()=>{beep(660,.08,.1);setTimeout(()=>beep(440,.1,.1),90);};
const sndMute   = ()=>beep(300,.15,.09,'square');
const sndUnmute = ()=>{beep(600,.08,.09);setTimeout(()=>beep(800,.08,.09),80);};
const sndMsg    = ()=>beep(1200,.05,.04);
const sndMention= ()=>{beep(900,.1,.18);setTimeout(()=>beep(1200,.15,.18),120);};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTab(t){
  $('tab-login').style.display   = t==='login'   ?'flex':'none';
  $('tab-register').style.display= t==='register'?'flex':'none';
  document.querySelectorAll('.auth-tab').forEach((b,i)=>b.classList.toggle('active',i===(t==='login'?0:1)));
}
async function doLogin(){
  const u=$('l-u').value.trim(), p=$('l-p').value;
  $('l-err').classList.remove('show');
  if(!u||!p){$('l-err').textContent='Completa los campos.';$('l-err').classList.add('show');return;}
  const r=await apiFetch('/api/login','POST',{username:u,password:p});
  if(!r.ok){$('l-err').textContent=r.error;$('l-err').classList.add('show');return;}
  enterApp(r.token,r.user);
}
async function doRegister(){
  const u=$('r-u').value.trim(), p=$('r-p').value;
  $('r-err').classList.remove('show');
  if(!u||!p){$('r-err').textContent='Completa los campos.';$('r-err').classList.add('show');return;}
  const r=await apiFetch('/api/register','POST',{username:u,password:p});
  if(!r.ok){$('r-err').textContent=r.error;$('r-err').classList.add('show');return;}
  enterApp(r.token,r.user);
}
function enterApp(token,user){
  myToken=token; myUser=user;
  localStorage.setItem('dk_token',token);
  $('auth-screen').style.display='none';
  $('app').style.display='flex';
  $('my-name-label').textContent=user.username;
  $('my-cs-label').textContent=user.customStatus||'online';
  renderMyAv();
  socket.emit('auth',token);
  loadServers();
  loadFriends();
  setupFileInputs();
  requestWakeLock();
  setupEmojiPickers();
}
function renderMyAv(){
  const el=$('my-av'), ini_el=$('my-av-ini');
  if(myUser?.avatar){el.innerHTML=`<img src="${myUser.avatar}" alt=""/><div class="sdot s-${myUser.status||'online'}" id="my-sdot"></div>`;}
  else{ini_el.textContent=ini(myUser?.username);el.style.background=avColor(myUser?.username);el.innerHTML+=`<div class="sdot s-${myUser.status||'online'}" id="my-sdot"></div>`;}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadServers(){
  const r=await apiFetch('/api/servers');
  if(!r.ok)return;
  renderSrvList(r.servers);
}
function renderSrvList(srvs){
  $('srv-list').innerHTML=srvs.map(s=>`
    <div class="srv-btn ${currentServer?._id===String(s._id)?'active':''}"
         id="sb-${s._id}" onclick="selectServer('${s._id}')" title="${esc(s.name)}" style="margin:2px 0;">
      ${s.icon?`<img src="${s.icon}" alt=""/>`:`<span style="font-size:.68rem;font-weight:700;font-family:'Space Mono',monospace;">${s.name.slice(0,2).toUpperCase()}</span>`}
    </div>`).join('');
}
async function selectServer(srvId){
  const r=await apiFetch(`/api/servers/${srvId}`);
  if(!r.ok){return;}
  currentServer=r.server;
  $('srv-name-label').textContent=currentServer.name;
  socket.emit('join-server',{serverId:srvId});
  renderChSidebar();
  document.querySelectorAll('.srv-btn').forEach(b=>b.classList.remove('active'));
  $(`sb-${srvId}`)?.classList.add('active');
  $('v-dm-panel').style.display='none';
  showView('welcome');
}
function renderChSidebar(){
  if(!currentServer)return;
  const textChs  = currentServer.channels.filter(c=>c.type==='text');
  const voiceChs = currentServer.channels.filter(c=>c.type==='voice');
  const isAdmin  = currentServer.members.find(m=>(m.user._id||m.user)===myUser?.id&&['owner','admin'].includes(m.role));
  $('ch-body').innerHTML=`
    <div class="ch-sec">Texto ${isAdmin?`<button onclick="addChannel('text')">ï¼‹</button>`:''}</div>
    ${textChs.map(c=>`<div class="ch-item ${String(currentChannel?._id)===String(c._id)?'active':''}" id="ci-${c._id}" onclick="selectChannel('${c._id}')">
      <span class="sym">#</span><span class="nm">${esc(c.name)}</span>
      ${unread[c._id]?`<span class="unread">${unread[c._id]}</span>`:''}
    </div>`).join('')}
    <div class="ch-sec" style="margin-top:6px;">Voz ${isAdmin?`<button onclick="addChannel('voice')">ï¼‹</button>`:''}</div>
    ${voiceChs.map(c=>`<div class="v-item ${voiceChId===String(c._id)?'active':''}" id="vi-${c._id}" onclick="joinVoiceCh('${c._id}')">
      <div class="v-head"><span>${voiceChId===String(c._id)?'ğŸ”Š':'ğŸ”ˆ'}</span><span>${esc(c.name)}</span></div>
      <div class="v-users" id="vu-${c._id}"></div>
    </div>`).join('')}`;
}
async function selectChannel(chId){
  const ch = currentServer.channels.find(c=>String(c._id)===String(chId)||String(c.id)===String(chId));
  if(!ch||ch.type!=='text')return;
  currentChannel=ch;
  if(!ch._id)ch._id=chId;
  unread[String(chId)]=0;
  document.querySelectorAll('.ch-item').forEach(e=>e.classList.remove('active'));
  $(`ci-${chId}`)?.classList.add('active');
  $('ch-name-top').textContent=ch.name;
  $('mob-title').textContent='# '+ch.name;
  $('ch-sym').textContent='#';
  $('msg-inp').placeholder=`Escribe en #${ch.name}...`;
  showView('chat');
  $('messages').innerHTML='';
  socket.emit('join-channel',{channelId:String(chId)});
  closeDrawer();
  renderMemberPanel();
}
function addChannel(type){
  const name=prompt(`Nombre del canal de ${type==='text'?'texto':'voz'}:`);
  if(!name?.trim())return;
  apiFetch(`/api/servers/${currentServer._id}/channels`,'POST',{name:name.trim(),type}).then(async ()=>{
    const r=await apiFetch(`/api/servers/${currentServer._id}`);
    if(r.ok){currentServer=r.server;renderChSidebar();}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
socket.on('channel-history',({channelId,messages})=>{
  if(String(channelId)!==chIdStr())return;
  const box=$('messages');
  box.innerHTML='';
  messages.forEach(m=>appendMsg(m,box));
  box.scrollTop=box.scrollHeight;
  // TambiÃ©n rellenar WP chat si estamos en WP
  if(wpActive){const wb=$('wp-messages');wb.innerHTML='';messages.forEach(m=>appendMsg(m,wb));wb.scrollTop=wb.scrollHeight;}
});

socket.on('new-message',msg=>{
  const msgChId=String(msg.channelId||'');
  const myCh=chIdStr();
  if(msgChId&&myCh&&msgChId===myCh){
    appendMsg(msg,$('messages'));
    $('messages').scrollTop=$('messages').scrollHeight;
    if(wpActive){appendMsg(msg,$('wp-messages'));$('wp-messages').scrollTop=$('wp-messages').scrollHeight;}
    if(msg.authorName!==myUser?.username){
      msg.content?.includes('@'+myUser?.username)?sndMention():sndMsg();
    }
  } else if(msgChId){
    unread[msgChId]=(unread[msgChId]||0)+1;
    if(currentServer)renderChSidebar();
  }
});

function appendMsg(msg, box){
  if(!box)return;
  if(msg.type==='system'||(!msg.author&&!msg.authorName)){
    const d=document.createElement('div');d.className='msg-sys';d.textContent=msg.content||'';
    box.appendChild(d);return;
  }
  const isBot=msg.type==='bot';
  const isMe=String(msg.author)===String(myUser?.id);
  const d=document.createElement('div');
  d.className='msg-grp';
  d.dataset.mid=msg._id||'';
  d.dataset.content=msg.content||'';

  const avHtml=isBot
    ?`<div class="av bot-av">ğŸ¤–</div>`
    :makeAvEl(msg.authorName||'?',msg.authorAvatar);

  const replyHtml=msg.replyPreview
    ?`<div class="msg-reply">â†© ${esc(msg.replyPreview)}</div>`:'';

  const rxnHtml=(msg.reactions||[]).filter(r=>r.users?.length>0).map(r=>`
    <div class="rxn ${r.users.map(String).includes(String(myUser?.id))?'mine':''}"
         onclick="reactMsg('${msg._id}','${r.emoji}','${chIdStr()}')">
      ${r.emoji}<span>${r.users.length}</span>
    </div>`).join('');

  // Attachments
  const attHtml=(msg.attachments||[]).map(a=>{
    const isImg=a.mimetype?.startsWith('image/');
    if(isImg) return `<img class="attach-img" src="/api/files/${a.fileId}" alt="${esc(a.filename)}" onclick="openLightbox(this.src)"/>`;
    return `<a class="attach-file" href="/api/files/${a.fileId}" download="${esc(a.filename)}" target="_blank">
      <span class="ficon">ğŸ“„</span>
      <span class="finfo"><span class="fname">${esc(a.filename)}</span><span class="fsize">${fmtSize(a.size||0)}</span></span>
    </a>`;
  }).join('');

  const actsHtml=`<div class="msg-acts">
    <button class="act-btn" onclick="startReply('${msg._id}','${esc((msg.content||'').slice(0,60))}')">â†©</button>
    <button class="act-btn" onclick="showRxnFor('${msg._id}','${chIdStr()}')">ğŸ˜Š</button>
    ${isMe?`<button class="act-btn" onclick="editMsg('${msg._id}')">âœï¸</button>`:''}
    ${isMe||isServerAdmin()?`<button class="act-btn danger" onclick="deleteMsg('${msg._id}')">ğŸ—‘</button>`:''}
  </div>`;

  d.innerHTML=`${actsHtml}${avHtml}<div class="msg-body">
    <div class="msg-head">
      <span class="msg-name${isBot?' bot':''}" onclick="showUserCtx(event,'${msg.authorName||''}','${msg.authorAvatar||''}','${msg.author||''}')">${esc(msg.authorName||'')}</span>
      <span class="msg-time">${fmtTime(msg.createdAt)}</span>
      ${msg.edited?`<span class="msg-ed">(editado)</span>`:''}
    </div>
    ${replyHtml}
    <div class="msg-txt${msg.deleted?' del':''}">${bold(esc(msg.content||''))}</div>
    ${attHtml}
    <div class="reactions">${rxnHtml}</div>
  </div>`;
  box.appendChild(d);
}

function isServerAdmin(){
  if(!currentServer||!myUser)return false;
  const m=currentServer.members.find(m=>(m.user._id||m.user)===myUser.id||(m.user._id||m.user)===String(myUser.id));
  return m&&['owner','admin'].includes(m.role);
}

// â”€â”€ Send Message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendMsg(){
  const el=$('msg-inp');
  const content=el.value.trim();
  const chId=_chId();
  if(!chId)return;
  if(!content&&!pendingFiles.length)return;
  // Upload files first
  const attachments=await uploadFiles(pendingFiles);
  pendingFiles=[];
  clearFilePreview();
  socket.emit('send-message',{channelId:String(chId),content,replyToId,attachments});
  el.value='';el.style.height='auto';
  cancelReply();
  socket.emit('typing-stop',{channelId:String(chId)});
}

function sendWpMsg(){
  const el=$('wp-msg-inp');
  const content=el.value.trim();
  const chId=_chId();
  if(!content||!chId)return;
  socket.emit('send-message',{channelId:String(chId),content,replyToId:null,attachments:[]});
  el.value='';
}

// â”€â”€ File Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pendingFiles=[];
function setupFileInputs(){
  ['file-input','wp-file-input','dm-file-input'].forEach(id=>{
    const el=$(id);if(!el)return;
    el.addEventListener('change',async e=>{
      const files=Array.from(e.target.files);
      if(id==='dm-file-input') await sendDMFiles(files);
      else { pendingFiles=[...pendingFiles,...files]; showFilePreview(); }
      el.value='';
    });
  });
  $('av-file')?.addEventListener('change',async e=>{
    const file=e.target.files[0]; if(!file)return;
    if(file.size>3*1024*1024){alert('MÃ¡x 3MB para avatares');return;}
    const b64=await toBase64(file);
    myUser.avatar=b64;
    await apiFetch('/api/update-profile','POST',{avatar:b64});
    renderMyAv();updateSettingsAv();
    e.target.value='';
  });
}
function toBase64(file){
  return new Promise(res=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.readAsDataURL(file);});
}
async function uploadFiles(files){
  const results=[];
  for(const file of files){
    if(file.size>10*1024*1024){alert(`${file.name}: mÃ¡x 10MB`);continue;}
    const data=await toBase64(file);
    const r=await apiFetch('/api/upload','POST',{filename:file.name,mimetype:file.type,data});
    if(r.ok) results.push({fileId:r.fileId,filename:r.filename,mimetype:r.mimetype,size:r.size});
  }
  return results;
}
async function sendDMFiles(files){
  const attachments=await uploadFiles(files);
  if(!attachments.length)return;
  socket.emit('send-dm',{toUserId:dmWithId,content:'',attachments});
}
function showFilePreview(){
  let bar=$('file-preview-bar');
  if(!bar){bar=document.createElement('div');bar.id='file-preview-bar';bar.style.cssText='padding:4px 12px;display:flex;gap:6px;flex-wrap:wrap;';$('inp-area').prepend?$('v-chat').querySelector('.inp-area').prepend(bar):null;}
  if(bar)bar.innerHTML=pendingFiles.map((f,i)=>`<span style="background:var(--bg3);border:1px solid var(--line);border-radius:5px;padding:3px 8px;font-size:.72rem;display:flex;gap:4px;align-items:center;">${esc(f.name)}<button onclick="pendingFiles.splice(${i},1);showFilePreview();" style="background:none;border:none;color:var(--muted);cursor:pointer;">âœ•</button></span>`).join('');
}
function clearFilePreview(){const b=$('file-preview-bar');if(b)b.innerHTML='';}

// â”€â”€ Typing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupInputEnter(inputId, sendFn){
  const el=$(inputId);if(!el)return;
  el.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendFn();return;}
    const chId=_chId();
    if(chId){
      socket.emit('typing-start',{channelId:String(chId)});
      clearTimeout(typingTO);
      typingTO=setTimeout(()=>socket.emit('typing-stop',{channelId:String(chId)}),3000);
    }
  });
  el.addEventListener('input',()=>{el.style.height='auto';el.style.height=Math.min(el.scrollHeight,110)+'px';});
}
socket.on('typing',({userId,username,channelId})=>{
  if(String(channelId)!==chIdStr()||userId===myUser?.id)return;
  if(!typingUsers[channelId])typingUsers[channelId]={};
  typingUsers[channelId][userId]={username};
  updateTyping(channelId);
});
socket.on('typing-stop',({userId,channelId})=>{
  if(typingUsers[channelId])delete typingUsers[channelId][userId];
  updateTyping(channelId);
});
function updateTyping(cid){
  const isCurrent=String(cid)===chIdStr();
  const barId=isCurrent?(wpActive?'wp-typing-bar':'typing-bar'):'typing-bar';
  const txtId=isCurrent?(wpActive?'wp-typing-txt':'typing-txt'):'typing-txt';
  const bar=$(barId),txt=$(txtId);
  const names=Object.values(typingUsers[cid]||{}).map(u=>u.username);
  if(!names.length||!bar){bar&&(bar.style.display='none');return;}
  bar.style.display='flex';
  txt.textContent=names.length===1?`${names[0]} estÃ¡ escribiendo...`:names.length<4?`${names.join(', ')} estÃ¡n escribiendo...`:'Varios estÃ¡n escribiendo...';
}

// â”€â”€ Reply â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startReply(id,preview){replyToId=id;$('reply-bar').classList.add('on');$('reply-txt').textContent=preview;$('msg-inp').focus();}
function cancelReply(){replyToId=null;$('reply-bar').classList.remove('on');}

// â”€â”€ Reactions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EMOJIS=['ğŸ‘','â¤ï¸','ğŸ˜‚','ğŸ˜®','ğŸ˜¢','ğŸ”¥','ğŸ‰','ğŸ’¯','ğŸ‘','âœ…','ğŸ’€','ğŸ¤™','ğŸ˜','ğŸ«¡','ğŸ’ª'];
function setupEmojiPickers(){
  ['emoji-pk','wp-emoji-pk','dm-emoji-pk'].forEach(id=>{
    const el=$(id);if(!el)return;
    el.innerHTML=EMOJIS.map(e=>`<button class="epk-btn" onclick="insertEmoji('${e}','${id}')">${e}</button>`).join('');
  });
}
function insertEmoji(e,pkId){
  const inp=pkId==='emoji-pk'?$('msg-inp'):pkId==='wp-emoji-pk'?$('wp-msg-inp'):$('dm-inp');
  if(inp){inp.value+=e;inp.focus();}
  $(pkId).classList.remove('open');
}
function toggleEmoji(){$('emoji-pk').classList.toggle('open');}
function toggleWpEmoji(){$('wp-emoji-pk').classList.toggle('open');}
function toggleDmEmoji(){$('dm-emoji-pk').classList.toggle('open');}
function showRxnFor(msgId,chId){
  // Mini picker para reaccionar a un mensaje
  let pk=$('rxn-picker');
  if(!pk){pk=document.createElement('div');pk.id='rxn-picker';pk.style.cssText='position:fixed;background:var(--bg3);border:1px solid var(--line);border-radius:10px;padding:7px;display:flex;flex-wrap:wrap;gap:3px;width:200px;z-index:60;box-shadow:0 8px 24px rgba(0,0,0,.5);';document.body.appendChild(pk);}
  pk.innerHTML=EMOJIS.map(e=>`<button class="epk-btn" onclick="reactMsg('${msgId}','${e}','${chId}');document.getElementById('rxn-picker').remove();">${e}</button>`).join('');
  const msg=document.querySelector(`[data-mid="${msgId}"]`);
  if(msg){const r=msg.getBoundingClientRect();pk.style.top=(r.top-130)+'px';pk.style.left=r.left+'px';}
  setTimeout(()=>document.addEventListener('click',()=>pk.remove(),{once:true}),100);
}
function reactMsg(messageId,emoji,channelId){socket.emit('react',{messageId,emoji,channelId});}
socket.on('reaction-update',({messageId,reactions})=>{
  document.querySelectorAll(`[data-mid="${messageId}"] .reactions`).forEach(el=>{
    el.innerHTML=reactions.filter(r=>r.users?.length>0).map(r=>`
      <div class="rxn ${r.users.map(String).includes(String(myUser?.id))?'mine':''}"
           onclick="reactMsg('${messageId}','${r.emoji}','${chIdStr()}')">
        ${r.emoji}<span>${r.users.length}</span>
      </div>`).join('');
  });
});

// â”€â”€ Edit / Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function editMsg(msgId){
  const el=document.querySelector(`[data-mid="${msgId}"] .msg-txt`);if(!el)return;
  const orig=document.querySelector(`[data-mid="${msgId}"]`).dataset.content;
  const ta=document.createElement('textarea');ta.value=orig;ta.className='msg-inp';ta.style.cssText='width:100%;resize:none;min-height:36px;background:var(--bg4);border:1px solid var(--icedim);border-radius:5px;padding:4px 8px;';
  el.replaceWith(ta);ta.focus();
  ta.addEventListener('keydown',async e=>{
    if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();await apiFetch(`/api/messages/${msgId}`,'PATCH',{content:ta.value.trim()});ta.replaceWith(el);el.textContent=ta.value.trim();}
    if(e.key==='Escape')ta.replaceWith(el);
  });
}
socket.on('message-edited',({messageId,content})=>{
  document.querySelectorAll(`[data-mid="${messageId}"] .msg-txt`).forEach(el=>el.textContent=content);
});
async function deleteMsg(msgId){
  if(!confirm('Â¿Eliminar?'))return;
  await apiFetch(`/api/messages/${msgId}`,'DELETE');
}
socket.on('message-deleted',({messageId})=>{
  document.querySelectorAll(`[data-mid="${messageId}"] .msg-txt`).forEach(el=>{el.textContent='Mensaje eliminado';el.classList.add('del');});
});

// â”€â”€ User context â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showUserCtx(e,username,avatar,userId){
  document.getElementById('user-popup')?.remove();
  if(!username||!userId||userId==='undefined')return;
  const isFriend=friendsList.some(f=>String(f._id||f)===String(userId));
  const isMe=String(userId)===String(myUser?.id);
  const popup=document.createElement('div');
  popup.id='user-popup';
  popup.style.cssText='position:fixed;background:var(--bg2);border:1px solid var(--line);border-radius:10px;width:200px;z-index:150;box-shadow:0 8px 24px rgba(0,0,0,.6);overflow:hidden;';
  popup.innerHTML=`<div style="height:40px;background:linear-gradient(135deg,var(--icedim),var(--purple));position:relative;">
    <div style="position:absolute;bottom:-16px;left:12px;width:40px;height:40px;border-radius:50%;border:3px solid var(--bg2);overflow:hidden;background:${avColor(username)};display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.9rem;">
      ${avatar?`<img src="${esc(avatar)}" style="width:100%;height:100%;object-fit:cover;"/>`:`<span>${ini(username)}</span>`}
    </div>
  </div>
  <div style="padding:22px 12px 10px;">
    <div style="font-weight:700;font-size:.9rem;">${esc(username)}</div>
    <div style="height:8px;"></div>
    ${!isMe?`<button onclick="openDMWith('${userId}','${esc(username)}','${esc(avatar)}');document.getElementById('user-popup')?.remove();" style="width:100%;text-align:left;padding:5px 6px;border-radius:5px;border:none;background:none;color:var(--text);cursor:pointer;font-size:.8rem;">ğŸ’¬ Mensaje directo</button>
    ${!isFriend?`<button onclick="sendFriendReq('${userId}');document.getElementById('user-popup')?.remove();" style="width:100%;text-align:left;padding:5px 6px;border-radius:5px;border:none;background:none;color:var(--text);cursor:pointer;font-size:.8rem;">â• Agregar amigo</button>`:''}`:``}
  </div>`;
  document.body.appendChild(popup);
  const rect=e.target.getBoundingClientRect();
  const top=Math.min(rect.bottom+4,window.innerHeight-180);
  const left=Math.min(rect.left,window.innerWidth-210);
  popup.style.top=top+'px';popup.style.left=left+'px';
  setTimeout(()=>document.addEventListener('click',()=>popup.remove(),{once:true}),100);
}
function openLightbox(src){$('lightbox-img').src=src;$('lightbox').classList.add('open');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DM & FRIENDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadFriends(){
  const r=await apiFetch('/api/friends');
  if(!r.ok)return;
  friendsList=r.friends||[];
  friendRequests=r.requests||[];
  updateFriendBadge();
}
function updateFriendBadge(){
  const n=friendRequests.length;
  const badge=$('friend-req-badge');
  if(badge){badge.textContent=n;badge.style.display=n>0?'block':'none';}
  const rb=$('req-badge');
  if(rb){rb.textContent=n;rb.style.display=n>0?'inline':'none';}
}
function openDMPanel(){
  currentChannel=null;
  $('v-welcome').style.display='none';
  $('v-chat').style.display='none';
  document.getElementById('watch-view').classList.remove('on');
  $('dm-view').classList.remove('on');
  $('v-dm-panel').style.display='flex';
  $('v-dm-panel').style.flexDirection='column';
  // deselect server
  document.querySelectorAll('.srv-btn').forEach(b=>b.classList.remove('active'));
  $('dm-btn').classList.add('active');
  showDMTab('chats');
  closeDrawer();
}
let dmTab='chats';
async function showDMTab(tab){
  dmTab=tab;
  document.querySelectorAll('.dm-tab').forEach(b=>b.classList.remove('active'));
  $(`dmt-${tab}`)?.classList.add('active');
  const body=$('dm-panel-body');body.innerHTML='';
  if(tab==='chats'){
    // Search bar + recent conversations
    body.innerHTML=`<div style="padding:8px 8px 4px;">
      <input class="dm-panel-search" id="user-search" placeholder="Buscar usuario..." autocomplete="off" autocorrect="off"/>
      <div id="search-results"></div>
    </div><div id="recent-dms"></div>`;
    $('user-search').addEventListener('input',debounce(doUserSearch,300));
    loadRecentDMs();
  } else if(tab==='friends'){
    body.innerHTML='<div id="friends-list" style="padding:6px 0;"></div>';
    renderFriendsList();
  } else if(tab==='requests'){
    body.innerHTML='<div id="req-list" style="padding:6px 0;"></div>';
    renderRequestsList();
  }
}
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}
async function doUserSearch(){
  const q=$('user-search')?.value.trim();
  const res=$('search-results');if(!res)return;
  if(!q||q.length<2){res.innerHTML='';return;}
  const r=await apiFetch(`/api/users/search?q=${encodeURIComponent(q)}`);
  if(!r.ok)return;
  res.innerHTML=r.users.map(u=>`<div class="dm-list-item" onclick="openDMWith('${u._id}','${esc(u.username)}','${esc(u.avatar||'')}')">
    ${makeAvEl(u.username,u.avatar,'av-sm')}
    <div><div class="dm-name">${esc(u.username)}</div>
    <div class="dm-preview">${u.status||'offline'}</div></div>
  </div>`).join('');
}
async function loadRecentDMs(){
  const r=await apiFetch('/api/dms');
  const box=$('recent-dms');if(!box)return;
  if(!r.ok||!r.dms.length){box.innerHTML='<div style="padding:10px 12px;font-size:.78rem;color:var(--muted);">Sin conversaciones recientes</div>';return;}
  // Los DMs solo tienen los IDs de participantes, necesitamos names â€” los guardamos al abrir DM
  box.innerHTML=`<div class="ch-sec">Recientes</div>`+r.dms.map(dm=>{
    const otherId=dm.participants.find(p=>String(p)!==String(myUser?.id));
    return `<div class="dm-list-item" onclick="openDMById('${otherId}')">
      <div class="av-sm" style="background:${avColor('')}">${ini('')}</div>
      <div><div class="dm-name">${otherId}</div><div class="dm-preview">DM</div></div>
    </div>`;
  }).join('');
}
function renderFriendsList(){
  const box=$('friends-list');if(!box)return;
  if(!friendsList.length){box.innerHTML='<div style="padding:10px 12px;font-size:.78rem;color:var(--muted);">Sin amigos aÃºn.</div>';return;}
  box.innerHTML=friendsList.map(f=>`<div class="friend-item">
    ${makeAvEl(f.username,f.avatar,'av-sm')}
    <div class="fi-info"><div class="fi-name">${esc(f.username)}</div><div class="fi-status ${f.status==='online'?'s-online':''}">${f.status||'offline'}</div></div>
    <div class="fi-btns">
      <button class="fi-btn" onclick="openDMWith('${f._id}','${esc(f.username)}','${esc(f.avatar||'')}')">ğŸ’¬</button>
    </div>
  </div>`).join('');
}
function renderRequestsList(){
  const box=$('req-list');if(!box)return;
  box.innerHTML=`<div style="padding:8px 10px;">
    <div class="ch-sec" style="padding:0 0 4px;">Enviar solicitud</div>
    <div style="display:flex;gap:6px;padding:0 0 10px;">
      <input class="dm-panel-search" id="req-search" placeholder="Usuario exacto..." autocomplete="off" autocorrect="off" style="flex:1;"/>
      <button class="btn-ok" onclick="sendFriendReqByName()" style="white-space:nowrap;padding:5px 10px;">Agregar</button>
    </div>
  </div>
  <div class="ch-sec">Solicitudes recibidas</div>
  ${friendRequests.length?friendRequests.map(req=>`<div class="friend-item">
    ${makeAvEl(req.username,req.avatar,'av-sm')}
    <div class="fi-info"><div class="fi-name">${esc(req.username)}</div><div class="fi-status">quiere ser tu amigo</div></div>
    <div class="fi-btns">
      <button class="fi-btn ok" onclick="acceptFriend('${req.from}')">âœ“</button>
      <button class="fi-btn no" onclick="declineFriend('${req.from}')">âœ•</button>
    </div>
  </div>`).join(''):'<div style="padding:6px 12px;font-size:.78rem;color:var(--muted);">Sin solicitudes.</div>'}`;
}
async function sendFriendReqByName(){
  const name=$('req-search')?.value.trim();
  if(!name)return;
  const r=await apiFetch(`/api/users/search?q=${encodeURIComponent(name)}`);
  const user=r.users?.find(u=>u.username.toLowerCase()===name.toLowerCase());
  if(!user){alert('Usuario no encontrado.');return;}
  sendFriendReq(user._id);
}
async function sendFriendReq(userId){
  const r=await apiFetch(`/api/friends/request/${userId}`,'POST');
  if(r.ok) alert(r.accepted?'Â¡Ya son amigos!':'Solicitud enviada.');
  else alert(r.error||'Error');
}
async function acceptFriend(fromId){
  await apiFetch(`/api/friends/accept/${fromId}`,'POST');
  await loadFriends();
  showDMTab('requests');
}
async function declineFriend(fromId){
  await apiFetch(`/api/friends/decline/${fromId}`,'POST');
  await loadFriends();
  showDMTab('requests');
}
async function openDMWith(userId, username, avatar){
  dmWithId=userId; dmWithUser={id:userId,username,avatar};
  $('dm-with-name').textContent=username;
  const avEl=$('dm-with-av');
  avEl.innerHTML=avatar?`<img src="${esc(avatar)}" alt=""/>`:ini(username);
  avEl.style.background=avColor(username);
  socket.emit('join-dm',{withUserId:userId});
  const r=await apiFetch(`/api/dm/${userId}/messages`);
  const box=$('dm-messages');box.innerHTML='';
  if(r.ok)r.messages.forEach(m=>appendMsg(m,box));
  box.scrollTop=box.scrollHeight;
  showView('dm');
}
async function openDMById(userId){
  const r=await apiFetch(`/api/users/search?q=${userId}`);
  // Fallback â€” abrir DM con solo ID
  await openDMWith(userId,userId,'');
}
function closeDMConv(){showView('dm-panel');}
function sendDM(){
  const el=$('dm-inp');
  const content=el.value.trim();
  if(!content&&!pendingFiles.length||!dmWithId)return;
  socket.emit('send-dm',{toUserId:dmWithId,content,attachments:[]});
  el.value='';
}
socket.on('dm-message',({message,participants})=>{
  if(!dmWithId)return;
  if(!participants.some(p=>String(p)===String(dmWithId)||String(p)===String(myUser?.id)))return;
  const box=$('dm-messages');appendMsg(message,box);box.scrollTop=box.scrollHeight;
  if(String(message.author)!==String(myUser?.id))sndMsg();
});
socket.on('friend-request',req=>{
  friendRequests.push(req);updateFriendBadge();sndMention();
});
socket.on('friend-added',({userId,username,avatar})=>{
  if(!friendsList.find(f=>String(f._id||f)===String(userId)))
    friendsList.push({_id:userId,username,avatar,status:'online'});
  updateFriendBadge();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MEMBER PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleMemberPanel(){
  memberPanelOpen=!memberPanelOpen;
  $('member-panel').classList.toggle('open',memberPanelOpen);
  if(memberPanelOpen)renderMemberPanel();
}
function renderMemberPanel(){
  if(!currentServer)return;
  const members=currentServer.members||[];
  const onlineIds=new Set(Object.values({}).map(c=>c.userId));
  // Usar datos del socket si estÃ¡n disponibles
  const online=members.filter(m=>{const u=m.user;return u&&(u.status==='online'||onlineIds.has(String(u._id||u)));});
  const offline=members.filter(m=>{const u=m.user;return u&&!online.includes(m);});
  const roleLabel={owner:'ğŸ‘‘ DueÃ±o',admin:'ğŸ›¡ Admin',member:'Miembro'};
  const renderUser=m=>{
    const u=m.user; if(!u||!u.username)return '';
    const st=u.status||'offline';
    return `<div class="mp-user" onclick="showUserCtx(event,'${esc(u.username)}','${esc(u.avatar||'')}','${u._id||''}')">
      <div class="mp-av" style="background:${avColor(u.username)}">
        ${u.avatar?`<img src="${esc(u.avatar)}" alt=""/>`:`<span>${ini(u.username)}</span>`}
        <div class="mp-sdot s-${st}" style="background:${st==='online'?'var(--green)':st==='away'?'var(--gold)':st==='dnd'?'var(--red)':'var(--muted)'}"></div>
      </div>
      <div class="mp-info">
        <div class="mp-name">${esc(u.username)}</div>
        <div class="mp-role">${roleLabel[m.role]||'Miembro'}</div>
      </div>
    </div>`;
  };
  $('mp-body').innerHTML=`
    <div class="mp-sec">Online â€” ${online.length}</div>
    ${online.map(renderUser).join('')}
    ${offline.length?`<div class="mp-sec" style="margin-top:8px;">Offline â€” ${offline.length}</div>${offline.map(renderUser).join('')}`:''}`;
  $('mp-head-title').textContent=`ğŸ‘¥ Miembros (${members.length})`;
}
socket.on('online-members',members=>{
  // Actualizar estados en member panel si estÃ¡ abierto
  if(memberPanelOpen&&currentServer){
    members.forEach(m=>{
      const srv_m=currentServer.members.find(sm=>(sm.user._id||sm.user)===m.userId);
      if(srv_m&&srv_m.user)srv_m.user.status='online';
    });
    // Los que no estÃ¡n en online â†’ offline
    currentServer.members.forEach(sm=>{
      if(sm.user&&!members.find(m=>m.userId===(sm.user._id||sm.user)))
        sm.user.status='offline';
    });
    renderMemberPanel();
  }
});
socket.on('user-status',({userId,status})=>{
  if(memberPanelOpen&&currentServer){
    const m=currentServer.members.find(sm=>(sm.user?._id||sm.user)===userId||(sm.user?._id||sm.user)===String(userId));
    if(m&&m.user)m.user.status=status;
    renderMemberPanel();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WATCH PARTY â€” Twitch layout
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openWatchModal(){if(!_chId())return;openModal('watch-modal');setTimeout(()=>$('wp-url-input')?.focus(),200);}
function startWP(){
  const url=$('wp-url-input').value.trim();
  if(!url)return;
  socket.emit('watch-start',{channelId:String(_chId()),url,type:'youtube'});
  closeModal('watch-modal');
  $('wp-url-input').value='';
}

socket.on('watch-state',({channelId,active,type,videoId,url,title,playing,currentTime,lastSync})=>{
  const myCh=chIdStr();
  if(channelId&&myCh&&String(channelId)!==myCh)return;
  if(!active){if(wpActive)leaveWPLocal();return;}
  const isNew=!wpActive||wpVid!==videoId||wpType!==type;
  wpActive=true;wpVid=videoId;wpType=type;wpPlaying=playing;
  const elapsed=playing?(Date.now()-lastSync)/1000:0;
  const syncTime=Math.max(0,(currentTime||0)+elapsed);
  $('wp-title-bar').textContent=title||'Watch Party';
  updateWpBtns();
  $('wp-open-btn').classList.add('live');$('wp-open-btn').textContent='ğŸ”´ LIVE';
  $('mob-wp-btn').textContent='ğŸ”´';
  if(isNew){
    if(type==='iframe')createIframeWP(url);
    else createYtWP(videoId,syncTime,playing);
  } else if(type!=='iframe'){
    applyWpCmd(playing?'sync-play':'sync-pause',syncTime);
  }
  showView('watch');
  // Sync chat history into WP chat
  const msgs=$('messages');
  const wpMsgs=$('wp-messages');
  if(wpMsgs&&msgs)wpMsgs.innerHTML=msgs.innerHTML;
});

socket.on('watch-cmd',({channelId,action,currentTime})=>{
  if(channelId&&chIdStr()&&String(channelId)!==chIdStr())return;
  if(wpType==='iframe')return;
  wpPlaying=(action==='play'||action==='sync-play');
  updateWpBtns();
  applyWpCmd(action,currentTime);
});

function createYtWP(videoId,startTime,shouldPlay){
  wpVid=videoId;wpReady=false;wpPendingPlay=shouldPlay;wpPendingTime=startTime||0;wpIgnore=true;
  if(wpPlayer){try{wpPlayer.destroy();}catch{}wpPlayer=null;}
  wpIframe=null;
  const wrap=$('wp-video');wrap.innerHTML='';
  const isMob=window.innerWidth<=768;
  if(isMob){
    const fr=document.createElement('iframe');
    fr.style.cssText='position:absolute;inset:0;width:100%;height:100%;border:none;';
    fr.setAttribute('allowfullscreen','');
    fr.setAttribute('allow','autoplay;fullscreen;encrypted-media;picture-in-picture');
    fr.src=`https://www.youtube.com/embed/${videoId}?autoplay=1&controls=1&playsinline=1&start=${Math.floor(startTime||0)}&rel=0&enablejsapi=1&origin=${encodeURIComponent(location.origin)}`;
    wrap.style.position='relative';
    wrap.appendChild(fr);
    wpIframe=fr;wpReady=true;wpIgnore=false;wpPlaying=shouldPlay;updateWpBtns();
    return;
  }
  const div=document.createElement('div');div.id='wpyt';
  div.style.cssText='position:absolute;inset:0;width:100%;height:100%;';
  wrap.style.position='relative';
  wrap.appendChild(div);
  if(!ytReady){setTimeout(()=>createYtWP(videoId,startTime,shouldPlay),500);return;}
  wpPlayer=new YT.Player('wpyt',{width:'100%',height:'100%',videoId,
    playerVars:{autoplay:1,controls:1,rel:0,playsinline:1,fs:1,start:Math.floor(startTime||0),origin:location.origin},
    events:{
      onReady(e){wpReady=true;wpIgnore=false;if(wpPendingTime>1)e.target.seekTo(wpPendingTime,true);if(wpPendingPlay)e.target.playVideo();wpPendingPlay=false;},
      onStateChange(e){
        if(wpIgnore)return;
        if(e.data===YT.PlayerState.PAUSED&&wpPlaying){wpPlaying=false;updateWpBtns();socket.emit('watch-pause',{channelId:chIdStr(),currentTime:wpTime()});}
        if(e.data===YT.PlayerState.PLAYING&&!wpPlaying){wpPlaying=true;updateWpBtns();socket.emit('watch-play',{channelId:chIdStr(),currentTime:wpTime()});}
      }
    }
  });
}
function createIframeWP(url){
  wpReady=true;wpIframe=null;if(wpPlayer){try{wpPlayer.destroy();}catch{}wpPlayer=null;}
  const wrap=$('wp-video');wrap.innerHTML='';wrap.style.position='relative';
  wrap.innerHTML=`<iframe src="${esc(url)}" style="position:absolute;inset:0;width:100%;height:100%;border:none;" allowfullscreen allow="fullscreen;autoplay;encrypted-media" sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-presentation"></iframe>`;
}
function iframeCmd(fn,args=[]){
  if(!wpIframe)return;
  try{wpIframe.contentWindow.postMessage(JSON.stringify({event:'command',func:fn,args}),'*');}catch{}
}
function applyWpCmd(action,currentTime){
  const isPlay=action==='play'||action==='sync-play';
  wpPlaying=isPlay;updateWpBtns();
  if(wpIframe){
    iframeCmd('seekTo',[(currentTime||0)+(isPlay?.4:0),true]);
    setTimeout(()=>iframeCmd(isPlay?'playVideo':'pauseVideo'),200);
    return;
  }
  if(!wpPlayer||!wpReady){wpPendingTime=currentTime||0;wpPendingPlay=isPlay;return;}
  wpIgnore=true;
  if(isPlay){try{wpPlayer.seekTo((currentTime||0)+.3,true);wpPlayer.playVideo();}catch{}}
  else{try{wpPlayer.pauseVideo();wpPlayer.seekTo(currentTime||0,true);}catch{}}
  setTimeout(()=>wpIgnore=false,600);
}
function wpTime(){try{return wpPlayer&&wpReady?wpPlayer.getCurrentTime():0;}catch{return 0;}}
function updateWpBtns(){const t=wpPlaying?'â¸ Pausar':'â–¶ Play';$('wp-play-btn').textContent=t;}
function wpTogglePlay(){
  if(wpType==='iframe')return;
  const t=wpTime();
  if(wpPlaying)socket.emit('watch-pause',{channelId:chIdStr(),currentTime:t});
  else         socket.emit('watch-play', {channelId:chIdStr(),currentTime:t});
}
function requestSync(){socket.emit('watch-sync-request',{channelId:chIdStr()});}
function leaveWatchParty(){socket.emit('watch-stop',{channelId:chIdStr()});leaveWPLocal();}
function leaveWPLocal(){
  wpActive=false;wpVid=null;wpPlaying=false;wpType='youtube';wpIframe=null;
  if(wpPlayer){try{wpPlayer.destroy();}catch{}wpPlayer=null;wpReady=false;}
  $('wp-video').innerHTML='';
  $('wp-open-btn').classList.remove('live');$('wp-open-btn').textContent='ğŸ¬ Watch Party';
  $('mob-wp-btn').textContent='ğŸ¬';
  currentChannel?showView('chat'):showView('welcome');
}
function wpFullscreen(){
  const el=$('wp-video');
  const rq=el.requestFullscreen||el.webkitRequestFullscreen||el.mozRequestFullScreen||el.msRequestFullscreen;
  if(rq)rq.call(el);
}
// BotÃ³n FS nativo tambiÃ©n en el toolbar
document.addEventListener('fullscreenchange',()=>{
  // Si salimos de fullscreen, nada que hacer especial
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MUSIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onYouTubeIframeAPIReady(){
  ytReady=true;
  ytPlayer=new YT.Player('yt-hidden',{height:'1',width:'1',playerVars:{playsinline:1},events:{onReady:()=>ytPlayer.setVolume(80),onStateChange:()=>{}}});
}
function getBgAudio(){if(!bgAudio){bgAudio=document.createElement('audio');bgAudio.setAttribute('playsinline','');bgAudio.loop=true;bgAudio.volume=.001;document.body.appendChild(bgAudio);}return bgAudio;}
function loadSong(song){
  currentSongId=song.videoId;
  if(ytReady&&ytPlayer){ytPlayer.loadVideoById(song.videoId);ytPlayer.playVideo();}
  if('mediaSession' in navigator){
    navigator.mediaSession.metadata=new MediaMetadata({title:song.title,artist:`Pedida por ${song.requestedBy}`,artwork:[{src:song.thumbnail,sizes:'480x360',type:'image/jpeg'}]});
    navigator.mediaSession.setActionHandler('nexttrack',()=>socket.emit('send-message',{channelId:chIdStr(),content:'/skip',attachments:[]}));
  }
  const a=getBgAudio();
  if(!a.src||a.paused){a.src='data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=';a.play().catch(()=>{});}
}
function stopSong(){if(bgAudio){bgAudio.pause();}currentSongId=null;}
socket.on('music-play',song=>{
  if(String(song.channelId)!==chIdStr())return;
  $('music-bar').classList.add('on');
  $('m-title').textContent=song.title;$('m-req').textContent=`pedida por ${song.requestedBy}`;$('m-thumb').src=song.thumbnail;
  $('m-pause-btn').textContent='â¸';
  loadSong(song);
});
socket.on('music-state',s=>{
  if(String(s.channelId)!==chIdStr())return;
  if(s.current){$('music-bar').classList.add('on');$('m-title').textContent=s.current.title;$('m-req').textContent=`pedida por ${s.current.requestedBy}`;$('m-thumb').src=s.current.thumbnail;if(currentSongId!==s.current.videoId)loadSong(s.current);}
  else $('music-bar').classList.remove('on');
  $('vol-sl').value=s.volume;if(ytPlayer?.setVolume)ytPlayer.setVolume(s.volume);
});
socket.on('music-stop',  d=>{if(String(d?.channelId)!==chIdStr())return;$('music-bar').classList.remove('on');stopSong();});
socket.on('music-ended', d=>{if(String(d?.channelId)!==chIdStr())return;$('music-bar').classList.remove('on');stopSong();});
socket.on('music-pause', d=>{if(String(d?.channelId)!==chIdStr())return;$('m-pause-btn').textContent='â–¶';if(ytPlayer?.pauseVideo)ytPlayer.pauseVideo();});
socket.on('music-resume',d=>{if(String(d?.channelId)!==chIdStr())return;$('m-pause-btn').textContent='â¸';if(ytPlayer?.playVideo)ytPlayer.playVideo();});
socket.on('music-volume',d=>{if(String(d?.channelId)!==chIdStr())return;const v=d.v??d;$('vol-sl').value=v;if(ytPlayer)ytPlayer.setVolume(v);});
function togglePause(){socket.emit('send-message',{channelId:chIdStr(),content:$('m-pause-btn').textContent==='â¸'?'/pause':'/resume',attachments:[]});}
function skipSong(){socket.emit('send-message',{channelId:chIdStr(),content:'/skip',attachments:[]});}
function stopMusic(){socket.emit('send-message',{channelId:chIdStr(),content:'/stop',attachments:[]});}
function setVolume(v){socket.emit('send-message',{channelId:chIdStr(),content:`/volume ${v}`,attachments:[]});}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOICE â€” Hardened WebRTC con keepalive + burbuja Android
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ICE = {
  iceServers: [
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun1.l.google.com:19302' },
    { urls: 'stun:stun2.l.google.com:19302' },
  ],
  iceCandidatePoolSize: 10,
};
let voiceChId = null;
let voiceKeepaliveInterval = null;
let wakeLockObj = null;
let bgAudioCtx = null;
let bgSilentNode = null;

// Mantener audio activo en background con un nodo silencioso
function startBgAudioKeepAlive() {
  try {
    if (!bgAudioCtx) bgAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (bgAudioCtx.state === 'suspended') bgAudioCtx.resume();
    // Nodo oscilador a 0 volumen â€” engaÃ±a al browser para no suspender audio
    if (!bgSilentNode) {
      const osc = bgAudioCtx.createOscillator();
      const gain = bgAudioCtx.createGain();
      gain.gain.value = 0.0001;
      osc.connect(gain);
      gain.connect(bgAudioCtx.destination);
      osc.start();
      bgSilentNode = osc;
    }
  } catch(e) {}
}
function stopBgAudioKeepAlive() {
  try { if(bgSilentNode) { bgSilentNode.stop(); bgSilentNode = null; } } catch(e){}
}

async function acquireWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLockObj = await navigator.wakeLock.request('screen');
      wakeLockObj.addEventListener('release', () => { wakeLockObj = null; });
    }
  } catch(e) {}
}

async function joinVoiceCh(chId) {
  if (inVoice && voiceChId === chId) { leaveVoice(); return; }
  if (inVoice) leaveVoice();
  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        autoGainControl: true,
        sampleRate: 48000,
      },
      video: false
    });
  } catch(e) { alert('Sin acceso al micrÃ³fono: ' + e.message); return; }
  inVoice = true; voiceChId = chId;
  socket.emit('join-voice', { channelId: chId });
  startBgAudioKeepAlive();
  await acquireWakeLock();
  // Keepalive: ping cada 20s para mantener conexiÃ³n activa
  clearInterval(voiceKeepaliveInterval);
  voiceKeepaliveInterval = setInterval(() => {
    if (!inVoice) { clearInterval(voiceKeepaliveInterval); return; }
    socket.emit('voice-ping', { channelId: voiceChId });
    // Revisar peers desconectados y reconectar
    for (const [peerId, pc] of Object.entries(peers)) {
      const state = pc.connectionState || pc.iceConnectionState;
      if (state === 'failed' || state === 'disconnected') {
        console.log('Reconectando peer', peerId, state);
        // ICE restart
        pc.restartIce ? pc.restartIce() : pc.createOffer({iceRestart:true}).then(o => pc.setLocalDescription(o).then(()=>socket.emit('offer',{to:peerId,offer:o}))).catch(()=>{});
      }
    }
  }, 20000);
  showVoiceBubble();
}

socket.on('voice-joined', ({channelId}) => {
  voiceChId = channelId;
  const ch = currentServer?.channels.find(c => String(c._id) === String(channelId));
  $('call-bar').classList.add('on');
  $('call-ch-name').textContent = ch?.name || 'Voz';
  document.querySelectorAll('.v-item').forEach(e => e.classList.remove('active'));
  $('vi-'+channelId)?.classList.add('active');
  sndJoin();
  updateBubble();
});

function leaveVoice() {
  inVoice = false;
  clearInterval(voiceKeepaliveInterval);
  stopBgAudioKeepAlive();
  try { if(wakeLockObj) wakeLockObj.release(); } catch(e){}
  if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
  Object.values(peers).forEach(pc => { try{pc.close();}catch(e){} });
  Object.keys(peers).forEach(k => delete peers[k]);
  document.getElementById('remote-audios')?.remove();
  $('call-bar').classList.remove('on');
  document.querySelectorAll('.v-item').forEach(e => e.classList.remove('active'));
  voiceChId = null;
  socket.emit('leave-voice');
  sndLeave();
  hideVoiceBubble();
}

function toggleMic() {
  if (!localStream) return;
  micMuted = !micMuted;
  localStream.getAudioTracks().forEach(t => t.enabled = !micMuted);
  const b = $('mic-btn'); b.textContent = micMuted ? 'ğŸ”‡' : 'ğŸ¤'; b.classList.toggle('muted', micMuted);
  socket.emit('voice-mute', { muted: micMuted });
  micMuted ? sndMute() : sndUnmute();
  updateBubble();
}

socket.on('voice-users', ({channelId, users}) => {
  const el = $('vu-'+channelId); if(!el) return;
  el.innerHTML = users.map(u => `<div class="v-user"><span>${u.muted?'ğŸ”‡':'ğŸ‘¤'}</span><span>${esc(u.username)}</span></div>`).join('');
  updateBubble(users.length);
});

// WebRTC peer handling
socket.on('existing-peers', async ids => { for (const id of ids) await createPC(id, true); });
socket.on('peer-joined', async ({peerId}) => { sndJoin(); await createPC(peerId, false); });
socket.on('peer-left', id => {
  sndLeave();
  if(peers[id]) { try{peers[id].close();}catch(e){} delete peers[id]; }
  document.getElementById('raud-'+id)?.remove();
  updateBubble();
});
socket.on('offer', async ({from, offer}) => {
  if (!peers[from]) await createPC(from, false);
  try {
    await peers[from].setRemoteDescription(new RTCSessionDescription(offer));
    const a = await peers[from].createAnswer();
    await peers[from].setLocalDescription(a);
    socket.emit('answer', { to: from, answer: a });
  } catch(e) {}
});
socket.on('answer', async ({from, answer}) => {
  if (peers[from]) try { await peers[from].setRemoteDescription(new RTCSessionDescription(answer)); } catch(e) {}
});
socket.on('ice-candidate', async ({from, candidate}) => {
  if (peers[from] && candidate) try { await peers[from].addIceCandidate(new RTCIceCandidate(candidate)); } catch(e) {}
});

async function createPC(peerId, init) {
  const pc = new RTCPeerConnection(ICE);
  peers[peerId] = pc;
  if (localStream) localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  pc.onicecandidate = ({candidate}) => candidate && socket.emit('ice-candidate', { to: peerId, candidate });

  // ReconexiÃ³n automÃ¡tica al detectar fallo
  pc.onconnectionstatechange = () => {
    const state = pc.connectionState;
    if ((state === 'failed' || state === 'disconnected') && inVoice) {
      setTimeout(async () => {
        if (!peers[peerId] || !inVoice) return;
        try {
          const offer = await pc.createOffer({ iceRestart: true });
          await pc.setLocalDescription(offer);
          socket.emit('offer', { to: peerId, offer });
        } catch(e) {}
      }, 2000);
    }
  };

  pc.ontrack = e => {
    if (!document.getElementById('remote-audios')) {
      const c = document.createElement('div');
      c.id = 'remote-audios'; c.style.display = 'none';
      document.body.appendChild(c);
    }
    let a = document.getElementById('raud-'+peerId);
    if (!a) {
      a = document.createElement('audio');
      a.id = 'raud-'+peerId;
      a.autoplay = true;
      a.setAttribute('playsinline', '');
      document.getElementById('remote-audios').appendChild(a);
    }
    a.srcObject = e.streams[0];
    // En iOS/Android hay que llamar play() manualmente
    a.play().catch(() => {});
  };

  if (init) {
    try {
      const o = await pc.createOffer();
      await pc.setLocalDescription(o);
      socket.emit('offer', { to: peerId, offer: o });
    } catch(e) {}
  }
  return pc;
}

// Reanudar audio al volver a primer plano
document.addEventListener('visibilitychange', async () => {
  if (document.visibilityState === 'visible') {
    // Reanudar AudioContext
    if (bgAudioCtx && bgAudioCtx.state === 'suspended') bgAudioCtx.resume();
    // Re-play todos los audios remotos
    document.querySelectorAll('[id^="raud-"]').forEach(a => { a.play().catch(()=>{}); });
    // Re-adquirir wake lock
    if (inVoice && !wakeLockObj) acquireWakeLock();
    // Reanudar mÃºsica YT
    if (currentSongId && ytPlayer?.playVideo) try { ytPlayer.playVideo(); } catch(e) {}
    // Pedir re-sync de peers si llevamos > 5s en background
    if (inVoice) {
      setTimeout(() => {
        for (const [peerId, pc] of Object.entries(peers)) {
          const state = pc.connectionState || pc.iceConnectionState;
          if (state === 'failed' || state === 'disconnected' || state === 'checking') {
            pc.restartIce ? pc.restartIce() : null;
          }
        }
      }, 1000);
    }
  } else {
    // Entrando en background â€” asegurar que el stream sigue activo
    if (inVoice && localStream) {
      localStream.getAudioTracks().forEach(t => {
        if (!t.enabled && !micMuted) t.enabled = true;
      });
    }
  }
});

// â”€â”€ BURBUJA FLOTANTE (overlay en background) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let bubbleVisible = false;
function showVoiceBubble() {
  let b = $('voice-bubble');
  if (!b) {
    b = document.createElement('div');
    b.id = 'voice-bubble';
    b.style.cssText = [
      'position:fixed',
      'bottom:90px',
      'right:16px',
      'width:56px',
      'height:56px',
      'background:var(--bg2)',
      'border:2px solid var(--green)',
      'border-radius:50%',
      'display:flex',
      'flex-direction:column',
      'align-items:center',
      'justify-content:center',
      'z-index:9999',
      'cursor:pointer',
      'box-shadow:0 4px 20px rgba(57,255,192,.4)',
      'transition:all .2s',
      'user-select:none',
    ].join(';');
    b.innerHTML = '<div id="bubble-icon" style="font-size:1.4rem;">ğŸ¤</div><div id="bubble-count" style="font-size:.55rem;color:var(--green);font-family:Space Mono,monospace;"></div>';
    // Tap â†’ expandir mini-panel
    b.addEventListener('click', toggleBubblePanel);
    // Drag support
    let ox=0,oy=0,dragging=false;
    const dragStart = e => { const src=e.touches?e.touches[0]:e; ox=src.clientX-b.offsetLeft; oy=src.clientY-b.offsetTop; dragging=false; };
    const dragMove = e => {
      const src=e.touches?e.touches[0]:e;
      const dx=src.clientX-ox, dy=src.clientY-oy;
      if(Math.abs(dx-b.offsetLeft)+Math.abs(dy-b.offsetTop)>5)dragging=true;
      b.style.left=Math.max(0,Math.min(window.innerWidth-60,src.clientX-ox))+'px';
      b.style.top=Math.max(0,Math.min(window.innerHeight-60,src.clientY-oy))+'px';
      b.style.right='auto'; b.style.bottom='auto';
      e.preventDefault();
    };
    b.addEventListener('mousedown', dragStart);
    b.addEventListener('touchstart', dragStart, {passive:true});
    document.addEventListener('mousemove', dragMove);
    document.addEventListener('touchmove', dragMove, {passive:false});
    document.addEventListener('mouseup', ()=>dragging=false);
    document.addEventListener('touchend', ()=>dragging=false);
    document.body.appendChild(b);
  }
  b.style.display = 'flex';
  bubbleVisible = true;
}
function hideVoiceBubble() {
  const b = $('voice-bubble');
  if (b) b.style.display = 'none';
  const p = $('bubble-panel');
  if (p) p.remove();
  bubbleVisible = false;
}
function updateBubble(userCount) {
  const icon = $('bubble-icon');
  const count = $('bubble-count');
  if (icon) icon.textContent = micMuted ? 'ğŸ”‡' : 'ğŸ¤';
  if (count) count.textContent = userCount != null ? userCount+'p' : '';
  const b = $('voice-bubble');
  if (b) b.style.borderColor = micMuted ? 'var(--red)' : 'var(--green)';
}
function toggleBubblePanel() {
  let p = $('bubble-panel');
  if (p) { p.remove(); return; }
  const b = $('voice-bubble');
  p = document.createElement('div');
  p.id = 'bubble-panel';
  const br = b.getBoundingClientRect();
  p.style.cssText = 'position:fixed;background:var(--bg2);border:1px solid var(--line);border-radius:14px;padding:12px 14px;z-index:9998;display:flex;flex-direction:column;gap:8px;box-shadow:0 8px 28px rgba(0,0,0,.7);min-width:160px;';
  p.style.bottom = (window.innerHeight - br.top + 8) + 'px';
  p.style.right = (window.innerWidth - br.right - br.width/2) + 'px';
  const chName = $('call-ch-name')?.textContent || 'Voz';
  p.innerHTML = `
    <div style="font-size:.72rem;color:var(--green);font-family:'Space Mono',monospace;letter-spacing:1px;">ğŸŸ¢ EN LLAMADA</div>
    <div style="font-size:.82rem;font-weight:700;">${esc(chName)}</div>
    <button onclick="toggleMic();document.getElementById('bubble-panel')?.remove();" style="background:${micMuted?'rgba(255,68,102,.15)':'var(--bg3)'};border:1px solid ${micMuted?'var(--red)':'var(--line)'};border-radius:8px;padding:7px;color:var(--text);cursor:pointer;font-size:.82rem;text-align:left;">
      ${micMuted?'ğŸ”‡ Activar mic':'ğŸ¤ Silenciar'}
    </button>
    <button onclick="leaveVoice();document.getElementById('bubble-panel')?.remove();" style="background:rgba(255,68,102,.1);border:1px solid var(--red);border-radius:8px;padding:7px;color:var(--red);cursor:pointer;font-size:.82rem;text-align:left;">
      ğŸ“µ Colgar
    </button>
  `;
  document.body.appendChild(p);
  // Cerrar al tocar fuera
  setTimeout(() => document.addEventListener('click', function close(e) {
    if (!e.target.closest('#bubble-panel') && !e.target.closest('#voice-bubble')) { p.remove(); document.removeEventListener('click', close); }
  }), 100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS & SERVER SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSettings(){
  openModal('settings-modal');
  $('settings-uname').textContent=myUser?.username;
  $('cs-inp').value=myUser?.customStatus||'';
  $('status-sel').value=myUser?.status||'online';
  updateSettingsAv();
}
function updateSettingsAv(){
  const el=$('settings-av');
  if(myUser?.avatar)el.innerHTML=`<img src="${myUser.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"/>`;
  else{el.textContent=ini(myUser?.username);el.style.background=avColor(myUser?.username);}
}
async function saveSettings(){
  const cs=$('cs-inp').value;const st=$('status-sel').value;
  await apiFetch('/api/update-profile','POST',{customStatus:cs});
  socket.emit('set-status',{status:st});
  myUser.customStatus=cs;myUser.status=st;
  $('my-cs-label').textContent=cs||st;
  closeModal('settings-modal');
}
async function openServerSettings(){
  if(!currentServer)return;
  const isOwner=currentServer.members.find(m=>(m.user._id||m.user)===myUser?.id&&m.role==='owner');
  $('srv-settings-body').innerHTML=`<div style="display:flex;flex-direction:column;gap:10px;">
    <div style="font-weight:700;">${esc(currentServer.name)}</div>
    <div style="font-size:.75rem;color:var(--muted);">${currentServer.members.length} miembros</div>
    <button class="btn-ok" onclick="genInvite()">ğŸ”— Generar invitaciÃ³n</button>
    <div id="inv-link" style="font-size:.75rem;color:var(--green);word-break:break-all;"></div>
    ${isOwner?`<hr style="border-color:var(--line);"/><button class="btn-danger" onclick="if(confirm('Â¿Seguro?'))leaveServer()">Abandonar servidor</button>`:''}
    <button class="btn-cancel" onclick="closeModal('srv-settings')">Cerrar</button>
  </div>`;
  openModal('srv-settings');
}
async function genInvite(){
  const r=await apiFetch(`/api/servers/${currentServer._id}/invite`,'POST',{});
  if(r.ok){$('inv-link').textContent=r.url;navigator.clipboard?.writeText(r.url).catch(()=>{});}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INVITE LANDING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function checkInvite(){
  const m=location.pathname.match(/\/invite\/([a-zA-Z0-9_-]+)/);
  if(!m)return false;
  const code=m[1];
  const r=await fetch(`/api/invite/${code}`).then(x=>x.json());
  $('auth-screen').style.display='none';
  $('invite-screen').style.display='flex';
  if(!r.ok){$('inv-name').textContent='InvitaciÃ³n invÃ¡lida';return true;}
  $('inv-name').textContent=r.server.name;
  $('inv-members').textContent=`${r.server.memberCount} miembros`;
  $('inv-icon').innerHTML=r.server.name.slice(0,2).toUpperCase();
  window._invCode=code;
  return true;
}
async function acceptInvite(){
  const tok=localStorage.getItem('dk_token');
  if(!tok){$('invite-screen').style.display='none';$('auth-screen').style.display='flex';return;}
  const r=await fetch(`/api/invite/${window._invCode}/join`,{method:'POST',headers:{'Authorization':'Bearer '+tok,'Content-Type':'application/json'}}).then(x=>x.json());
  if(!r.ok){$('inv-err').textContent=r.error;$('inv-err').style.display='block';return;}
  const vr=await fetch('/api/verify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:tok})}).then(x=>x.json());
  $('invite-screen').style.display='none';
  enterApp(tok,vr.user);
  setTimeout(()=>selectServer(r.server._id),800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEWS & MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showView(v){
  $('v-welcome').style.display='none';
  $('v-chat').style.display='none';
  $('v-dm-panel').style.display='none';
  document.getElementById('watch-view').classList.remove('on');
  $('dm-view').classList.remove('on');
  if(v==='welcome')$('v-welcome').style.display='flex';
  else if(v==='chat'){$('v-chat').style.display='flex';$('v-chat').style.flexDirection='column';}
  else if(v==='watch'){document.getElementById('watch-view').classList.add('on');}
  else if(v==='dm-panel'){$('v-dm-panel').style.display='flex';$('v-dm-panel').style.flexDirection='column';}
  else if(v==='dm'){$('dm-view').classList.add('on');}
}
function openModal(id){$(id).classList.add('open');}
function closeModal(id){$(id).classList.remove('open');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOBILE DRAWER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleDrawer(){
  const open=!$('ch-bar').classList.contains('open');
  $('ch-bar').classList.toggle('open',open);
  $('srv-bar').classList.toggle('open',open);
  $('mob-overlay').classList.toggle('open',open);
}
function closeDrawer(){
  $('ch-bar').classList.remove('open');
  $('srv-bar').classList.remove('open');
  $('mob-overlay').classList.remove('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WAKE LOCK + SW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function requestWakeLock(){try{if('wakeLock' in navigator)await navigator.wakeLock.request('screen');}catch{}}
document.addEventListener('visibilitychange',()=>{if(document.visibilityState==='visible'){requestWakeLock();if(currentSongId&&ytPlayer?.playVideo)try{ytPlayer.playVideo();}catch{};}});
if('serviceWorker' in navigator)navigator.serviceWorker.register('/sw.js').catch(()=>{});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CREATE SERVER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function createServer(){
  const name=$('new-srv-name').value.trim();
  const desc=$('new-srv-desc').value.trim();
  const err=$('csrv-err');err.classList.remove('show');
  if(!name){err.textContent='Ponle un nombre.';err.classList.add('show');return;}
  const r=await apiFetch('/api/servers/create','POST',{name,description:desc});
  if(!r.ok){err.textContent=r.error;err.classList.add('show');return;}
  closeModal('create-server');
  $('new-srv-name').value='';$('new-srv-desc').value='';
  await loadServers();
  await selectServer(r.server._id);
}
socket.on('channel-created',()=>{if(currentServer)apiFetch(`/api/servers/${currentServer._id}`).then(r=>{if(r.ok){currentServer=r.server;renderChSidebar();}});});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load',async()=>{
  const isInv=await checkInvite();if(isInv)return;
  const tok=localStorage.getItem('dk_token');if(!tok)return;
  const r=await apiFetch('/api/verify','POST',{token:tok});
  if(r.ok)enterApp(tok,r.user);
});

// Input enter listeners (after DOM ready)
document.addEventListener('DOMContentLoaded',()=>{
  setupInputEnter('msg-inp',sendMsg);
  setupInputEnter('wp-msg-inp',sendWpMsg);
  setupInputEnter('dm-inp',sendDM);
  ['l-u','l-p'].forEach(id=>$(id)?.addEventListener('keydown',e=>e.key==='Enter'&&doLogin()));
  ['r-u','r-p'].forEach(id=>$(id)?.addEventListener('keydown',e=>e.key==='Enter'&&doRegister()));
  $('wp-url-input')?.addEventListener('keydown',e=>e.key==='Enter'&&startWP());
  // Click outside â†’ close pickers
  document.addEventListener('click',e=>{
    if(!e.target.closest('.emoji-pk')&&!e.target.closest('.inp-btn')){
      document.querySelectorAll('.emoji-pk').forEach(p=>p.classList.remove('open'));
    }
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURES v4.3 â€” 10 nuevas funciones + partydo adblock
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ ğŸŒ¡ï¸ VIBE METER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentVibe = 0;
socket.on('vibe-update', ({channelId, vibe}) => {
  if(String(channelId) !== chIdStr()) return;
  currentVibe = vibe;
  updateVibeMeter(vibe);
});
function updateVibeMeter(v) {
  const fill = $('vibe-fill');
  if(!fill) return;
  fill.style.width = v + '%';
  const colors = v > 75 ? ['#ff4466','#ff6644'] : v > 50 ? ['#ffd166','#ff9144'] : v > 25 ? ['#39ffc0','#4fc3f7'] : ['#3a6080','#a8d8ff'];
  fill.style.background = `linear-gradient(90deg,${colors[0]},${colors[1]})`;
  const label = $('vibe-label');
  if(label) label.textContent = v > 80 ? 'ğŸ”¥ On Fire' : v > 60 ? 'âš¡ Activo' : v > 40 ? 'ğŸ’¬ Hablando' : v > 20 ? 'ğŸ˜´ Tranquilo' : 'ğŸ’¤ Silencio';
}

// â”€â”€ ğŸ“Œ PINS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentPins = [];
socket.on('pins-update', ({channelId, pins}) => {
  if(String(channelId) !== chIdStr()) return;
  currentPins = pins;
  renderPins(pins);
});
function renderPins(pins) {
  const box = $('pins-dropdown');
  if(!box) return;
  const count = $('pins-count');
  if(count) count.textContent = pins.length ? `(${pins.length})` : '';
  if(!pins.length) { box.innerHTML = '<div style="padding:12px;font-size:.78rem;color:var(--muted);text-align:center;">Sin mensajes fijados</div>'; return; }
  box.innerHTML = pins.map(p => `<div class="pin-item">
    <div class="pin-item-name">ğŸ“Œ ${esc(p.authorName)} <span style="color:var(--muted);font-weight:400;">fijado por ${esc(p.pinnedBy)}</span></div>
    <div class="pin-item-txt">${esc(p.content)}${p.content.length>=120?'â€¦':''}</div>
  </div>`).join('');
}
function togglePinsPanel() {
  const box = $('pins-dropdown');
  if(!box) return;
  const isOpen = box.style.display === 'block';
  box.style.display = isOpen ? 'none' : 'block';
  if(!isOpen) renderPins(currentPins);
}
document.addEventListener('click', e => {
  if(!e.target.closest('#pins-dropdown') && !e.target.closest('[onclick*="togglePinsPanel"]'))
    { const b = $('pins-dropdown'); if(b) b.style.display='none'; }
});

// â”€â”€ ğŸ“Š POLLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
socket.on('poll-update', ({pollId, options}) => {
  const cards = document.querySelectorAll(`[data-pollid="${pollId}"]`);
  cards.forEach(card => updatePollCard(card, pollId, options));
});
function renderPollCard(pollData) {
  const {pollId, question, options} = pollData;
  const opts = options.map((o, i) => `
    <div class="poll-opt ${o.voted?'voted':''}" onclick="castVote('${pollId}',${i})" data-idx="${i}">
      <div class="poll-bar-wrap"><div class="poll-bar" style="width:${o.pct||0}%"></div></div>
      <span class="poll-opt-txt">${esc(o.text)}</span>
      <span class="poll-pct">${o.pct||0}%</span>
    </div>`).join('');
  return `<div class="poll-card" data-pollid="${pollId}">
    <div class="poll-q">ğŸ“Š ${esc(question)}</div>
    ${opts}
    <div style="font-size:.68rem;color:var(--muted);margin-top:5px;">Total: ${options.reduce((s,o)=>s+o.count,0)} votos</div>
  </div>`;
}
function updatePollCard(card, pollId, options) {
  if(!card) return;
  const opts = card.querySelectorAll('.poll-opt');
  const total = options.reduce((s,o)=>s+o.count,0);
  options.forEach((o,i) => {
    if(opts[i]) {
      opts[i].classList.toggle('voted', o.voted);
      const bar = opts[i].querySelector('.poll-bar');
      if(bar) bar.style.width = (o.pct||0) + '%';
      const pct = opts[i].querySelector('.poll-pct');
      if(pct) pct.textContent = (o.pct||0) + '%';
    }
  });
  const tot = card.querySelector('div:last-child');
  if(tot) tot.textContent = `Total: ${total} votos`;
}
function castVote(pollId, optionIdx) {
  socket.emit('poll-vote', {pollId, optionIdx});
}

// â”€â”€ ğŸ² DICE ROLL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
socket.on('dice-roll', ({user, faces, result, channelId}) => {
  if(String(channelId) !== chIdStr()) return;
  // AnimaciÃ³n visual
  showDiceAnim(faces, result);
});
function showDiceAnim(faces, result) {
  let d = $('dice-anim');
  if(!d) {
    d = document.createElement('div');
    d.id = 'dice-anim';
    d.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg2);border:2px solid var(--ice);border-radius:18px;padding:24px 36px;z-index:500;text-align:center;box-shadow:0 16px 48px rgba(0,0,0,.8);pointer-events:none;';
    document.body.appendChild(d);
  }
  let count = 0;
  const max = 12;
  const interval = setInterval(() => {
    const n = count < max - 1 ? Math.floor(Math.random()*faces)+1 : result;
    d.innerHTML = `<div style="font-family:'Bebas Neue',sans-serif;font-size:3rem;color:var(--ice);">ğŸ²</div><div style="font-family:'Bebas Neue',sans-serif;font-size:5rem;color:var(--text);letter-spacing:2px;">${n}</div><div style="font-size:.72rem;color:var(--muted);font-family:'Space Mono',monospace;">d${faces}</div>`;
    count++;
    if(count >= max) { clearInterval(interval); setTimeout(()=>d.remove(), 2000); }
  }, 60);
}

// â”€â”€ ğŸ”” ALARM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
socket.on('alarm-ring', ({label, createdBy}) => {
  const toast = $('alarm-toast');
  const title = $('alarm-title');
  const by = $('alarm-by');
  if(title) title.textContent = label || 'â° Alarma';
  if(by) by.textContent = 'Programada por ' + (createdBy||'');
  if(toast) toast.classList.add('on');
  // Sonido
  beepAlarm();
});
function beepAlarm() {
  for(let i=0;i<3;i++) setTimeout(()=>{beep(880,.2,.3);setTimeout(()=>beep(1100,.25,.3),120);},i*600);
}
function dismissAlarm() {
  const t = $('alarm-toast');
  if(t) t.classList.remove('on');
}

// â”€â”€ ğŸ¯ FOCUS / POMODORO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let focusInterval = null;
socket.on('focus-state', ({channelId, active, endAt, label, startedBy}) => {
  if(String(channelId) !== chIdStr()) return;
  if(active) startFocusTimer(endAt, label, startedBy);
});
socket.on('focus-end', ({channelId, label}) => {
  if(String(channelId) !== chIdStr()) return;
  clearInterval(focusInterval); focusInterval = null;
  const banner = $('focus-banner');
  if(banner) banner.classList.remove('on');
  if(label) showNotif(`ğŸ¯ SesiÃ³n focus "${label}" terminada. Â¡Buen trabajo!`);
  beepAlarm();
});
function startFocusTimer(endAt, label, startedBy) {
  const banner = $('focus-banner');
  const labelEl = $('focus-label-txt');
  const timerEl = $('focus-timer');
  if(!banner) return;
  banner.classList.add('on');
  if(labelEl) labelEl.textContent = `${label||'ğŸ¯ Focus'} Â· iniciado por ${startedBy||''}`;
  clearInterval(focusInterval);
  focusInterval = setInterval(() => {
    const rem = Math.max(0, endAt - Date.now());
    const m = Math.floor(rem/60000); const s = Math.floor((rem%60000)/1000);
    if(timerEl) timerEl.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    if(rem <= 0) { clearInterval(focusInterval); }
  }, 1000);
}

// â”€â”€ ğŸ¨ CANVAS / PIZARRA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let canvasOpen = false;
let drawing = false;
let lastX = 0, lastY = 0;
let brushColor = '#a8d8ff';
let brushSize = 4;
let currentChannelCanvas = null;

socket.on('open-canvas', ({channelId}) => {
  if(String(channelId) !== chIdStr()) return;
  openCanvas(channelId);
});
socket.on('canvas-state', ({channelId, strokes}) => {
  if(String(channelId) !== chIdStr()) return;
  currentChannelCanvas = channelId;
  if(canvasOpen) replayStrokes(strokes);
});
socket.on('canvas-stroke', ({stroke, channelId}) => {
  if(String(channelId) !== chIdStr()) return;
  drawStroke(stroke, false);
});
socket.on('canvas-cleared', ({channelId, by}) => {
  if(String(channelId) !== chIdStr()) return;
  const cv = $('draw-canvas');
  if(cv) cv.getContext('2d').clearRect(0,0,cv.width,cv.height);
  showNotif(`ğŸ¨ ${by} limpiÃ³ la pizarra`);
});
function openCanvas(channelId) {
  currentChannelCanvas = channelId || chIdStr();
  canvasOpen = true;
  const wrap = $('canvas-wrap');
  if(wrap) { wrap.style.display = 'flex'; }
  // Replay existing strokes
  socket.emit('canvas-state-req', {channelId: currentChannelCanvas});
}
function closeCanvas() {
  canvasOpen = false;
  const wrap = $('canvas-wrap');
  if(wrap) wrap.style.display = 'none';
}
function clearCanvas() {
  if(!currentChannelCanvas) return;
  const cv = $('draw-canvas');
  if(cv) cv.getContext('2d').clearRect(0,0,cv.width,cv.height);
  socket.emit('canvas-clear', {channelId: currentChannelCanvas});
}
function replayStrokes(strokes) {
  const cv = $('draw-canvas'); if(!cv) return;
  const ctx = cv.getContext('2d');
  ctx.clearRect(0,0,cv.width,cv.height);
  strokes.forEach(s => drawStroke(s, false));
}
function drawStroke(stroke, emit) {
  const cv = $('draw-canvas'); if(!cv) return;
  const ctx = cv.getContext('2d');
  ctx.beginPath();
  ctx.moveTo(stroke.x0, stroke.y0);
  ctx.lineTo(stroke.x1, stroke.y1);
  ctx.strokeStyle = stroke.color || '#a8d8ff';
  ctx.lineWidth = stroke.size || 4;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  ctx.stroke();
  if(emit && currentChannelCanvas) {
    socket.emit('canvas-stroke', { channelId: currentChannelCanvas, stroke });
  }
}
function setupCanvas() {
  const cv = $('draw-canvas'); if(!cv) return;
  const getPos = e => {
    const r = cv.getBoundingClientRect();
    const src = e.touches ? e.touches[0] : e;
    return { x: (src.clientX-r.left)*(cv.width/r.width), y: (src.clientY-r.top)*(cv.height/r.height) };
  };
  const start = e => { drawing=true; const p=getPos(e); lastX=p.x; lastY=p.y; e.preventDefault(); };
  const move = e => {
    if(!drawing) return; e.preventDefault();
    const p = getPos(e);
    const stroke = { x0:lastX, y0:lastY, x1:p.x, y1:p.y, color:brushColor, size:brushSize };
    drawStroke(stroke, true);
    lastX=p.x; lastY=p.y;
  };
  const end = () => drawing=false;
  cv.addEventListener('mousedown', start);
  cv.addEventListener('mousemove', move);
  cv.addEventListener('mouseup', end);
  cv.addEventListener('touchstart', start, {passive:false});
  cv.addEventListener('touchmove', move, {passive:false});
  cv.addEventListener('touchend', end);
}

// â”€â”€ ğŸŒ PARTYDO â€” Host control UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let partydoMySocketId = null;
let partydoHostId = null;
socket.on('connect', () => { partydoMySocketId = socket.id; });

function createPartydoWP(url, hostSocketId) {
  partydoHostId = hostSocketId;
  const isHost = (socket.id === hostSocketId);
  const wrap = $('wp-video');
  wrap.innerHTML = '';
  wrap.style.position = 'relative';

  const fr = document.createElement('iframe');
  fr.style.cssText = 'position:absolute;inset:0;width:100%;height:100%;border:none;';
  fr.setAttribute('allowfullscreen','');
  fr.setAttribute('allow','autoplay;fullscreen;encrypted-media;picture-in-picture');
  fr.setAttribute('sandbox','allow-scripts allow-same-origin allow-popups allow-forms allow-presentation allow-top-navigation-by-user-activation');
  fr.src = url; // '/partydo-view'
  wrap.appendChild(fr);

  // Toolbar â€” solo el host puede parar, todos ven quiÃ©n es el host
  $('wp-play-btn').style.display = 'none'; // no tiene sentido play/pause en partydo
  $('wp-title-bar').textContent = 'âš½ FÃºtbol en Vivo' + (isHost ? ' Â· ğŸ® Eres el host' : '');

  // BotÃ³n de stop solo para el host
  const stopBtn = document.getElementById('wp-partydo-stop');
  if(!stopBtn) {
    const btn = document.createElement('button');
    btn.id = 'wp-partydo-stop';
    btn.className = 'wp-btn red';
    btn.textContent = 'â¹ Cerrar partido';
    btn.style.display = isHost ? 'block' : 'none';
    btn.onclick = () => {
      socket.emit('partydo-stop', {channelId: chIdStr()});
    };
    $('wp-toolbar').insertBefore(btn, $('wp-toolbar').querySelector('.wp-btn.red'));
  } else {
    stopBtn.style.display = isHost ? 'block' : 'none';
  }

  wpActive = true; wpType = 'partydo';
}

// â”€â”€ ğŸ’¾ SNAPSHOT helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function downloadSnapshot() {
  const chId = _chId();
  if(!chId) return;
  window.open(`/api/channels/${chId}/snapshot`, '_blank');
}

// â”€â”€ ğŸ“¢ NOTIF TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showNotif(text, duration=3500) {
  let n = $('notif-toast');
  if(!n) {
    n = document.createElement('div');
    n.id = 'notif-toast';
    n.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--line);border-radius:10px;padding:10px 18px;z-index:450;font-size:.82rem;color:var(--text);box-shadow:0 4px 20px rgba(0,0,0,.5);transition:opacity .3s;white-space:nowrap;max-width:90vw;overflow:hidden;text-overflow:ellipsis;';
    document.body.appendChild(n);
  }
  n.textContent = text;
  n.style.opacity = '1';
  clearTimeout(n._to);
  n._to = setTimeout(() => { n.style.opacity='0'; }, duration);
}

// â”€â”€ HOOK watch-state para partydo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Extender el watch-state listener original para manejar type='partydo'
const _origWatchState = socket._events && socket._events['watch-state'];
socket.on('watch-state', ({channelId, active, type, url, title, playing, currentTime, lastSync, partydoHost}) => {
  const myCh = chIdStr();
  if(channelId && myCh && String(channelId) !== myCh) return;
  if(!active) return; // leaveWPLocal handled by existing listener
  if(type === 'partydo') {
    $('wp-title-bar').textContent = title || 'âš½ FÃºtbol en Vivo';
    $('wp-open-btn').classList.add('live'); $('wp-open-btn').textContent = 'ğŸ”´ LIVE';
    $('mob-wp-btn').textContent = 'ğŸ”´';
    createPartydoWP(url || '/partydo-view', partydoHost);
    showView('watch');
    // Copy chat
    const msgs=$('messages'); const wpMsgs=$('wp-messages');
    if(wpMsgs && msgs) wpMsgs.innerHTML = msgs.innerHTML;
  }
});

// â”€â”€ CONTEXT MENU â€” pin support â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ctxMsgId = null;
let ctxChannelId = null;
function ctxAction(action) {
  const menu = $('ctx-menu');
  if(menu) menu.style.display = 'none';
  if(!ctxMsgId) return;
  if(action === 'reply') startReply(ctxMsgId, ctxMsgContent);
  else if(action === 'react') showRxnFor(ctxMsgId, ctxChannelId);
  else if(action === 'pin') { socket.emit('pin-message', {messageId:ctxMsgId, channelId:ctxChannelId}); showNotif('ğŸ“Œ Mensaje fijado'); }
  else if(action === 'edit') editMsg(ctxMsgId);
  else if(action === 'delete') deleteMsg(ctxMsgId);
}
let ctxMsgContent = '';
function openCtxMenu(e, msgId, channelId, isMe, content) {
  e.preventDefault();
  ctxMsgId = msgId; ctxChannelId = channelId; ctxMsgContent = content;
  const menu = $('ctx-menu');
  if(!menu) return;
  $('ctx-edit').style.display = isMe ? 'block' : 'none';
  $('ctx-delete').style.display = (isMe || isServerAdmin()) ? 'block' : 'none';
  menu.style.display = 'block';
  const top = Math.min(e.clientY, window.innerHeight-160);
  const left = Math.min(e.clientX, window.innerWidth-160);
  menu.style.top = top + 'px';
  menu.style.left = left + 'px';
}
document.addEventListener('click', e => {
  if(!e.target.closest('#ctx-menu')) { const m=$('ctx-menu'); if(m) m.style.display='none'; }
});

// â”€â”€ PATCH appendMsg to add ctx menu + poll render â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _origAppendMsg = window.appendMsg || function(){};
// Override appendMsg to add context menu and poll rendering
const appendMsgOriginal = appendMsg;
window.appendMsg = function(msg, box) {
  // Call original
  appendMsgOriginal(msg, box);
  // Add context menu to last added element
  const last = box.lastElementChild;
  if(last && msg._id && !msg.pollData) {
    const isMe = String(msg.author) === String(myUser?.id);
    last.addEventListener('contextmenu', e => openCtxMenu(e, msg._id, String(msg.channelId||_chId()||''), isMe, msg.content||''));
    last.addEventListener('touchstart', function(e) {
      const t = setTimeout(() => openCtxMenu(e.touches[0], msg._id, String(msg.channelId||_chId()||''), isMe, msg.content||''), 500);
      last.addEventListener('touchend', () => clearTimeout(t), {once:true});
      last.addEventListener('touchmove', () => clearTimeout(t), {once:true});
    });
  }
  // Poll rendering
  if(msg.pollData && last) {
    const pollDiv = document.createElement('div');
    pollDiv.innerHTML = renderPollCard(msg.pollData);
    last.querySelector('.msg-body')?.appendChild(pollDiv.firstElementChild);
  }
};

// â”€â”€ INIT new features â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  setupCanvas();

  // Add vibe bar to chat view if not present
  const chatView = $('v-chat');
  if(chatView && !$('vibe-bar')) {
    const vbar = document.createElement('div');
    vbar.innerHTML = `<div id="vibe-bar" style="height:3px;background:var(--bg3);flex-shrink:0;overflow:hidden;">
      <div id="vibe-fill" style="height:100%;width:0%;background:linear-gradient(90deg,var(--icedim),var(--ice));transition:width .5s ease;border-radius:0 2px 2px 0;"></div>
    </div>
    <div id="focus-banner" style="background:linear-gradient(90deg,rgba(192,132,252,.15),rgba(96,165,250,.1));border-bottom:1px solid rgba(192,132,252,.3);padding:5px 12px;display:none;align-items:center;gap:10px;flex-shrink:0;">
      <div id="focus-timer" style="font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:2px;color:var(--purple);min-width:48px;">25:00</div>
      <div id="focus-label-txt" style="flex:1;font-size:.78rem;color:var(--muted);">ğŸ¯ Focus en curso</div>
      <button onclick="socket.emit('focus-stop',{channelId:chIdStr()})" style="background:none;border:1px solid var(--line);border-radius:5px;color:var(--muted);cursor:pointer;padding:2px 8px;font-size:.72rem;">âœ•</button>
    </div>`;
    const msgs = $('messages');
    if(msgs) chatView.insertBefore(vbar, msgs);
  }

  // Add pins button to topbar if not there
  const topbarRight = document.querySelector('.topbar-right');
  if(topbarRight && !$('pins-dropdown')) {
    const pinsWrap = document.createElement('div');
    pinsWrap.style.position = 'relative';
    pinsWrap.innerHTML = `<button class="tb-btn" onclick="togglePinsPanel()">ğŸ“Œ <span id="pins-count"></span></button>
      <div id="pins-dropdown" style="position:absolute;top:100%;right:0;width:280px;background:var(--bg2);border:1px solid var(--line);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.5);z-index:40;display:none;max-height:300px;overflow-y:auto;">
        <div style="padding:12px;font-size:.78rem;color:var(--muted);text-align:center;">Sin mensajes fijados</div>
      </div>`;
    topbarRight.insertBefore(pinsWrap, topbarRight.firstChild);
  }

  // Add snapshot button
  const cmdHint = document.querySelector('.cmd-hint');
  if(cmdHint) cmdHint.textContent = '/play /watch /partydo /roll /poll /alarm /focus /translate /draw /snapshot /help';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MINIJUEGOS v4.4
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openGamesMenu(){
  if(!_chId()){showNotif('Ãšnete a un canal primero.');return;}
  openModal('games-modal');
}
function closeGameOverlay(id){
  const el=$(id);if(el)el.classList.remove('on');
  // Stop any running game loops
  if(id==='game-snake'){clearInterval(snakeLoop);snakeLoop=null;}
  if(id==='game-typerace'){clearInterval(traceInterval);traceInterval=null;}
}

// â”€â”€ ğŸ SNAKE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let snakeLoop=null;
const SN={running:false,W:20,H:20,cell:16,snake:[],dir:{x:1,y:0},next:{x:1,y:0},food:{x:5,y:5},score:0,lives:3};

function initSnake(){
  $('game-snake').classList.add('on');
  startSnake();
}
function startSnake(){
  clearInterval(snakeLoop);snakeLoop=null;
  const mid=10;
  SN.snake=[{x:mid,y:mid},{x:mid-1,y:mid},{x:mid-2,y:mid}];
  SN.dir={x:1,y:0};SN.next={x:1,y:0};SN.score=0;SN.lives=3;SN.running=true;
  snakeFood();
  updateSnakeHUD();
  snakeLoop=setInterval(snakeTick,120);
  socket.emit('send-message',{channelId:chIdStr(),content:`ğŸ **${myUser?.username||'?'}** iniciÃ³ Snake. Â¡A jugar!`,attachments:[]});
}
function snakeFood(){SN.food={x:Math.floor(Math.random()*SN.W),y:Math.floor(Math.random()*SN.H)};}
function snakeDir(dx,dy){if(dx&&!SN.dir.x)SN.next={x:dx,y:0};if(dy&&!SN.dir.y)SN.next={x:0,y:dy};}
function updateSnakeHUD(){$('snake-score').textContent=`Score: ${SN.score}`;$('snake-lives').textContent=`Vidas: ${'â¤ï¸'.repeat(SN.lives)}`;}
function snakeTick(){
  if(!SN.running)return;
  SN.dir=SN.next;
  const h={x:SN.snake[0].x+SN.dir.x,y:SN.snake[0].y+SN.dir.y};
  const hit=h.x<0||h.x>=SN.W||h.y<0||h.y>=SN.H||SN.snake.some(s=>s.x===h.x&&s.y===h.y);
  if(hit){
    SN.lives--;updateSnakeHUD();
    if(SN.lives<=0){
      SN.running=false;clearInterval(snakeLoop);snakeLoop=null;
      socket.emit('send-message',{channelId:chIdStr(),content:`ğŸ’€ **Game Over!** Score final: **${SN.score}**`,attachments:[]});
      showNotif(`ğŸ’€ Game Over! Score: ${SN.score}`);
      snakeDraw();return;
    }
    // Reset snake position keeping score
    const mid=10;
    SN.snake=[{x:mid,y:mid},{x:mid-1,y:mid},{x:mid-2,y:mid}];
    SN.dir={x:1,y:0};SN.next={x:1,y:0};
    return;
  }
  SN.snake.unshift(h);
  if(h.x===SN.food.x&&h.y===SN.food.y){
    SN.score+=10;snakeFood();updateSnakeHUD();
    if(SN.score%50===0){socket.emit('send-message',{channelId:chIdStr(),content:`ğŸ”¥ Score: **${SN.score}** â€” Â¡Sigue asÃ­!`,attachments:[]});}
  }else SN.snake.pop();
  snakeDraw();
}
function snakeDraw(){
  const cv=$('snake-canvas');if(!cv)return;
  const ctx=cv.getContext('2d');
  const cw=cv.width/SN.W,ch=cv.height/SN.H;
  ctx.fillStyle='#0a0a10';ctx.fillRect(0,0,cv.width,cv.height);
  // Grid dots
  ctx.fillStyle='rgba(255,255,255,.04)';
  for(let x=0;x<SN.W;x++)for(let y=0;y<SN.H;y++)ctx.fillRect(x*cw+cw/2-1,y*ch+ch/2-1,2,2);
  // Food
  ctx.fillStyle='#ff4466';ctx.shadowColor='#ff4466';ctx.shadowBlur=8;
  ctx.beginPath();ctx.arc(SN.food.x*cw+cw/2,SN.food.y*ch+ch/2,cw/2-2,0,Math.PI*2);ctx.fill();
  ctx.shadowBlur=0;
  // Snake
  SN.snake.forEach((s,i)=>{
    const p=i/SN.snake.length;
    ctx.fillStyle=i===0?'#39ffc0':`hsl(${150+p*60},${80-p*20}%,${50-p*15}%)`;
    const pad=i===0?0:1;
    if(i===0){
      ctx.shadowColor='#39ffc0';ctx.shadowBlur=6;
      ctx.fillRect(s.x*cw+pad,s.y*ch+pad,cw-pad*2,ch-pad*2);
      ctx.shadowBlur=0;
    }else{ctx.fillRect(s.x*cw+pad,s.y*ch+pad,cw-pad*2,ch-pad*2);}
  });
}
document.addEventListener('keydown',e=>{
  if(!$('game-snake')?.classList.contains('on'))return;
  const d={ArrowUp:{x:0,y:-1},ArrowDown:{x:0,y:1},ArrowLeft:{x:-1,y:0},ArrowRight:{x:1,y:0},w:{x:0,y:-1},s:{x:0,y:1},a:{x:-1,y:0},d:{x:1,y:0}};
  const dir=d[e.key];if(dir){e.preventDefault();snakeDir(dir.x,dir.y);}
});

// â”€â”€ ğŸ§  TRIVIA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TRIVIA=[
  {cat:'ğŸ’» Tech',q:'Â¿CuÃ¡ntos bytes en un kilobyte?',opts:['512','1024','2048','256'],a:1},
  {cat:'ğŸ’» Tech',q:'Â¿QuÃ© significa CPU?',opts:['Central Processing Unit','Computer Power Unit','Core Processing Unit','Central Power Unit'],a:0},
  {cat:'ğŸŒ General',q:'Â¿Capital de Australia?',opts:['Sydney','Melbourne','Brisbane','Canberra'],a:3},
  {cat:'ğŸ¬ Cine',q:'Â¿Director de Inception?',opts:['Spielberg','Nolan','Tarantino','Fincher'],a:1},
  {cat:'ğŸ”¢ Mates',q:'Â¿RaÃ­z cuadrada de 144?',opts:['11','12','13','14'],a:1},
  {cat:'ğŸ’» Tech',q:'Â¿HTML significa?',opts:['HyperText Markup Language','High Transfer Markup Language','HyperText Modular Language','High Text Markup Language'],a:0},
  {cat:'ğŸŒ General',q:'Â¿PaÃ­s mÃ¡s grande del mundo?',opts:['China','CanadÃ¡','EE.UU.','Rusia'],a:3},
  {cat:'ğŸ”¢ Mates',q:'Â¿CuÃ¡ntos lados tiene un hexÃ¡gono?',opts:['5','6','7','8'],a:1},
  {cat:'ğŸµ MÃºsica',q:'Â¿CuÃ¡ntas cuerdas tiene una guitarra estÃ¡ndar?',opts:['4','5','6','7'],a:2},
  {cat:'ğŸŒ General',q:'Â¿En quÃ© aÃ±o llegÃ³ el hombre a la Luna?',opts:['1965','1967','1969','1971'],a:2},
  {cat:'ğŸ’» Tech',q:'Â¿QuÃ© lenguaje usa Node.js?',opts:['Python','Java','JavaScript','Ruby'],a:2},
  {cat:'ğŸ¬ Cine',q:'Â¿CuÃ¡ntas partes tiene el SeÃ±or de los Anillos (cine)?',opts:['2','3','4','5'],a:1},
  {cat:'ğŸ”¢ Mates',q:'Â¿Valor de Pi redondeado a 2 decimales?',opts:['3.12','3.14','3.16','3.18'],a:1},
  {cat:'ğŸŒ General',q:'Â¿CuÃ¡ntos paÃ­ses hay en Ãfrica?',opts:['45','54','63','72'],a:1},
  {cat:'ğŸ’» Tech',q:'Â¿QuÃ© significa CSS?',opts:['Cascading Style Sheets','Computer Style System','Creative Style Sheets','Core Style System'],a:0},
];
let triviaIdx=0,triviaScores={},triviaAnswered=false;
function initTrivia(){
  triviaIdx=Math.floor(Math.random()*TRIVIA.length);
  triviaScores={};triviaAnswered=false;
  $('game-trivia').classList.add('on');
  loadTriviaQ();
  socket.emit('send-message',{channelId:chIdStr(),content:`ğŸ§  **${myUser?.username||'?'}** iniciÃ³ Trivia. Â¡El que mÃ¡s acierte gana!`,attachments:[]});
}
function loadTriviaQ(){
  triviaAnswered=false;
  const q=TRIVIA[triviaIdx%TRIVIA.length];
  $('trivia-cat').textContent=q.cat;
  $('trivia-q').textContent=q.q;
  $('trivia-status').textContent='';
  $('trivia-opts').innerHTML=q.opts.map((o,i)=>`<button class="trivia-opt" onclick="answerTrivia(${i})">${o}</button>`).join('');
  updateTriviaScores();
}
function answerTrivia(idx){
  if(triviaAnswered)return;
  triviaAnswered=true;
  const q=TRIVIA[triviaIdx%TRIVIA.length];
  const opts=$('trivia-opts').querySelectorAll('.trivia-opt');
  const correct=idx===q.a;
  opts[idx].classList.add(correct?'correct':'wrong');
  opts[q.a].classList.add('revealed');
  if(correct){
    const name=myUser?.username||'?';
    triviaScores[name]=(triviaScores[name]||0)+1;
    $('trivia-status').textContent=`âœ… Â¡Correcto! +1 punto para ${name}`;
    beep(880,.1,.15);beep(1100,.15,.15);
    socket.emit('send-message',{channelId:chIdStr(),content:`ğŸ§  **${name}** respondiÃ³ **correctamente**: ${q.opts[q.a]}`,attachments:[]});
  }else{
    $('trivia-status').textContent=`âŒ Incorrecto. Era: ${q.opts[q.a]}`;
    beep(300,.2,.12,'sawtooth');
  }
  updateTriviaScores();
}
function nextTriviaQ(){
  triviaIdx=(triviaIdx+1)%TRIVIA.length;
  loadTriviaQ();
}
function updateTriviaScores(){
  const entries=Object.entries(triviaScores).sort((a,b)=>b[1]-a[1]);
  $('trivia-scores').innerHTML=entries.length?entries.map(([n,s])=>`<span>ğŸ† ${esc(n)}: ${s}</span>`).join(''):`<span style="color:var(--muted);">Sin puntos aÃºn</span>`;
}

// â”€â”€ ğŸ“ WORDLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WORDS=['CANAL','JUEGO','MUNDO','CIELO','FUEGO','PLAYA','MONTE','VERDE','NEGRO','BLANCO','DISCO','CLIMA','RADIO','MUSICA','LIBRO','CARTA','PLAZA','CAMPO','TORRE','PLATO','FONDO','BRISA','NOCHE','TARDE','ARENA','NIEVE','LLAMA','RUMBA','SALSA','RITMO'].filter(w=>w.length===5);
let wdState={word:'',guesses:[],current:'',row:0,done:false};
function initWordle(){
  $('game-wordle').classList.add('on');
  newWordleGame();
}
function newWordleGame(){
  wdState.word=WORDS[Math.floor(Math.random()*WORDS.length)];
  wdState.guesses=[];wdState.current='';wdState.row=0;wdState.done=false;
  buildWordleGrid();buildWordleKb();
  $('wordle-status').innerHTML=`<span style="color:var(--muted);">Adivina la palabra de 5 letras (6 intentos)</span>`;
  socket.emit('send-message',{channelId:chIdStr(),content:`ğŸ“ **${myUser?.username||'?'}** iniciÃ³ Wordle. Â¡Adivinen la palabra de 5 letras!`,attachments:[]});
}
function buildWordleGrid(){
  const grid=$('wordle-grid');if(!grid)return;
  grid.innerHTML='';
  for(let r=0;r<6;r++){
    const row=document.createElement('div');row.className='wordle-row';row.id=`wr-${r}`;
    for(let c=0;c<5;c++){const cell=document.createElement('div');cell.className='wordle-cell';cell.id=`wc-${r}-${c}`;row.appendChild(cell);}
    grid.appendChild(row);
  }
}
function buildWordleKb(){
  const kb=$('wordle-kb');if(!kb)return;
  const rows=['QWERTYUIOP','ASDFGHJKL','ZXCVBNM'];
  kb.innerHTML=rows.map(r=>`<div class="wordle-kb-row">${[...r].map(k=>`<button class="wordle-key" id="wk-${k}" onclick="wordleKey('${k}')">${k}</button>`).join('')}</div>`).join('');
  kb.innerHTML+=`<div class="wordle-kb-row"><button class="wordle-key" onclick="wordleSubmit()" style="min-width:52px;">â†µ</button><button class="wordle-key" onclick="wordleBackspace()" style="min-width:40px;">âŒ«</button></div>`;
}
function wordleKey(k){
  if(wdState.done||wdState.current.length>=5)return;
  wdState.current+=k;
  updateWordleRow();
}
function wordleBackspace(){if(wdState.done)return;wdState.current=wdState.current.slice(0,-1);updateWordleRow();}
function updateWordleRow(){
  const r=wdState.row;
  for(let c=0;c<5;c++){
    const cell=$(`wc-${r}-${c}`);if(!cell)return;
    cell.textContent=wdState.current[c]||'';
    cell.className='wordle-cell'+(c===wdState.current.length-1?' active':'');
  }
}
function wordleSubmit(){
  if(wdState.done||wdState.current.length<5)return;
  const guess=wdState.current;
  const word=wdState.word;
  const result=[];
  const used=Array(5).fill(false);
  // Correct
  for(let i=0;i<5;i++){if(guess[i]===word[i]){result[i]='correct';used[i]=true;}}
  // Present / Absent
  for(let i=0;i<5;i++){
    if(result[i])continue;
    const idx=word.split('').findIndex((c,j)=>c===guess[i]&&!used[j]);
    if(idx>=0){result[i]='present';used[idx]=true;}else result[i]='absent';
  }
  // Update grid
  const r=wdState.row;
  for(let c=0;c<5;c++){
    const cell=$(`wc-${r}-${c}`);if(!cell)continue;
    cell.textContent=guess[c];
    setTimeout(()=>cell.className=`wordle-cell ${result[c]}`,c*80);
    // Update keyboard
    setTimeout(()=>{
      const key=$(`wk-${guess[c]}`);
      if(!key)return;
      const cur=key.className;
      if(!cur.includes('correct')&&(result[c]==='correct'||(result[c]==='present'&&!cur.includes('present'))||(result[c]==='absent'&&!cur.includes('present')&&!cur.includes('correct'))))
        key.className=`wordle-key ${result[c]}`;
    },c*80+200);
  }
  wdState.guesses.push({guess,result});wdState.current='';wdState.row++;
  const won=result.every(r=>r==='correct');
  setTimeout(()=>{
    if(won){
      wdState.done=true;
      $('wordle-status').innerHTML=`<span style="color:var(--green);">ğŸ‰ Â¡Correcto! Era <strong>${word}</strong> Â· ${wdState.row}/6</span>`;
      socket.emit('send-message',{channelId:chIdStr(),content:`ğŸ“ Â¡**${myUser?.username}** adivinÃ³ el Wordle en ${wdState.row}/6! La palabra era **${word}** ğŸ‰`,attachments:[]});
      beep(880,.1,.2);beep(1100,.1,.2);setTimeout(()=>beep(1320,.2,.2),150);
    }else if(wdState.row>=6){
      wdState.done=true;
      $('wordle-status').innerHTML=`<span style="color:var(--red);">âŒ Era <strong>${word}</strong>. Â¡Intenta de nuevo!</span>`;
      socket.emit('send-message',{channelId:chIdStr(),content:`ğŸ“ Wordle fallido. La palabra era **${word}** ğŸ˜¢`,attachments:[]});
    }else{
      $('wordle-status').innerHTML=`<span style="color:var(--muted);">Intento ${wdState.row}/6</span>`;
    }
  },400);
}
document.addEventListener('keydown',e=>{
  if(!$('game-wordle')?.classList.contains('on'))return;
  if(e.key==='Enter')wordleSubmit();
  else if(e.key==='Backspace')wordleBackspace();
  else if(/^[a-zA-ZÃ±Ã‘]$/.test(e.key))wordleKey(e.key.toUpperCase());
});

// â”€â”€ âŒ¨ï¸ TYPE RACE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const RACE_TEXTS=[
  'El tiempo vuela cuando uno se divierte con sus amigos.',
  'La tecnologÃ­a avanza mÃ¡s rÃ¡pido de lo que podemos imaginar.',
  'Aprender a programar es una de las mejores inversiones.',
  'El cÃ³digo limpio es un regalo para los futuros desarrolladores.',
  'La prÃ¡ctica constante es la clave del dominio de cualquier habilidad.',
  'No existe el cÃ³digo perfecto, solo el cÃ³digo que funciona bien.',
  'Cada bug resuelto es una victoria personal del programador.',
  'Los mejores proyectos nacen de la colaboraciÃ³n entre personas.',
];
let traceInterval=null,traceStart=0,traceIdx=0,traceDone=false;
let traceScores={};
function initTypeRace(){
  $('game-typerace').classList.add('on');
  startTypeRace();
}
function startTypeRace(){
  clearInterval(traceInterval);traceInterval=null;
  traceDone=false;traceScores={};
  const text=RACE_TEXTS[Math.floor(Math.random()*RACE_TEXTS.length)];
  const el=$('typerace-text');
  el.innerHTML=[...text].map((c,i)=>`<span class="typerace-char" data-idx="${i}">${c==' '?'&nbsp;':esc(c)}</span>`).join('');
  const inp=$('typerace-input');inp.value='';inp.focus();
  traceIdx=0;traceStart=0;
  $('typerace-wpm').textContent='';
  updateTraceScores();
  socket.emit('send-message',{channelId:chIdStr(),content:`âŒ¨ï¸ **${myUser?.username||'?'}** iniciÃ³ Type Race. Â¡A escribir!`,attachments:[]});
  inp.oninput=e=>{
    const val=inp.value;
    const chars=$('typerace-text').querySelectorAll('.typerace-char');
    const text=[...chars].map(c=>c.textContent).join('').replace(/Â /g,' ');
    if(traceStart===0&&val.length>0)traceStart=Date.now();
    [...chars].forEach((c,i)=>{
      if(i<val.length)c.className='typerace-char '+(val[i]===text[i]?'correct':'wrong');
      else c.className='typerace-char'+(i===val.length?' cursor':'');
    });
    if(val.length===text.length){
      traceDone=true;
      const elapsed=(Date.now()-traceStart)/60000;
      const words=text.split(' ').length;
      const wpm=Math.round(words/elapsed);
      const name=myUser?.username||'?';
      traceScores[name]={wpm,time:((Date.now()-traceStart)/1000).toFixed(1)};
      $('typerace-wpm').textContent=`âœ… Completado â€” ${wpm} WPM`;
      updateTraceScores();
      beep(880,.1,.2);beep(1100,.15,.2);
      socket.emit('send-message',{channelId:chIdStr(),content:`âŒ¨ï¸ **${name}** terminÃ³ en **${wpm} WPM** (${traceScores[name].time}s) ğŸ`,attachments:[]});
    }else if(traceStart>0&&!traceDone){
      const elapsed=(Date.now()-traceStart)/60000||.001;
      const approxWords=val.split(' ').length;
      $('typerace-wpm').textContent=`${Math.round(approxWords/elapsed)} WPM en vivo`;
    }
  };
}
function updateTraceScores(){
  const entries=Object.entries(traceScores).sort((a,b)=>b[1].wpm-a[1].wpm);
  $('typerace-scores').innerHTML=entries.length
    ?entries.map(([n,d])=>`<span>âŒ¨ï¸ ${esc(n)}: ${d.wpm} WPM</span>`).join('')
    :`<span style="color:var(--muted);">Esperando jugadores...</span>`;
}

// â”€â”€ Games socket events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Cuando alguien manda un mensaje con resultado de juego, ya queda en el chat
// No necesitamos eventos extra â€” el chat es el canal de resultados



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANDROID NATIVE BRIDGE â€” burbuja flotante nativa
// Solo activo cuando corre dentro del APK de Diskold
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const IS_NATIVE = typeof AndroidBridge !== 'undefined';

// Parchear joinVoiceCh para avisar al bridge nativo
const _origJoinVoiceCh = joinVoiceCh;
async function joinVoiceCh(chId) {
  await _origJoinVoiceCh(chId);
  // Avisar al bridge nativo cuando se une exitosamente
  if (IS_NATIVE && inVoice) {
    const ch = currentServer?.channels.find(c => String(c._id) === String(chId));
    const name = ch?.name || 'Voz';
    try { AndroidBridge.startVoiceBubble(name, micMuted); } catch(e) {}
  }
}

// Parchear leaveVoice para detener la burbuja nativa
const _origLeaveVoice = leaveVoice;
function leaveVoice() {
  _origLeaveVoice();
  if (IS_NATIVE) {
    try { AndroidBridge.stopVoiceBubble(); } catch(e) {}
  }
}

// Parchear toggleMic para actualizar el Ã­cono de la burbuja nativa
const _origToggleMic = toggleMic;
function toggleMic() {
  _origToggleMic();
  if (IS_NATIVE) {
    try { AndroidBridge.updateMicState(micMuted); } catch(e) {}
  }
}

// Pedir permiso overlay si no lo tiene
if (IS_NATIVE && !AndroidBridge.hasOverlayPermission()) {
  setTimeout(() => {
    if (confirm('Para mostrar la burbuja de llamada sobre otras apps, Diskold necesita un permiso especial. Â¿Conceder?')) {
      AndroidBridge.requestOverlayPermission();
    }
  }, 3000);
}

// FunciÃ³n llamada desde MainActivity.onResume()
function onAppResume() {
  if (inVoice && localStream) {
    localStream.getAudioTracks().forEach(t => { if (!t.enabled && !micMuted) t.enabled = true; });
    document.querySelectorAll('[id^="raud-"]').forEach(a => a.play().catch(() => {}));
  }
}

</script>
<script src="https://www.youtube.com/iframe_api"></script>

<!-- â•â•â• CANVAS / PIZARRA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="canvas-wrap" style="position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:1000;gap:10px;padding:12px;">
  <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:center;background:var(--bg2);border:1px solid var(--line);border-radius:10px;padding:8px 12px;">
    <span style="font-size:.78rem;color:var(--muted);">Color:</span>
    <input type="color" value="#a8d8ff" oninput="brushColor=this.value" style="width:28px;height:28px;border:none;border-radius:4px;cursor:pointer;background:none;"/>
    <span style="font-size:.78rem;color:var(--muted);">TamaÃ±o:</span>
    <input type="range" min="1" max="30" value="4" oninput="brushSize=+this.value" style="width:70px;accent-color:var(--ice);"/>
    <button onclick="brushColor='#1a1a22';brushSize=30;" style="background:var(--bg3);border:1px solid var(--line);border-radius:5px;color:var(--muted);cursor:pointer;padding:3px 8px;font-size:.75rem;">Borrar</button>
    <button onclick="clearCanvas()" style="background:rgba(255,68,102,.1);border:1px solid var(--red);border-radius:5px;color:var(--red);cursor:pointer;padding:3px 8px;font-size:.75rem;">ğŸ—‘ Limpiar</button>
    <button onclick="closeCanvas()" style="background:var(--bg3);border:1px solid var(--line);border-radius:5px;color:var(--muted);cursor:pointer;padding:3px 8px;font-size:.75rem;">âœ• Cerrar</button>
  </div>
  <canvas id="draw-canvas" width="900" height="500" style="background:#1a1a22;border-radius:8px;cursor:crosshair;max-width:100%;touch-action:none;border:1px solid var(--line);"></canvas>
  <div style="font-size:.65rem;color:var(--muted);font-family:'Space Mono',monospace;">Pizarra colaborativa Â· Todos los que estÃ¡n en este canal pueden dibujar</div>
</div>

<!-- â•â•â• ALARM TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="alarm-toast" style="position:fixed;top:20px;right:20px;background:var(--bg2);border:2px solid var(--gold);border-radius:14px;padding:16px 20px;z-index:400;display:none;flex-direction:column;align-items:center;gap:5px;box-shadow:0 8px 32px rgba(0,0,0,.6);min-width:200px;text-align:center;">
  <div style="font-size:2rem;">â°</div>
  <div id="alarm-title" style="font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:3px;color:var(--gold);">ALARMA</div>
  <div id="alarm-by" style="font-size:.72rem;color:var(--muted);"></div>
  <button onclick="dismissAlarm()" style="margin-top:6px;padding:6px 20px;background:var(--ice);border:none;border-radius:8px;color:#0a0a0c;cursor:pointer;font-weight:700;font-size:.82rem;">OK</button>
</div>

<!-- â•â•â• CTX MENU â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="ctx-menu" style="position:fixed;background:var(--bg2);border:1px solid var(--line);border-radius:10px;z-index:200;display:none;min-width:160px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.6);">
  <div onclick="ctxAction('reply')" style="padding:9px 14px;cursor:pointer;font-size:.82rem;transition:background .15s;" onmouseover="this.style.background='var(--bg3)'" onmouseout="this.style.background=''">â†© Responder</div>
  <div onclick="ctxAction('react')" style="padding:9px 14px;cursor:pointer;font-size:.82rem;transition:background .15s;" onmouseover="this.style.background='var(--bg3)'" onmouseout="this.style.background=''">ğŸ˜Š Reaccionar</div>
  <div onclick="ctxAction('pin')" style="padding:9px 14px;cursor:pointer;font-size:.82rem;transition:background .15s;" onmouseover="this.style.background='var(--bg3)'" onmouseout="this.style.background=''">ğŸ“Œ Fijar</div>
  <div id="ctx-edit" onclick="ctxAction('edit')" style="padding:9px 14px;cursor:pointer;font-size:.82rem;transition:background .15s;display:none;" onmouseover="this.style.background='var(--bg3)'" onmouseout="this.style.background=''">âœï¸ Editar</div>
  <div id="ctx-delete" onclick="ctxAction('delete')" style="padding:9px 14px;cursor:pointer;font-size:.82rem;color:var(--red);transition:background .15s;display:none;" onmouseover="this.style.background='rgba(255,68,102,.1)'" onmouseout="this.style.background=''">ğŸ—‘ Eliminar</div>
</div>

<!-- â•â•â• GAMES MENU â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="games-modal" onclick="if(event.target===this)closeModal('games-modal')">
  <div class="modal">
    <div class="modal-title" style="color:var(--green);">ğŸ® MINIJUEGOS</div>
    <div style="font-size:.75rem;color:var(--muted);margin-top:-4px;">Juega con todos en el canal en tiempo real.</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:4px;">
      <button class="game-btn" onclick="closeModal('games-modal');initSnake();" style="display:flex;flex-direction:column;align-items:flex-start;gap:2px;padding:12px;">
        <span style="font-size:1.3rem;">ğŸ</span><span style="font-weight:700;">Snake</span><span style="font-size:.65rem;color:var(--muted);">Cooperativo</span>
      </button>
      <button class="game-btn" onclick="closeModal('games-modal');initTrivia();" style="display:flex;flex-direction:column;align-items:flex-start;gap:2px;padding:12px;">
        <span style="font-size:1.3rem;">ğŸ§ </span><span style="font-weight:700;">Trivia</span><span style="font-size:.65rem;color:var(--muted);">vs. todos</span>
      </button>
      <button class="game-btn" onclick="closeModal('games-modal');initWordle();" style="display:flex;flex-direction:column;align-items:flex-start;gap:2px;padding:12px;">
        <span style="font-size:1.3rem;">ğŸ“</span><span style="font-weight:700;">Wordle</span><span style="font-size:.65rem;color:var(--muted);">Cooperativo</span>
      </button>
      <button class="game-btn" onclick="closeModal('games-modal');initTypeRace();" style="display:flex;flex-direction:column;align-items:flex-start;gap:2px;padding:12px;">
        <span style="font-size:1.3rem;">âŒ¨ï¸</span><span style="font-weight:700;">Type Race</span><span style="font-size:.65rem;color:var(--muted);">vs. todos</span>
      </button>
    </div>
  </div>
</div>

<!-- SNAKE -->
<div class="game-overlay" id="game-snake">
  <div class="game-title">ğŸ SNAKE COOPERATIVO</div>
  <div class="game-score-bar"><span id="snake-score">Score: 0</span><span id="snake-lives">Vidas: 3</span></div>
  <canvas id="snake-canvas" width="320" height="320"></canvas>
  <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center;">
    <div style="display:grid;grid-template-columns:repeat(3,40px);grid-template-rows:repeat(3,40px);gap:3px;">
      <div></div><button class="game-btn" style="padding:0;width:40px;height:40px;" onclick="snakeDir(0,-1)">â–²</button><div></div>
      <button class="game-btn" style="padding:0;width:40px;height:40px;" onclick="snakeDir(-1,0)">â—„</button><div></div><button class="game-btn" style="padding:0;width:40px;height:40px;" onclick="snakeDir(1,0)">â–º</button>
      <div></div><button class="game-btn" style="padding:0;width:40px;height:40px;" onclick="snakeDir(0,1)">â–¼</button><div></div>
    </div>
    <div style="display:flex;flex-direction:column;gap:7px;">
      <button class="game-btn prim" onclick="startSnake()">â–¶ Nueva partida</button>
      <button class="game-btn" onclick="closeGameOverlay('game-snake')">âœ• Salir</button>
    </div>
  </div>
  <div style="font-size:.65rem;color:var(--muted);font-family:'Space Mono',monospace;">WASD o flechas para mover Â· Come la ğŸ”´ para crecer</div>
</div>

<!-- TRIVIA -->
<div class="game-overlay" id="game-trivia">
  <div class="game-title">ğŸ§  TRIVIA ONLINE</div>
  <div class="game-score-bar" id="trivia-scores"></div>
  <div class="game-box" style="max-width:500px;">
    <div id="trivia-cat" style="font-size:.65rem;color:var(--muted);font-family:'Space Mono',monospace;letter-spacing:1px;"></div>
    <div class="trivia-q" id="trivia-q">Cargando pregunta...</div>
    <div class="trivia-opts" id="trivia-opts"></div>
    <div style="font-size:.72rem;color:var(--muted);font-family:'Space Mono',monospace;min-height:18px;" id="trivia-status"></div>
  </div>
  <div style="display:flex;gap:8px;">
    <button class="game-btn prim" onclick="nextTriviaQ()">â–¶ Siguiente</button>
    <button class="game-btn" onclick="closeGameOverlay('game-trivia')">âœ• Salir</button>
  </div>
</div>

<!-- WORDLE -->
<div class="game-overlay" id="game-wordle">
  <div class="game-title">ğŸ“ WORDLE COOPERATIVO</div>
  <div class="game-score-bar" id="wordle-status"></div>
  <div class="wordle-grid" id="wordle-grid"></div>
  <div class="wordle-kb" id="wordle-kb"></div>
  <div style="display:flex;gap:8px;margin-top:4px;">
    <button class="game-btn prim" onclick="newWordleGame()">ğŸ”„ Nueva palabra</button>
    <button class="game-btn" onclick="closeGameOverlay('game-wordle')">âœ• Salir</button>
  </div>
  <div style="font-size:.65rem;color:var(--muted);font-family:'Space Mono',monospace;">ğŸŸ© Correcta Â· ğŸŸ¨ Presente Â· â¬› Ausente</div>
</div>

<!-- TYPE RACE -->
<div class="game-overlay" id="game-typerace">
  <div class="game-title">âŒ¨ï¸ TYPE RACE</div>
  <div class="game-score-bar" id="typerace-scores"></div>
  <div class="game-box" style="max-width:520px;width:100%;">
    <div class="typerace-text" id="typerace-text"></div>
    <input id="typerace-input" style="background:var(--bg3);border:1px solid var(--line);border-radius:7px;padding:9px 12px;font-family:'Space Mono',monospace;font-size:.88rem;color:var(--text);outline:none;width:100%;margin-top:4px;" placeholder="Empieza a escribir..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
    <div style="font-size:.72rem;color:var(--muted);font-family:'Space Mono',monospace;min-height:18px;" id="typerace-wpm"></div>
  </div>
  <div style="display:flex;gap:8px;">
    <button class="game-btn prim" onclick="startTypeRace()">â–¶ Nueva carrera</button>
    <button class="game-btn" onclick="closeGameOverlay('game-typerace')">âœ• Salir</button>
  </div>
</div>
</body>
</html>
